<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Extended Function Example | Code Development in Model Infrastructure</title>
  <meta name="description" content="A general discussion of the current coding practices followed by the Model Infrastructure Team." />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Extended Function Example | Code Development in Model Infrastructure" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A general discussion of the current coding practices followed by the Model Infrastructure Team." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Extended Function Example | Code Development in Model Infrastructure" />
  
  <meta name="twitter:description" content="A general discussion of the current coding practices followed by the Model Infrastructure Team." />
  

<meta name="author" content="Leigh Alexander and Shannon T. Holloway" />


<meta name="date" content="2025-04-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Functions.html"/>
<link rel="next" href="unit-testing.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="Functions.html"><a href="Functions.html"><i class="fa fa-check"></i><b>1</b> Elements of a Function</a>
<ul>
<li class="chapter" data-level="1.1" data-path="Functions.html"><a href="Functions.html#function-structure"><i class="fa fa-check"></i><b>1.1</b> Function Structure</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="Functions.html"><a href="Functions.html#usage-definition"><i class="fa fa-check"></i><b>1.1.1</b> Usage definition</a></li>
<li class="chapter" data-level="1.1.2" data-path="Functions.html"><a href="Functions.html#input-testing"><i class="fa fa-check"></i><b>1.1.2</b> Input Testing</a></li>
<li class="chapter" data-level="1.1.3" data-path="Functions.html"><a href="Functions.html#input-processing"><i class="fa fa-check"></i><b>1.1.3</b> Input Processing</a></li>
<li class="chapter" data-level="1.1.4" data-path="Functions.html"><a href="Functions.html#task-implementation"><i class="fa fa-check"></i><b>1.1.4</b> Task Implementation</a></li>
<li class="chapter" data-level="1.1.5" data-path="Functions.html"><a href="Functions.html#result-construction-and-testing"><i class="fa fa-check"></i><b>1.1.5</b> Result Construction and Testing</a></li>
<li class="chapter" data-level="1.1.6" data-path="Functions.html"><a href="Functions.html#concluding-remarks"><i class="fa fa-check"></i><b>1.1.6</b> Concluding Remarks</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="extended-function-example.html"><a href="extended-function-example.html"><i class="fa fa-check"></i><b>2</b> Extended Function Example</a>
<ul>
<li class="chapter" data-level="2.1" data-path="extended-function-example.html"><a href="extended-function-example.html#procedure-specification"><i class="fa fa-check"></i><b>2.1</b> Procedure Specification</a></li>
<li class="chapter" data-level="2.2" data-path="extended-function-example.html"><a href="extended-function-example.html#select-a-design"><i class="fa fa-check"></i><b>2.2</b> Select a Design</a></li>
<li class="chapter" data-level="2.3" data-path="extended-function-example.html"><a href="extended-function-example.html#s3-based-design-structure"><i class="fa fa-check"></i><b>2.3</b> S3 Based Design Structure</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="extended-function-example.html"><a href="extended-function-example.html#usage-specification"><i class="fa fa-check"></i><b>2.3.1</b> Usage Specification</a></li>
<li class="chapter" data-level="2.3.2" data-path="extended-function-example.html"><a href="extended-function-example.html#input-testing-1"><i class="fa fa-check"></i><b>2.3.2</b> Input Testing</a></li>
<li class="chapter" data-level="2.3.3" data-path="extended-function-example.html"><a href="extended-function-example.html#input-processing-1"><i class="fa fa-check"></i><b>2.3.3</b> Input Processing</a></li>
<li class="chapter" data-level="2.3.4" data-path="extended-function-example.html"><a href="extended-function-example.html#task-implementation-1"><i class="fa fa-check"></i><b>2.3.4</b> Task Implementation</a></li>
<li class="chapter" data-level="2.3.5" data-path="extended-function-example.html"><a href="extended-function-example.html#results-construction-and-testing"><i class="fa fa-check"></i><b>2.3.5</b> Results Construction and Testing</a></li>
<li class="chapter" data-level="2.3.6" data-path="extended-function-example.html"><a href="extended-function-example.html#extensions"><i class="fa fa-check"></i><b>2.3.6</b> Extensions</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="extended-function-example.html"><a href="extended-function-example.html#framework-and-utility-function-design-structure"><i class="fa fa-check"></i><b>2.4</b> Framework and Utility Function Design Structure</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="extended-function-example.html"><a href="extended-function-example.html#usage-specification-1"><i class="fa fa-check"></i><b>2.4.1</b> Usage Specification</a></li>
<li class="chapter" data-level="2.4.2" data-path="extended-function-example.html"><a href="extended-function-example.html#input-testing-2"><i class="fa fa-check"></i><b>2.4.2</b> Input Testing</a></li>
<li class="chapter" data-level="2.4.3" data-path="extended-function-example.html"><a href="extended-function-example.html#input-processing-2"><i class="fa fa-check"></i><b>2.4.3</b> Input Processing</a></li>
<li class="chapter" data-level="2.4.4" data-path="extended-function-example.html"><a href="extended-function-example.html#task-implementation-2"><i class="fa fa-check"></i><b>2.4.4</b> Task Implementation</a></li>
<li class="chapter" data-level="2.4.5" data-path="extended-function-example.html"><a href="extended-function-example.html#results-construction-and-testing-1"><i class="fa fa-check"></i><b>2.4.5</b> Results Construction and Testing</a></li>
<li class="chapter" data-level="2.4.6" data-path="extended-function-example.html"><a href="extended-function-example.html#extensions-1"><i class="fa fa-check"></i><b>2.4.6</b> Extensions</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="extended-function-example.html"><a href="extended-function-example.html#key-design-differences"><i class="fa fa-check"></i><b>2.5</b> Key Design Differences</a></li>
<li class="chapter" data-level="2.6" data-path="extended-function-example.html"><a href="extended-function-example.html#blended-design"><i class="fa fa-check"></i><b>2.6</b> Blended Design</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="unit-testing.html"><a href="unit-testing.html"><i class="fa fa-check"></i><b>3</b> Unit Testing</a>
<ul>
<li class="chapter" data-level="3.1" data-path="unit-testing.html"><a href="unit-testing.html#general-comments-1"><i class="fa fa-check"></i><b>3.1</b> General Comments</a></li>
<li class="chapter" data-level="3.2" data-path="unit-testing.html"><a href="unit-testing.html#unit-tests-for-chapter-2-example"><i class="fa fa-check"></i><b>3.2</b> Unit Tests for Chapter 2 Example</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="unit-testing.html"><a href="unit-testing.html#common-functions-1"><i class="fa fa-check"></i><b>3.2.1</b> Common Functions</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="unit-testing.html"><a href="unit-testing.html#s3-based-design"><i class="fa fa-check"></i><b>3.3</b> S3 Based Design</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="unit-testing.html"><a href="unit-testing.html#s3-extensions-1"><i class="fa fa-check"></i><b>3.3.1</b> S3 Extensions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html"><i class="fa fa-check"></i><b>4</b> Pull Request (PR) Peer Review</a>
<ul>
<li class="chapter" data-level="4.1" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html#pull-request-submission"><i class="fa fa-check"></i><b>4.1</b> Pull Request Submission</a></li>
<li class="chapter" data-level="4.2" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html#peer-review-preparation"><i class="fa fa-check"></i><b>4.2</b> Peer Review Preparation</a></li>
<li class="chapter" data-level="4.3" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html#map-out-your-own-approach"><i class="fa fa-check"></i><b>4.3</b> Map Out Your Own Approach</a></li>
<li class="chapter" data-level="4.4" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html#review-the-proposed-changes"><i class="fa fa-check"></i><b>4.4</b> Review the Proposed Changes</a></li>
<li class="chapter" data-level="4.5" data-path="pull-request-pr-peer-review.html"><a href="pull-request-pr-peer-review.html#discuss-alternative-solutions"><i class="fa fa-check"></i><b>4.5</b> Discuss Alternative Solutions</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Code Development in Model Infrastructure</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="extended-function-example" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> Extended Function Example<a href="extended-function-example.html#extended-function-example" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Let’s assume that the following task is to be implemented:</p>
<ul>
<li>Provided
<ul>
<li>a fitted model (<code>object</code>),</li>
<li>data (<code>newdata</code>),</li>
<li>evaluation time (<code>eval.time</code>), and</li>
<li>a vector of bin boundaries (<code>bin.boundaries</code>)</li>
</ul></li>
<li>Obtain estimated survival probabilities for <code>newdata</code></li>
<li>Return a list containing
<ul>
<li>the number of cases with predictions that fall within each bin</li>
<li>a vector indicating the bin in which each case in <code>newdata</code> falls</li>
<li>the user-specified bin structure</li>
</ul></li>
</ul>
<p>Ideally, our new tool would support all currently used survival models in the <code>somaverse</code>. However, for the sake of brevity, we will limit the supported models to only:</p>
<ul>
<li>AFT as implemented by <code>survival::survreg()</code> (<code>survreg</code> objects)</li>
<li>Elastic Net AFT as implemented by <code>SomaSurvival::fitSurvregnet()</code> (<code>survregnet</code> objects)</li>
<li>Cox proportional hazards as implemented by <code>survival::coxph()</code> (<code>coxph</code> objects)</li>
</ul>
<div id="procedure-specification" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Procedure Specification<a href="extended-function-example.html#procedure-specification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before writing any code, we should have a clear picture of how the task will be accomplished. Think of this step as writing the headers for an outline. Such headers should be clear and concise – describe the step, but avoid including details of <em>how</em> the step will be accomplished.</p>
<p>An example of such a procedure outline for this tool could be:</p>
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Identify bin membership based on the predicted survival probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Verify and return list</li>
</ul>
</div>
<div id="select-a-design" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Select a Design<a href="extended-function-example.html#select-a-design" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are two primary design structures for extendable tools currently used in the <code>somaverse</code>:</p>
<ul>
<li>An S3 based structure, where a generic specifies the availability of a tool, and individual S3 methods are implemented for each supported object type. Often the individual S3 methods are responsible for pre-processing of inputs, and each method calls a common “core” function that implements the primary functionality; and</li>
<li>A framework based solution that uses a single function to specify the general framework and uses supporting utility functions (possibly S3) to extend the framework to each object type supported.</li>
</ul>
<p>There are pros and cons to each of these design choices. We will discuss these as we work through illustrative examples of both designs.</p>
</div>
<div id="s3-based-design-structure" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> S3 Based Design Structure<a href="extended-function-example.html#s3-based-design-structure" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="usage-specification" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Usage Specification<a href="extended-function-example.html#usage-specification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The core elements of this design structure are the generic, default, and extension methods. For our example, there will be at least five functions with the following procedures:</p>
<ul>
<li>A generic method
<ul>
<li><code>survProbBins(object, ...)</code>.</li>
</ul></li>
<li>A default method
<ul>
<li><code>survProbBins.default(object, ...)</code>.
<ul>
<li>Generate error indicating that <code>object</code> is not supported</li>
</ul></li>
</ul></li>
<li>An extension method for <code>coxph</code> objects
<ul>
<li><code>survProbBins.coxph(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Identify bin membership based on the predicted survival probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survreg</code> objects
<ul>
<li><code>survProbBins.survreg(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Identify bin membership based on the predicted survival probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survregnet</code> objects
<ul>
<li><code>survProbBins.survregnet(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>convert2Survreg()</code> to convert <code>object</code> to a <code>survreg</code> object</li>
<li>Call <code>survProbBins.survreg()</code> using converted object.</li>
<li>Return <code>.survProbBins.survreg()</code> value object</li>
</ul></li>
</ul></li>
</ul>
<p>Notice that the method for objects of class <code>survregnet</code> is a bit different from the other extension methods. Specifically, we will convert the object to class <code>survreg</code> and call the <code>survreg</code> method. The S3 based design lends itself to situations where simple conversions can be exploited to minimize code duplication – for example, numeric vector to matrix.</p>
<p>Now that we have a general outline of the minimum components for this design, take a moment to identify any overlaps between methods. Are there common steps that may benefit from being implemented as common internal functions? Above, we see that two of the extension methods have exactly the same tasks. Can these be implemented as common internal functions?</p>
<ul>
<li>Test validity of inputs
<ul>
<li>This step might be different for each model type. For example, Elastic Net models will require different inputs that non-Elastic Net models. In this design, it is typically best to keep input testing local to each object type.</li>
</ul></li>
<li>Predict survival probabilities
<ul>
<li>This step will be different for each model type. The survival probability for the Cox model is not directly obtained from the <code>survival::predict()</code> function, as is the case for the AFT model. This step cannot be a common internal function.</li>
</ul></li>
<li>Identify bin membership based on the predicted survival probabilities<br>
Tally the number of cases in each probability bin <br>
Create a list containing the bin boundaries, bin membership, and totals<br>
<ul>
<li>Binning and tallying a vector of predicted probabilities is not dependent on <em>how</em> the vector of predictions was obtained. These steps can be implemented separately.</li>
</ul></li>
</ul>
<p>Let’s define common function <code>.binData()</code> to implement the three steps related to binning and tallying the predicted probabilities. Our design outline is then</p>
<ul>
<li>A generic method
<ul>
<li><code>survProbBins(object, ...)</code>.</li>
</ul></li>
<li>A default method
<ul>
<li><code>survProbBins.default(object, ...)</code>.
<ul>
<li>Generate error indicating that <code>object</code> is not supported</li>
</ul></li>
</ul></li>
<li>An extension method for <code>coxph</code> objects
<ul>
<li><code>survProbBins.coxph(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li><highlight>Call <myCode>.binData()</myCode></highlight></li>
<li>Return <highlight><myCode>.binData()</myCode> value object</highlight></li>
</ul></li>
</ul></li>
<li>An extension method for <code>survreg</code> objects
<ul>
<li><code>survProbBins.survreg(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li><highlight>Call <myCode>.binData()</myCode></highlight></li>
<li>Return <highlight><myCode>.binData()</myCode> value object</highlight></li>
</ul></li>
</ul></li>
<li>An extension method for <code>survregnet</code> objects
<ul>
<li><code>survProbBins.survregnet(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>convert2Survreg()</code> to convert <code>object</code> to a <code>survreg</code> object</li>
<li>Call <code>survProbBins.survreg()</code> using converted object.</li>
<li>Return <code>.survProbBins.survreg()</code> value object</li>
</ul></li>
</ul></li>
<li><highlight>An internal function for binning and tallying a vector of values</highlight>
<ul>
<li><highlight><myCode>.binData(values, bin.boundaries)</myCode></highlight>.
<ul>
<li><highlight>Test validity of inputs</highlight></li>
<li><highlight>Identify bin membership based on the provided probabilities</highlight></li>
<li><highlight>Tally the number of cases in each probability bin</highlight></li>
<li><highlight>Create a list containing the bin boundaries, bin membership, and totals</highlight></li>
<li><highlight>Return list</highlight></li>
</ul></li>
</ul></li>
</ul>
<p>As a next step, try to identify points at which intermediate results should be tested or verified prior to their use. For our example, it would be a good idea to ensure that the estimated survival probabilities obey general characteristics, such as all in range [0, 1], and to explicitly address cases for which this expectation is not met. There are a few options for this:</p>
<ol style="list-style-type: decimal">
<li>Incorporate tests into <code>.binData()</code> to ensure that the provided values have the expected characteristics of a probability or</li>
<li>Add a testing step between “Predict survival probabilities” and “Call <code>.binData()</code>”</li>
</ol>
<p>Selecting option 1 limits <code>.binData()</code> to be applicable only to vectors containing values in [0, 1]. Option 2 introduces an additional step and thus function into our design that must be fully unit tested. Because there is no explicit reason why <code>.binData()</code> should be limited to probabilities (perhaps such a binning functionality will be useful elsewhere in the future!), option 2 is a more general solution. Specifically, include an internal function that ensures the validity of the predicted survival probabilities and call it before passing the predicted probabilities to <code>.binData()</code>.</p>
<ul>
<li>A generic method
<ul>
<li><code>survProbBins(object, ...)</code>.</li>
</ul></li>
<li>A default method
<ul>
<li><code>survProbBins.default(object, ...)</code>.
<ul>
<li>Generate error indicating that <code>object</code> is not supported</li>
</ul></li>
</ul></li>
<li>An extension method for <code>coxph</code> objects
<ul>
<li><code>survProbBins.coxph(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li><highlight>Call <myCode>.testProbabilities()</myCode></highlight></li>
<li>Call <code>.binData()</code></li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survreg</code> objects
<ul>
<li><code>survProbBins.survreg(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li><highlight>Call <myCode>.testProbabilities()</myCode></highlight></li>
<li>Call <code>.binData()</code></li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survregnet</code> objects
<ul>
<li><code>survProbBins.survregnet(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>convert2Survreg()</code> to convert <code>object</code> to a <code>survreg</code> object</li>
<li>Call <code>survProbBins.survreg()</code> using converted object.</li>
<li>Return <code>.survProbBins.survreg()</code> value object</li>
</ul></li>
</ul></li>
<li>An internal function for binning and tallying a vector of values
<ul>
<li><code>.binData(values, bin.boundaries)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Identify bin membership based on the provided probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
<li><highlight>An internal function for testing validity of survival probabilities</highlight>
<ul>
<li><highlight><myCode>.testProbabilities(predictions)</myCode></highlight>
<ul>
<li><highlight>Ensure predicted probabilities are all finite and in [0,1]</highlight></li>
</ul></li>
</ul></li>
</ul>
<p>We now have an outline of our design and can begin filling in the details. At this stage, we will convert the design outline to skeleton code and outline the key steps of each function using only documentation.</p>
<div id="s3-generic" class="section level5 hasAnchor" number="2.3.1.0.1">
<h5><span class="header-section-number">2.3.1.0.1</span> S3 Generic<a href="extended-function-example.html#s3-generic" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The first function we must define is the “generic”</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="extended-function-example.html#cb6-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb6-2"><a href="extended-function-example.html#cb6-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb6-3"><a href="extended-function-example.html#cb6-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb6-4"><a href="extended-function-example.html#cb6-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb6-5"><a href="extended-function-example.html#cb6-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb6-6"><a href="extended-function-example.html#cb6-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb6-7"><a href="extended-function-example.html#cb6-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb6-8"><a href="extended-function-example.html#cb6-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb6-9"><a href="extended-function-example.html#cb6-9" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb6-10"><a href="extended-function-example.html#cb6-10" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb6-11"><a href="extended-function-example.html#cb6-11" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb6-12"><a href="extended-function-example.html#cb6-12" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb6-13"><a href="extended-function-example.html#cb6-13" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb6-14"><a href="extended-function-example.html#cb6-14" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb6-15"><a href="extended-function-example.html#cb6-15" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb6-16"><a href="extended-function-example.html#cb6-16" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb6-17"><a href="extended-function-example.html#cb6-17" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb6-18"><a href="extended-function-example.html#cb6-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb6-19"><a href="extended-function-example.html#cb6-19" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb6-20"><a href="extended-function-example.html#cb6-20" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span></code></pre></div>
<p>This function establishes <code>survProbBins()</code> as an S3 method that dispatches on the class structure of input <code>object</code>. Note that it is not necessary (nor is it advised) to specify any additional input arguments when declaring an S3 generic.</p>
<p>We often use this function as the primary documentation point for the method. Thus, the function title, description, dispatch argument, and expected returned value have been documented here.</p>
<p>The dispatch argument, <code>object</code>, could have been set as <code>fitted.model</code> based solely on the problem specification. But, we can imagine a circumstance where the method might be extended to allow a user to provide the vector of predictions rather than requiring a fitted model; in that usage, <code>fitted.model</code> would be a confusing input name, so we opt to use a more general name.</p>
</div>
<div id="s3-default" class="section level4 hasAnchor" number="2.3.1.1">
<h4><span class="header-section-number">2.3.1.1</span> S3 Default<a href="extended-function-example.html#s3-default" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Next, we will define the “default” method. This method is the “last resort” method, meaning it will be triggered if <code>object</code> does not inherit from any of the types for which we have extended the generic method. Suppose that the class structure of <code>object</code> is <code>c("foo", "bar")</code>. When <code>survProbBins(object)</code> is evaluated, <code>R</code> will follow the following path to identify the correct S3 method:</p>
<ul>
<li><code>survProbBins.foo()</code></li>
<li><code>survProbBins.bar()</code></li>
<li><code>survProbBins.default()</code></li>
</ul>
<p>If <code>survProbBins.foo()</code> is not defined, <code>R</code> looks for <code>survProbBins.bar()</code>. If <code>survProbBins.bar()</code> does not exist, <code>R</code> will dispatch the default method. Often the default method is used to generate an informative error message indicating that the function does not support the object provided by the user, as we have elected to implement here. However, this behavior is not a requirement; the default method can perform calculations and return a result.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="extended-function-example.html#cb7-1" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb7-2"><a href="extended-function-example.html#cb7-2" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb7-3"><a href="extended-function-example.html#cb7-3" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb7-4"><a href="extended-function-example.html#cb7-4" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb7-5"><a href="extended-function-example.html#cb7-5" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb7-6"><a href="extended-function-example.html#cb7-6" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-7"><a href="extended-function-example.html#cb7-7" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="s3-extensions" class="section level4 hasAnchor" number="2.3.1.2">
<h4><span class="header-section-number">2.3.1.2</span> S3 Extensions<a href="extended-function-example.html#s3-extensions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With the generic and default methods in place, we can now specify extensions of the method for each supported class of <code>object</code>, i.e., <code>coxph</code>, <code>survreg</code>, and <code>survregnet</code>. We elect to have these extensions described in the documentation of the generic (<code>@rdname survProbBins</code>) and incorporate new parameter documentation when new input parameters are introduced by a specific method, e.g., <code>lambda</code> of <code>survProbBins.survregnet()</code>. It is also possible to define all parameters in the generic documentation.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="extended-function-example.html#cb8-1" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb8-2"><a href="extended-function-example.html#cb8-2" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb8-3"><a href="extended-function-example.html#cb8-3" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb8-4"><a href="extended-function-example.html#cb8-4" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb8-5"><a href="extended-function-example.html#cb8-5" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb8-6"><a href="extended-function-example.html#cb8-6" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb8-7"><a href="extended-function-example.html#cb8-7" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb8-8"><a href="extended-function-example.html#cb8-8" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb8-9"><a href="extended-function-example.html#cb8-9" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb8-10"><a href="extended-function-example.html#cb8-10" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb8-11"><a href="extended-function-example.html#cb8-11" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb8-12"><a href="extended-function-example.html#cb8-12" tabindex="-1"></a>  <span class="co"># Verify that `newdata`, `eval.time` and `bin.boundaries` are provided</span></span>
<span id="cb8-13"><a href="extended-function-example.html#cb8-13" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb8-14"><a href="extended-function-example.html#cb8-14" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb8-15"><a href="extended-function-example.html#cb8-15" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb8-16"><a href="extended-function-example.html#cb8-16" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is a numeric vector in [0, 1]</span></span>
<span id="cb8-17"><a href="extended-function-example.html#cb8-17" tabindex="-1"></a>  </span>
<span id="cb8-18"><a href="extended-function-example.html#cb8-18" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb8-19"><a href="extended-function-example.html#cb8-19" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb8-20"><a href="extended-function-example.html#cb8-20" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb8-21"><a href="extended-function-example.html#cb8-21" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="extended-function-example.html#cb8-22" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb8-23"><a href="extended-function-example.html#cb8-23" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb8-24"><a href="extended-function-example.html#cb8-24" tabindex="-1"></a>  </span>
<span id="cb8-25"><a href="extended-function-example.html#cb8-25" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb8-26"><a href="extended-function-example.html#cb8-26" tabindex="-1"></a>  <span class="co"># Return the `.binData()` value object</span></span>
<span id="cb8-27"><a href="extended-function-example.html#cb8-27" tabindex="-1"></a>}</span>
<span id="cb8-28"><a href="extended-function-example.html#cb8-28" tabindex="-1"></a></span>
<span id="cb8-29"><a href="extended-function-example.html#cb8-29" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb8-30"><a href="extended-function-example.html#cb8-30" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb8-31"><a href="extended-function-example.html#cb8-31" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb8-32"><a href="extended-function-example.html#cb8-32" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb8-33"><a href="extended-function-example.html#cb8-33" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb8-34"><a href="extended-function-example.html#cb8-34" tabindex="-1"></a>  <span class="co"># Verify that `newdata`, `eval.time`, and `bin.boundaries` are provided</span></span>
<span id="cb8-35"><a href="extended-function-example.html#cb8-35" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb8-36"><a href="extended-function-example.html#cb8-36" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb8-37"><a href="extended-function-example.html#cb8-37" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb8-38"><a href="extended-function-example.html#cb8-38" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is a numeric vector in [0, 1]</span></span>
<span id="cb8-39"><a href="extended-function-example.html#cb8-39" tabindex="-1"></a>  </span>
<span id="cb8-40"><a href="extended-function-example.html#cb8-40" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb8-41"><a href="extended-function-example.html#cb8-41" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb8-42"><a href="extended-function-example.html#cb8-42" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb8-43"><a href="extended-function-example.html#cb8-43" tabindex="-1"></a>  </span>
<span id="cb8-44"><a href="extended-function-example.html#cb8-44" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb8-45"><a href="extended-function-example.html#cb8-45" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb8-46"><a href="extended-function-example.html#cb8-46" tabindex="-1"></a>  </span>
<span id="cb8-47"><a href="extended-function-example.html#cb8-47" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb8-48"><a href="extended-function-example.html#cb8-48" tabindex="-1"></a>  <span class="co"># Return the `.binData()` value object</span></span>
<span id="cb8-49"><a href="extended-function-example.html#cb8-49" tabindex="-1"></a>}</span>
<span id="cb8-50"><a href="extended-function-example.html#cb8-50" tabindex="-1"></a></span>
<span id="cb8-51"><a href="extended-function-example.html#cb8-51" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb8-52"><a href="extended-function-example.html#cb8-52" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb8-53"><a href="extended-function-example.html#cb8-53" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric. The Elastic Net parameter, lambda, of the model. </span></span>
<span id="cb8-54"><a href="extended-function-example.html#cb8-54" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb8-55"><a href="extended-function-example.html#cb8-55" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb8-56"><a href="extended-function-example.html#cb8-56" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb8-57"><a href="extended-function-example.html#cb8-57" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb8-58"><a href="extended-function-example.html#cb8-58" tabindex="-1"></a>  <span class="co"># Verify that `newdata`, `eval.time`, `bin.boundaries`, and `lambda` are </span></span>
<span id="cb8-59"><a href="extended-function-example.html#cb8-59" tabindex="-1"></a>  <span class="co">#   provided</span></span>
<span id="cb8-60"><a href="extended-function-example.html#cb8-60" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb8-61"><a href="extended-function-example.html#cb8-61" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb8-62"><a href="extended-function-example.html#cb8-62" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb8-63"><a href="extended-function-example.html#cb8-63" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is a numeric vector in [0, 1]</span></span>
<span id="cb8-64"><a href="extended-function-example.html#cb8-64" tabindex="-1"></a>  <span class="co"># Verify that `lambda` is non-negative scalar</span></span>
<span id="cb8-65"><a href="extended-function-example.html#cb8-65" tabindex="-1"></a>  </span>
<span id="cb8-66"><a href="extended-function-example.html#cb8-66" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb8-67"><a href="extended-function-example.html#cb8-67" tabindex="-1"></a>  <span class="co"># Call convert2survreg() to convert to a `survreg` object</span></span>
<span id="cb8-68"><a href="extended-function-example.html#cb8-68" tabindex="-1"></a>  </span>
<span id="cb8-69"><a href="extended-function-example.html#cb8-69" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb8-70"><a href="extended-function-example.html#cb8-70" tabindex="-1"></a>  <span class="co"># Call survProbBins.survreg() passing converted object </span></span>
<span id="cb8-71"><a href="extended-function-example.html#cb8-71" tabindex="-1"></a>  </span>
<span id="cb8-72"><a href="extended-function-example.html#cb8-72" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb8-73"><a href="extended-function-example.html#cb8-73" tabindex="-1"></a>  <span class="co"># Return the `.survProbBins.survreg()` value object</span></span>
<span id="cb8-74"><a href="extended-function-example.html#cb8-74" tabindex="-1"></a>}</span></code></pre></div>
<p>An alternative and more concise usage specification for <code>survProbBins.survregnet()</code> is</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="extended-function-example.html#cb9-1" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb9-2"><a href="extended-function-example.html#cb9-2" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb9-3"><a href="extended-function-example.html#cb9-3" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric. The Elastic Net parameter of the model. </span></span>
<span id="cb9-4"><a href="extended-function-example.html#cb9-4" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb9-5"><a href="extended-function-example.html#cb9-5" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, lambda, ...) {</span>
<span id="cb9-6"><a href="extended-function-example.html#cb9-6" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb9-7"><a href="extended-function-example.html#cb9-7" tabindex="-1"></a>  <span class="co"># Verify that `lambda` is provided and is a non-negative scalar</span></span>
<span id="cb9-8"><a href="extended-function-example.html#cb9-8" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="extended-function-example.html#cb9-9" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb9-10"><a href="extended-function-example.html#cb9-10" tabindex="-1"></a>  <span class="co"># Call convert2survreg() to convert to a `survreg` object</span></span>
<span id="cb9-11"><a href="extended-function-example.html#cb9-11" tabindex="-1"></a>  </span>
<span id="cb9-12"><a href="extended-function-example.html#cb9-12" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb9-13"><a href="extended-function-example.html#cb9-13" tabindex="-1"></a>  <span class="co"># Call survProbBins.survreg() passing converted object and ...</span></span>
<span id="cb9-14"><a href="extended-function-example.html#cb9-14" tabindex="-1"></a>  </span>
<span id="cb9-15"><a href="extended-function-example.html#cb9-15" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb9-16"><a href="extended-function-example.html#cb9-16" tabindex="-1"></a>  <span class="co"># Return `survProbBins.survreg()` value object</span></span>
<span id="cb9-17"><a href="extended-function-example.html#cb9-17" tabindex="-1"></a>}</span></code></pre></div>
<p>where the ellipsis (<code>...</code>) is assumed to contain the additional arguments required and used by <code>survProbBins.survreg()</code>, i.e., <code>newdata</code>, <code>eval.time</code>, and <code>bin.boundaries</code>. Though this is “tidier” in the sense that we only worry about the inputs that <code>survProbBins.survregnet()</code> actually <em>uses</em>, this is a forward-facing function, and requiring users to figure out what needs to be passed through the ellipsis can be an unkind burden.</p>
</div>
<div id="common-functions" class="section level4 hasAnchor" number="2.3.1.3">
<h4><span class="header-section-number">2.3.1.3</span> Common Functions<a href="extended-function-example.html#common-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The required task, bin the probabilities, and the common task of verifying that the survival probabilities are valid will be accomplished through common utility functions.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="extended-function-example.html#cb10-1" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb10-2"><a href="extended-function-example.html#cb10-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-3"><a href="extended-function-example.html#cb10-3" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb10-4"><a href="extended-function-example.html#cb10-4" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb10-5"><a href="extended-function-example.html#cb10-5" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb10-6"><a href="extended-function-example.html#cb10-6" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb10-7"><a href="extended-function-example.html#cb10-7" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb10-8"><a href="extended-function-example.html#cb10-8" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb10-9"><a href="extended-function-example.html#cb10-9" tabindex="-1"></a>  <span class="co"># Verify that `predictions` is provided and is a non-empty numeric vector</span></span>
<span id="cb10-10"><a href="extended-function-example.html#cb10-10" tabindex="-1"></a>  </span>
<span id="cb10-11"><a href="extended-function-example.html#cb10-11" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb10-12"><a href="extended-function-example.html#cb10-12" tabindex="-1"></a>  </span>
<span id="cb10-13"><a href="extended-function-example.html#cb10-13" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb10-14"><a href="extended-function-example.html#cb10-14" tabindex="-1"></a>  <span class="co"># Check for non-finite (NA, NaN, Inf) values</span></span>
<span id="cb10-15"><a href="extended-function-example.html#cb10-15" tabindex="-1"></a>  <span class="co"># Reset non-finite values to NA_real_ and tell user</span></span>
<span id="cb10-16"><a href="extended-function-example.html#cb10-16" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb10-17"><a href="extended-function-example.html#cb10-17" tabindex="-1"></a>  <span class="co"># Check for values outside of [0, 1]</span></span>
<span id="cb10-18"><a href="extended-function-example.html#cb10-18" tabindex="-1"></a>  <span class="co"># Reset out of range values to NA_real_ and tell user</span></span>
<span id="cb10-19"><a href="extended-function-example.html#cb10-19" tabindex="-1"></a>  </span>
<span id="cb10-20"><a href="extended-function-example.html#cb10-20" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb10-21"><a href="extended-function-example.html#cb10-21" tabindex="-1"></a>  <span class="co"># Return modified probabilities as an unnamed numeric vector</span></span>
<span id="cb10-22"><a href="extended-function-example.html#cb10-22" tabindex="-1"></a>}</span>
<span id="cb10-23"><a href="extended-function-example.html#cb10-23" tabindex="-1"></a></span>
<span id="cb10-24"><a href="extended-function-example.html#cb10-24" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb10-25"><a href="extended-function-example.html#cb10-25" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-26"><a href="extended-function-example.html#cb10-26" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb10-27"><a href="extended-function-example.html#cb10-27" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb10-28"><a href="extended-function-example.html#cb10-28" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb10-29"><a href="extended-function-example.html#cb10-29" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb10-30"><a href="extended-function-example.html#cb10-30" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb10-31"><a href="extended-function-example.html#cb10-31" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb10-32"><a href="extended-function-example.html#cb10-32" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb10-33"><a href="extended-function-example.html#cb10-33" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb10-34"><a href="extended-function-example.html#cb10-34" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb10-35"><a href="extended-function-example.html#cb10-35" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb10-36"><a href="extended-function-example.html#cb10-36" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb10-37"><a href="extended-function-example.html#cb10-37" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb10-38"><a href="extended-function-example.html#cb10-38" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-39"><a href="extended-function-example.html#cb10-39" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb10-40"><a href="extended-function-example.html#cb10-40" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb10-41"><a href="extended-function-example.html#cb10-41" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb10-42"><a href="extended-function-example.html#cb10-42" tabindex="-1"></a>  <span class="co"># Verify that `values` is provided</span></span>
<span id="cb10-43"><a href="extended-function-example.html#cb10-43" tabindex="-1"></a>  <span class="co"># Verify that `values` is a numeric vector</span></span>
<span id="cb10-44"><a href="extended-function-example.html#cb10-44" tabindex="-1"></a>  <span class="co"># Verify that `values` does not contain NA/NaN/Inf</span></span>
<span id="cb10-45"><a href="extended-function-example.html#cb10-45" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is provided</span></span>
<span id="cb10-46"><a href="extended-function-example.html#cb10-46" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is a numeric vector of length &gt; 1</span></span>
<span id="cb10-47"><a href="extended-function-example.html#cb10-47" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` are all unique values</span></span>
<span id="cb10-48"><a href="extended-function-example.html#cb10-48" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` does not contain NA or NaN values</span></span>
<span id="cb10-49"><a href="extended-function-example.html#cb10-49" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` are in increasing order</span></span>
<span id="cb10-50"><a href="extended-function-example.html#cb10-50" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` cover range of `values`</span></span>
<span id="cb10-51"><a href="extended-function-example.html#cb10-51" tabindex="-1"></a>  </span>
<span id="cb10-52"><a href="extended-function-example.html#cb10-52" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb10-53"><a href="extended-function-example.html#cb10-53" tabindex="-1"></a>  </span>
<span id="cb10-54"><a href="extended-function-example.html#cb10-54" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb10-55"><a href="extended-function-example.html#cb10-55" tabindex="-1"></a>  <span class="co"># Identify bin membership for each value</span></span>
<span id="cb10-56"><a href="extended-function-example.html#cb10-56" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each bin</span></span>
<span id="cb10-57"><a href="extended-function-example.html#cb10-57" tabindex="-1"></a></span>
<span id="cb10-58"><a href="extended-function-example.html#cb10-58" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb10-59"><a href="extended-function-example.html#cb10-59" tabindex="-1"></a>  <span class="co"># Return a list with elements `bin.boundaries`, `bin.id`, and `totals`</span></span>
<span id="cb10-60"><a href="extended-function-example.html#cb10-60" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="general-comments" class="section level4 hasAnchor" number="2.3.1.4">
<h4><span class="header-section-number">2.3.1.4</span> General Comments<a href="extended-function-example.html#general-comments" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Notice that each function adheres to the function structure described in Chapter 1 – specifically, usage definition is detailed by our design outline, and each function includes input testing, input processing, task implementation, and result construction. Each component is heavily documented. The usage definition is detailed through the <code>roxygen</code> documentation and the internal structure of each function is detailed through comments. Because we cannot always anticipate every line of code, we include all of the components regardless of whether or not we anticipate their necessity at this stage. For example, in <code>.binData()</code>, there are currently no details for component “Input Processing.” Keeping the header here can serve as a reminder to ensure that we have not overlooked something as we continue to fill in the details.</p>
<p>For purely internal functions, such as <code>.binData()</code>, the input testing element may seem superfluous – “Only <em>I</em> am calling this function”; “I <em>know</em> what is being passed is valid”; “I’ve already checked most of this”; etc. However, mistakes happen, things get overlooked, maybe another developer decides this function will be helpful for another tool. Unless a test is time- or memory-intensive, it doesn’t hurt to verify that you are getting what you need!</p>
<p>Further, the specific characteristics of the inputs that are tested in each function are not necessarily the same. For example, in <code>survProbBins.*()</code> we do not <em>use</em> <code>bin.boundaries</code> and thus only test that it is provided, that it is of the type expected by <code>.binData()</code>, and this is contains values as required for survival probabilities (in range [0,1]). We reserve much of the testing, such as uniqueness, increasing, etc., for the function <code>.binData()</code>, which <strong>uses</strong> that input. This is not a hard and fast rule; remember, we also want to stop a function as soon as we know that there is a problem. There will certainly be circumstances under which it is kinder to the user to more extensively test inputs well before they will be used. However, keep in mind that incorporating tests for values outside of the function in which they are used could lead to issues if the function is later extended. Say for example, we add tests for <code>NA</code> values into the <code>survProbBins.*()</code> functions. If at a later time it is decided that a better implementation is to simply report the <code>NA</code> values rather than stop with an error, we would need to change not only the <code>.binData()</code> function to accommodate this change but also the <code>survProbBins.*()</code> functions to remove the tests for the <code>NA</code> condition.</p>
</div>
</div>
<div id="input-testing-1" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Input Testing<a href="extended-function-example.html#input-testing-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the S3 based design, the testing of the input <code>object</code> happens automatically through the specification of the individual methods – if a method is not implemented for objects of class <code>xyz</code>, the default method <code>survProbBins.default()</code> will trigger indicating that the object is not supported.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="extended-function-example.html#cb11-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb11-2"><a href="extended-function-example.html#cb11-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-3"><a href="extended-function-example.html#cb11-3" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb11-4"><a href="extended-function-example.html#cb11-4" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-5"><a href="extended-function-example.html#cb11-5" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb11-6"><a href="extended-function-example.html#cb11-6" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb11-7"><a href="extended-function-example.html#cb11-7" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb11-8"><a href="extended-function-example.html#cb11-8" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb11-9"><a href="extended-function-example.html#cb11-9" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb11-10"><a href="extended-function-example.html#cb11-10" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb11-11"><a href="extended-function-example.html#cb11-11" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb11-12"><a href="extended-function-example.html#cb11-12" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb11-13"><a href="extended-function-example.html#cb11-13" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-14"><a href="extended-function-example.html#cb11-14" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb11-15"><a href="extended-function-example.html#cb11-15" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb11-16"><a href="extended-function-example.html#cb11-16" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb11-17"><a href="extended-function-example.html#cb11-17" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb11-18"><a href="extended-function-example.html#cb11-18" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb11-19"><a href="extended-function-example.html#cb11-19" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb11-20"><a href="extended-function-example.html#cb11-20" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-21"><a href="extended-function-example.html#cb11-21" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb11-22"><a href="extended-function-example.html#cb11-22" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb11-23"><a href="extended-function-example.html#cb11-23" tabindex="-1"></a></span>
<span id="cb11-24"><a href="extended-function-example.html#cb11-24" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb11-25"><a href="extended-function-example.html#cb11-25" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb11-26"><a href="extended-function-example.html#cb11-26" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb11-27"><a href="extended-function-example.html#cb11-27" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb11-28"><a href="extended-function-example.html#cb11-28" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb11-29"><a href="extended-function-example.html#cb11-29" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-30"><a href="extended-function-example.html#cb11-30" tabindex="-1"></a>}</span>
<span id="cb11-31"><a href="extended-function-example.html#cb11-31" tabindex="-1"></a></span>
<span id="cb11-32"><a href="extended-function-example.html#cb11-32" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb11-33"><a href="extended-function-example.html#cb11-33" tabindex="-1"></a></span>
<span id="cb11-34"><a href="extended-function-example.html#cb11-34" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb11-35"><a href="extended-function-example.html#cb11-35" tabindex="-1"></a><span class="co">#&#39; @rdname survProbBins</span></span>
<span id="cb11-36"><a href="extended-function-example.html#cb11-36" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb11-37"><a href="extended-function-example.html#cb11-37" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb11-38"><a href="extended-function-example.html#cb11-38" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb11-39"><a href="extended-function-example.html#cb11-39" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb11-40"><a href="extended-function-example.html#cb11-40" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb11-41"><a href="extended-function-example.html#cb11-41" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb11-42"><a href="extended-function-example.html#cb11-42" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb11-43"><a href="extended-function-example.html#cb11-43" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb11-44"><a href="extended-function-example.html#cb11-44" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb11-45"><a href="extended-function-example.html#cb11-45" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb11-46"><a href="extended-function-example.html#cb11-46" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb11-47"><a href="extended-function-example.html#cb11-47" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb11-48"><a href="extended-function-example.html#cb11-48" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-49"><a href="extended-function-example.html#cb11-49" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb11-50"><a href="extended-function-example.html#cb11-50" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-51"><a href="extended-function-example.html#cb11-51" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-52"><a href="extended-function-example.html#cb11-52" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb11-53"><a href="extended-function-example.html#cb11-53" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-54"><a href="extended-function-example.html#cb11-54" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-55"><a href="extended-function-example.html#cb11-55" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-56"><a href="extended-function-example.html#cb11-56" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb11-57"><a href="extended-function-example.html#cb11-57" tabindex="-1"></a>  )</span>
<span id="cb11-58"><a href="extended-function-example.html#cb11-58" tabindex="-1"></a>  </span>
<span id="cb11-59"><a href="extended-function-example.html#cb11-59" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb11-60"><a href="extended-function-example.html#cb11-60" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb11-61"><a href="extended-function-example.html#cb11-61" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb11-62"><a href="extended-function-example.html#cb11-62" tabindex="-1"></a>  </span>
<span id="cb11-63"><a href="extended-function-example.html#cb11-63" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb11-64"><a href="extended-function-example.html#cb11-64" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb11-65"><a href="extended-function-example.html#cb11-65" tabindex="-1"></a>  </span>
<span id="cb11-66"><a href="extended-function-example.html#cb11-66" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb11-67"><a href="extended-function-example.html#cb11-67" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb11-68"><a href="extended-function-example.html#cb11-68" tabindex="-1"></a>}</span>
<span id="cb11-69"><a href="extended-function-example.html#cb11-69" tabindex="-1"></a></span>
<span id="cb11-70"><a href="extended-function-example.html#cb11-70" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb11-71"><a href="extended-function-example.html#cb11-71" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb11-72"><a href="extended-function-example.html#cb11-72" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb11-73"><a href="extended-function-example.html#cb11-73" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb11-74"><a href="extended-function-example.html#cb11-74" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb11-75"><a href="extended-function-example.html#cb11-75" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb11-76"><a href="extended-function-example.html#cb11-76" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb11-77"><a href="extended-function-example.html#cb11-77" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb11-78"><a href="extended-function-example.html#cb11-78" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-79"><a href="extended-function-example.html#cb11-79" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb11-80"><a href="extended-function-example.html#cb11-80" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-81"><a href="extended-function-example.html#cb11-81" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-82"><a href="extended-function-example.html#cb11-82" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb11-83"><a href="extended-function-example.html#cb11-83" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-84"><a href="extended-function-example.html#cb11-84" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-85"><a href="extended-function-example.html#cb11-85" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-86"><a href="extended-function-example.html#cb11-86" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb11-87"><a href="extended-function-example.html#cb11-87" tabindex="-1"></a>  )</span>
<span id="cb11-88"><a href="extended-function-example.html#cb11-88" tabindex="-1"></a>  </span>
<span id="cb11-89"><a href="extended-function-example.html#cb11-89" tabindex="-1"></a>  <span class="do">### Input processing</span></span>
<span id="cb11-90"><a href="extended-function-example.html#cb11-90" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb11-91"><a href="extended-function-example.html#cb11-91" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb11-92"><a href="extended-function-example.html#cb11-92" tabindex="-1"></a>  </span>
<span id="cb11-93"><a href="extended-function-example.html#cb11-93" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb11-94"><a href="extended-function-example.html#cb11-94" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb11-95"><a href="extended-function-example.html#cb11-95" tabindex="-1"></a></span>
<span id="cb11-96"><a href="extended-function-example.html#cb11-96" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb11-97"><a href="extended-function-example.html#cb11-97" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb11-98"><a href="extended-function-example.html#cb11-98" tabindex="-1"></a>}</span>
<span id="cb11-99"><a href="extended-function-example.html#cb11-99" tabindex="-1"></a></span>
<span id="cb11-100"><a href="extended-function-example.html#cb11-100" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb11-101"><a href="extended-function-example.html#cb11-101" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb11-102"><a href="extended-function-example.html#cb11-102" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric. The Elastic Net parameter, lambda, of the model. </span></span>
<span id="cb11-103"><a href="extended-function-example.html#cb11-103" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb11-104"><a href="extended-function-example.html#cb11-104" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb11-105"><a href="extended-function-example.html#cb11-105" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb11-106"><a href="extended-function-example.html#cb11-106" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb11-107"><a href="extended-function-example.html#cb11-107" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb11-108"><a href="extended-function-example.html#cb11-108" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb11-109"><a href="extended-function-example.html#cb11-109" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb11-110"><a href="extended-function-example.html#cb11-110" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-111"><a href="extended-function-example.html#cb11-111" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb11-112"><a href="extended-function-example.html#cb11-112" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-113"><a href="extended-function-example.html#cb11-113" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-114"><a href="extended-function-example.html#cb11-114" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb11-115"><a href="extended-function-example.html#cb11-115" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-116"><a href="extended-function-example.html#cb11-116" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-117"><a href="extended-function-example.html#cb11-117" tabindex="-1"></a>      <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-118"><a href="extended-function-example.html#cb11-118" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb11-119"><a href="extended-function-example.html#cb11-119" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-120"><a href="extended-function-example.html#cb11-120" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-121"><a href="extended-function-example.html#cb11-121" tabindex="-1"></a>      <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb11-122"><a href="extended-function-example.html#cb11-122" tabindex="-1"></a>  )</span>
<span id="cb11-123"><a href="extended-function-example.html#cb11-123" tabindex="-1"></a>  </span>
<span id="cb11-124"><a href="extended-function-example.html#cb11-124" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb11-125"><a href="extended-function-example.html#cb11-125" tabindex="-1"></a>  <span class="co"># Call convert2survreg() to convert to `survreg` object</span></span>
<span id="cb11-126"><a href="extended-function-example.html#cb11-126" tabindex="-1"></a>  </span>
<span id="cb11-127"><a href="extended-function-example.html#cb11-127" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb11-128"><a href="extended-function-example.html#cb11-128" tabindex="-1"></a>  <span class="co"># Call survProbBins.survreg() passing converted object</span></span>
<span id="cb11-129"><a href="extended-function-example.html#cb11-129" tabindex="-1"></a>  </span>
<span id="cb11-130"><a href="extended-function-example.html#cb11-130" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb11-131"><a href="extended-function-example.html#cb11-131" tabindex="-1"></a>  <span class="co"># Return `survProbBins.survreg()` value object</span></span>
<span id="cb11-132"><a href="extended-function-example.html#cb11-132" tabindex="-1"></a>}</span>
<span id="cb11-133"><a href="extended-function-example.html#cb11-133" tabindex="-1"></a></span>
<span id="cb11-134"><a href="extended-function-example.html#cb11-134" tabindex="-1"></a><span class="do">### Common Utility Functions</span></span>
<span id="cb11-135"><a href="extended-function-example.html#cb11-135" tabindex="-1"></a></span>
<span id="cb11-136"><a href="extended-function-example.html#cb11-136" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb11-137"><a href="extended-function-example.html#cb11-137" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-138"><a href="extended-function-example.html#cb11-138" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb11-139"><a href="extended-function-example.html#cb11-139" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb11-140"><a href="extended-function-example.html#cb11-140" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb11-141"><a href="extended-function-example.html#cb11-141" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb11-142"><a href="extended-function-example.html#cb11-142" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb11-143"><a href="extended-function-example.html#cb11-143" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb11-144"><a href="extended-function-example.html#cb11-144" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb11-145"><a href="extended-function-example.html#cb11-145" tabindex="-1"></a>    <span class="st">&quot;`predictions` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-146"><a href="extended-function-example.html#cb11-146" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(predictions) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-147"><a href="extended-function-example.html#cb11-147" tabindex="-1"></a>      <span class="fu">is.vector</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(predictions) <span class="sc">!=</span> 0L</span>
<span id="cb11-148"><a href="extended-function-example.html#cb11-148" tabindex="-1"></a>  )</span>
<span id="cb11-149"><a href="extended-function-example.html#cb11-149" tabindex="-1"></a>  </span>
<span id="cb11-150"><a href="extended-function-example.html#cb11-150" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb11-151"><a href="extended-function-example.html#cb11-151" tabindex="-1"></a>  </span>
<span id="cb11-152"><a href="extended-function-example.html#cb11-152" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb11-153"><a href="extended-function-example.html#cb11-153" tabindex="-1"></a>  <span class="co"># Check for non-finite (NA, NaN, Inf) values</span></span>
<span id="cb11-154"><a href="extended-function-example.html#cb11-154" tabindex="-1"></a>  <span class="co"># Reset non-finite values to NA_real_ and tell user</span></span>
<span id="cb11-155"><a href="extended-function-example.html#cb11-155" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb11-156"><a href="extended-function-example.html#cb11-156" tabindex="-1"></a>  <span class="co"># Check for values outside of [0, 1]</span></span>
<span id="cb11-157"><a href="extended-function-example.html#cb11-157" tabindex="-1"></a>  <span class="co"># Reset out of range values to NA_real_ and tell user</span></span>
<span id="cb11-158"><a href="extended-function-example.html#cb11-158" tabindex="-1"></a>  </span>
<span id="cb11-159"><a href="extended-function-example.html#cb11-159" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb11-160"><a href="extended-function-example.html#cb11-160" tabindex="-1"></a>  <span class="co"># Return modified probabilities as an unnamed numeric vector</span></span>
<span id="cb11-161"><a href="extended-function-example.html#cb11-161" tabindex="-1"></a>}</span>
<span id="cb11-162"><a href="extended-function-example.html#cb11-162" tabindex="-1"></a></span>
<span id="cb11-163"><a href="extended-function-example.html#cb11-163" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb11-164"><a href="extended-function-example.html#cb11-164" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-165"><a href="extended-function-example.html#cb11-165" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb11-166"><a href="extended-function-example.html#cb11-166" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb11-167"><a href="extended-function-example.html#cb11-167" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb11-168"><a href="extended-function-example.html#cb11-168" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb11-169"><a href="extended-function-example.html#cb11-169" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb11-170"><a href="extended-function-example.html#cb11-170" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb11-171"><a href="extended-function-example.html#cb11-171" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb11-172"><a href="extended-function-example.html#cb11-172" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb11-173"><a href="extended-function-example.html#cb11-173" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb11-174"><a href="extended-function-example.html#cb11-174" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb11-175"><a href="extended-function-example.html#cb11-175" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb11-176"><a href="extended-function-example.html#cb11-176" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb11-177"><a href="extended-function-example.html#cb11-177" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-178"><a href="extended-function-example.html#cb11-178" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb11-179"><a href="extended-function-example.html#cb11-179" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb11-180"><a href="extended-function-example.html#cb11-180" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb11-181"><a href="extended-function-example.html#cb11-181" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb11-182"><a href="extended-function-example.html#cb11-182" tabindex="-1"></a>    <span class="st">&quot;`values` must be a non-empty, numeric vector.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-183"><a href="extended-function-example.html#cb11-183" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(values) <span class="sc">&amp;&amp;</span></span>
<span id="cb11-184"><a href="extended-function-example.html#cb11-184" tabindex="-1"></a>        <span class="fu">length</span>(values) <span class="sc">!=</span> 0L,</span>
<span id="cb11-185"><a href="extended-function-example.html#cb11-185" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector of length &gt; 1.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-186"><a href="extended-function-example.html#cb11-186" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-187"><a href="extended-function-example.html#cb11-187" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(bin.boundaries),</span>
<span id="cb11-188"><a href="extended-function-example.html#cb11-188" tabindex="-1"></a>    <span class="st">&quot;All values in `bin.boundaries` must be unique.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-189"><a href="extended-function-example.html#cb11-189" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(bin.boundaries)),</span>
<span id="cb11-190"><a href="extended-function-example.html#cb11-190" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` cannot contain NA or NaN values.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-191"><a href="extended-function-example.html#cb11-191" tabindex="-1"></a>      <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.nan</span>(bin.boundaries)),</span>
<span id="cb11-192"><a href="extended-function-example.html#cb11-192" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be in increasing order.&quot;</span> <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.unsorted</span>(bin.boundaries),</span>
<span id="cb11-193"><a href="extended-function-example.html#cb11-193" tabindex="-1"></a>    <span class="st">&quot;`values` must be finite and in range of `bin.boundaries`.&quot;</span> <span class="ot">=</span> </span>
<span id="cb11-194"><a href="extended-function-example.html#cb11-194" tabindex="-1"></a>      <span class="fu">all</span>(<span class="fu">is.finite</span>(values)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(values <span class="sc">&gt;=</span> <span class="fu">min</span>(bin.boundaries)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb11-195"><a href="extended-function-example.html#cb11-195" tabindex="-1"></a>      <span class="fu">all</span>(values <span class="sc">&lt;=</span> <span class="fu">max</span>(bin.boundaries))</span>
<span id="cb11-196"><a href="extended-function-example.html#cb11-196" tabindex="-1"></a>  )</span>
<span id="cb11-197"><a href="extended-function-example.html#cb11-197" tabindex="-1"></a>  </span>
<span id="cb11-198"><a href="extended-function-example.html#cb11-198" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb11-199"><a href="extended-function-example.html#cb11-199" tabindex="-1"></a>  </span>
<span id="cb11-200"><a href="extended-function-example.html#cb11-200" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb11-201"><a href="extended-function-example.html#cb11-201" tabindex="-1"></a>  <span class="co"># Identify bin membership based on the provided probabilities</span></span>
<span id="cb11-202"><a href="extended-function-example.html#cb11-202" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each probability bin</span></span>
<span id="cb11-203"><a href="extended-function-example.html#cb11-203" tabindex="-1"></a>  </span>
<span id="cb11-204"><a href="extended-function-example.html#cb11-204" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb11-205"><a href="extended-function-example.html#cb11-205" tabindex="-1"></a>  <span class="co"># Return a list with elements `bin.boundaries`, `bin.id`, and `totals`</span></span>
<span id="cb11-206"><a href="extended-function-example.html#cb11-206" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="input-processing-1" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Input Processing<a href="extended-function-example.html#input-processing-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="extended-function-example.html#cb12-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb12-2"><a href="extended-function-example.html#cb12-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-3"><a href="extended-function-example.html#cb12-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb12-4"><a href="extended-function-example.html#cb12-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb12-5"><a href="extended-function-example.html#cb12-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb12-6"><a href="extended-function-example.html#cb12-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb12-7"><a href="extended-function-example.html#cb12-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb12-8"><a href="extended-function-example.html#cb12-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb12-9"><a href="extended-function-example.html#cb12-9" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb12-10"><a href="extended-function-example.html#cb12-10" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb12-11"><a href="extended-function-example.html#cb12-11" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-12"><a href="extended-function-example.html#cb12-12" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb12-13"><a href="extended-function-example.html#cb12-13" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb12-14"><a href="extended-function-example.html#cb12-14" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb12-15"><a href="extended-function-example.html#cb12-15" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb12-16"><a href="extended-function-example.html#cb12-16" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb12-17"><a href="extended-function-example.html#cb12-17" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb12-18"><a href="extended-function-example.html#cb12-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-19"><a href="extended-function-example.html#cb12-19" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb12-20"><a href="extended-function-example.html#cb12-20" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb12-21"><a href="extended-function-example.html#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="extended-function-example.html#cb12-22" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb12-23"><a href="extended-function-example.html#cb12-23" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-24"><a href="extended-function-example.html#cb12-24" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb12-25"><a href="extended-function-example.html#cb12-25" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb12-26"><a href="extended-function-example.html#cb12-26" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb12-27"><a href="extended-function-example.html#cb12-27" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-28"><a href="extended-function-example.html#cb12-28" tabindex="-1"></a>}</span>
<span id="cb12-29"><a href="extended-function-example.html#cb12-29" tabindex="-1"></a></span>
<span id="cb12-30"><a href="extended-function-example.html#cb12-30" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb12-31"><a href="extended-function-example.html#cb12-31" tabindex="-1"></a></span>
<span id="cb12-32"><a href="extended-function-example.html#cb12-32" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb12-33"><a href="extended-function-example.html#cb12-33" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-34"><a href="extended-function-example.html#cb12-34" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb12-35"><a href="extended-function-example.html#cb12-35" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb12-36"><a href="extended-function-example.html#cb12-36" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb12-37"><a href="extended-function-example.html#cb12-37" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb12-38"><a href="extended-function-example.html#cb12-38" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb12-39"><a href="extended-function-example.html#cb12-39" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb12-40"><a href="extended-function-example.html#cb12-40" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-41"><a href="extended-function-example.html#cb12-41" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb12-42"><a href="extended-function-example.html#cb12-42" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-43"><a href="extended-function-example.html#cb12-43" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-44"><a href="extended-function-example.html#cb12-44" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb12-45"><a href="extended-function-example.html#cb12-45" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-46"><a href="extended-function-example.html#cb12-46" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-47"><a href="extended-function-example.html#cb12-47" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-48"><a href="extended-function-example.html#cb12-48" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb12-49"><a href="extended-function-example.html#cb12-49" tabindex="-1"></a>  )</span>
<span id="cb12-50"><a href="extended-function-example.html#cb12-50" tabindex="-1"></a>  </span>
<span id="cb12-51"><a href="extended-function-example.html#cb12-51" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb12-52"><a href="extended-function-example.html#cb12-52" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb12-53"><a href="extended-function-example.html#cb12-53" tabindex="-1"></a>  </span>
<span id="cb12-54"><a href="extended-function-example.html#cb12-54" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb12-55"><a href="extended-function-example.html#cb12-55" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb12-56"><a href="extended-function-example.html#cb12-56" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb12-57"><a href="extended-function-example.html#cb12-57" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb12-58"><a href="extended-function-example.html#cb12-58" tabindex="-1"></a>  </span>
<span id="cb12-59"><a href="extended-function-example.html#cb12-59" tabindex="-1"></a>  base_hazard_at_t <span class="ot">&lt;-</span> base_hazard[t_idx, 1L]</span>
<span id="cb12-60"><a href="extended-function-example.html#cb12-60" tabindex="-1"></a>  </span>
<span id="cb12-61"><a href="extended-function-example.html#cb12-61" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb12-62"><a href="extended-function-example.html#cb12-62" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard_at_t) ) {</span>
<span id="cb12-63"><a href="extended-function-example.html#cb12-63" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard_at_t), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-64"><a href="extended-function-example.html#cb12-64" tabindex="-1"></a>  }</span>
<span id="cb12-65"><a href="extended-function-example.html#cb12-65" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb12-66"><a href="extended-function-example.html#cb12-66" tabindex="-1"></a></span>
<span id="cb12-67"><a href="extended-function-example.html#cb12-67" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb12-68"><a href="extended-function-example.html#cb12-68" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>),</span>
<span id="cb12-69"><a href="extended-function-example.html#cb12-69" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb12-70"><a href="extended-function-example.html#cb12-70" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb12-71"><a href="extended-function-example.html#cb12-71" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-72"><a href="extended-function-example.html#cb12-72" tabindex="-1"></a>                               })</span>
<span id="cb12-73"><a href="extended-function-example.html#cb12-73" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb12-74"><a href="extended-function-example.html#cb12-74" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb12-75"><a href="extended-function-example.html#cb12-75" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb12-76"><a href="extended-function-example.html#cb12-76" tabindex="-1"></a>  </span>
<span id="cb12-77"><a href="extended-function-example.html#cb12-77" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb12-78"><a href="extended-function-example.html#cb12-78" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb12-79"><a href="extended-function-example.html#cb12-79" tabindex="-1"></a>  </span>
<span id="cb12-80"><a href="extended-function-example.html#cb12-80" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb12-81"><a href="extended-function-example.html#cb12-81" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb12-82"><a href="extended-function-example.html#cb12-82" tabindex="-1"></a>  </span>
<span id="cb12-83"><a href="extended-function-example.html#cb12-83" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb12-84"><a href="extended-function-example.html#cb12-84" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb12-85"><a href="extended-function-example.html#cb12-85" tabindex="-1"></a>}</span>
<span id="cb12-86"><a href="extended-function-example.html#cb12-86" tabindex="-1"></a></span>
<span id="cb12-87"><a href="extended-function-example.html#cb12-87" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb12-88"><a href="extended-function-example.html#cb12-88" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-89"><a href="extended-function-example.html#cb12-89" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb12-90"><a href="extended-function-example.html#cb12-90" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb12-91"><a href="extended-function-example.html#cb12-91" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb12-92"><a href="extended-function-example.html#cb12-92" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb12-93"><a href="extended-function-example.html#cb12-93" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb12-94"><a href="extended-function-example.html#cb12-94" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb12-95"><a href="extended-function-example.html#cb12-95" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-96"><a href="extended-function-example.html#cb12-96" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb12-97"><a href="extended-function-example.html#cb12-97" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-98"><a href="extended-function-example.html#cb12-98" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-99"><a href="extended-function-example.html#cb12-99" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb12-100"><a href="extended-function-example.html#cb12-100" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-101"><a href="extended-function-example.html#cb12-101" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-102"><a href="extended-function-example.html#cb12-102" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-103"><a href="extended-function-example.html#cb12-103" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb12-104"><a href="extended-function-example.html#cb12-104" tabindex="-1"></a>  )</span>
<span id="cb12-105"><a href="extended-function-example.html#cb12-105" tabindex="-1"></a>  </span>
<span id="cb12-106"><a href="extended-function-example.html#cb12-106" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb12-107"><a href="extended-function-example.html#cb12-107" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb12-108"><a href="extended-function-example.html#cb12-108" tabindex="-1"></a>  </span>
<span id="cb12-109"><a href="extended-function-example.html#cb12-109" tabindex="-1"></a>  <span class="co"># retrieve linear predictors</span></span>
<span id="cb12-110"><a href="extended-function-example.html#cb12-110" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>),</span>
<span id="cb12-111"><a href="extended-function-example.html#cb12-111" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb12-112"><a href="extended-function-example.html#cb12-112" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb12-113"><a href="extended-function-example.html#cb12-113" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-114"><a href="extended-function-example.html#cb12-114" tabindex="-1"></a>                               })</span>
<span id="cb12-115"><a href="extended-function-example.html#cb12-115" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb12-116"><a href="extended-function-example.html#cb12-116" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb12-117"><a href="extended-function-example.html#cb12-117" tabindex="-1"></a>                                   </span>
<span id="cb12-118"><a href="extended-function-example.html#cb12-118" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb12-119"><a href="extended-function-example.html#cb12-119" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb12-120"><a href="extended-function-example.html#cb12-120" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb12-121"><a href="extended-function-example.html#cb12-121" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb12-122"><a href="extended-function-example.html#cb12-122" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb12-123"><a href="extended-function-example.html#cb12-123" tabindex="-1"></a>  </span>
<span id="cb12-124"><a href="extended-function-example.html#cb12-124" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb12-125"><a href="extended-function-example.html#cb12-125" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb12-126"><a href="extended-function-example.html#cb12-126" tabindex="-1"></a></span>
<span id="cb12-127"><a href="extended-function-example.html#cb12-127" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb12-128"><a href="extended-function-example.html#cb12-128" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb12-129"><a href="extended-function-example.html#cb12-129" tabindex="-1"></a>}</span>
<span id="cb12-130"><a href="extended-function-example.html#cb12-130" tabindex="-1"></a></span>
<span id="cb12-131"><a href="extended-function-example.html#cb12-131" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb12-132"><a href="extended-function-example.html#cb12-132" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-133"><a href="extended-function-example.html#cb12-133" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb12-134"><a href="extended-function-example.html#cb12-134" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb12-135"><a href="extended-function-example.html#cb12-135" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb12-136"><a href="extended-function-example.html#cb12-136" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb12-137"><a href="extended-function-example.html#cb12-137" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb12-138"><a href="extended-function-example.html#cb12-138" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb12-139"><a href="extended-function-example.html#cb12-139" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb12-140"><a href="extended-function-example.html#cb12-140" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-141"><a href="extended-function-example.html#cb12-141" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb12-142"><a href="extended-function-example.html#cb12-142" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-143"><a href="extended-function-example.html#cb12-143" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-144"><a href="extended-function-example.html#cb12-144" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb12-145"><a href="extended-function-example.html#cb12-145" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-146"><a href="extended-function-example.html#cb12-146" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-147"><a href="extended-function-example.html#cb12-147" tabindex="-1"></a>      <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-148"><a href="extended-function-example.html#cb12-148" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb12-149"><a href="extended-function-example.html#cb12-149" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-150"><a href="extended-function-example.html#cb12-150" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-151"><a href="extended-function-example.html#cb12-151" tabindex="-1"></a>      <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb12-152"><a href="extended-function-example.html#cb12-152" tabindex="-1"></a>  )</span>
<span id="cb12-153"><a href="extended-function-example.html#cb12-153" tabindex="-1"></a>  </span>
<span id="cb12-154"><a href="extended-function-example.html#cb12-154" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb12-155"><a href="extended-function-example.html#cb12-155" tabindex="-1"></a>  <span class="co"># Convert to survreg object</span></span>
<span id="cb12-156"><a href="extended-function-example.html#cb12-156" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb12-157"><a href="extended-function-example.html#cb12-157" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb12-158"><a href="extended-function-example.html#cb12-158" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb12-159"><a href="extended-function-example.html#cb12-159" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-160"><a href="extended-function-example.html#cb12-160" tabindex="-1"></a>                             })</span>
<span id="cb12-161"><a href="extended-function-example.html#cb12-161" tabindex="-1"></a>  </span>
<span id="cb12-162"><a href="extended-function-example.html#cb12-162" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb12-163"><a href="extended-function-example.html#cb12-163" tabindex="-1"></a>  <span class="co"># Call survProbBins.survreg() passing converted object</span></span>
<span id="cb12-164"><a href="extended-function-example.html#cb12-164" tabindex="-1"></a>  </span>
<span id="cb12-165"><a href="extended-function-example.html#cb12-165" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb12-166"><a href="extended-function-example.html#cb12-166" tabindex="-1"></a>  <span class="co"># Return `survProbBins.survreg()` value object</span></span>
<span id="cb12-167"><a href="extended-function-example.html#cb12-167" tabindex="-1"></a>}</span>
<span id="cb12-168"><a href="extended-function-example.html#cb12-168" tabindex="-1"></a></span>
<span id="cb12-169"><a href="extended-function-example.html#cb12-169" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb12-170"><a href="extended-function-example.html#cb12-170" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-171"><a href="extended-function-example.html#cb12-171" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-172"><a href="extended-function-example.html#cb12-172" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb12-173"><a href="extended-function-example.html#cb12-173" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb12-174"><a href="extended-function-example.html#cb12-174" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb12-175"><a href="extended-function-example.html#cb12-175" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb12-176"><a href="extended-function-example.html#cb12-176" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb12-177"><a href="extended-function-example.html#cb12-177" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb12-178"><a href="extended-function-example.html#cb12-178" tabindex="-1"></a>    <span class="st">&quot;`predictions` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-179"><a href="extended-function-example.html#cb12-179" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(predictions) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-180"><a href="extended-function-example.html#cb12-180" tabindex="-1"></a>      <span class="fu">is.vector</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(predictions) <span class="sc">!=</span> 0L</span>
<span id="cb12-181"><a href="extended-function-example.html#cb12-181" tabindex="-1"></a>  )</span>
<span id="cb12-182"><a href="extended-function-example.html#cb12-182" tabindex="-1"></a>  </span>
<span id="cb12-183"><a href="extended-function-example.html#cb12-183" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb12-184"><a href="extended-function-example.html#cb12-184" tabindex="-1"></a>  </span>
<span id="cb12-185"><a href="extended-function-example.html#cb12-185" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb12-186"><a href="extended-function-example.html#cb12-186" tabindex="-1"></a>  <span class="co"># Check for non-finite (NA, NaN, Inf) values</span></span>
<span id="cb12-187"><a href="extended-function-example.html#cb12-187" tabindex="-1"></a>  <span class="co"># Reset non-finite values to NA_real_ and tell user</span></span>
<span id="cb12-188"><a href="extended-function-example.html#cb12-188" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb12-189"><a href="extended-function-example.html#cb12-189" tabindex="-1"></a>  <span class="co"># Check for values outside of [0, 1]</span></span>
<span id="cb12-190"><a href="extended-function-example.html#cb12-190" tabindex="-1"></a>  <span class="co"># Reset out of range values to NA_real_ and tell user</span></span>
<span id="cb12-191"><a href="extended-function-example.html#cb12-191" tabindex="-1"></a>  </span>
<span id="cb12-192"><a href="extended-function-example.html#cb12-192" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb12-193"><a href="extended-function-example.html#cb12-193" tabindex="-1"></a>  <span class="co"># Return modified probabilities as an unnamed numeric vector</span></span>
<span id="cb12-194"><a href="extended-function-example.html#cb12-194" tabindex="-1"></a>}</span>
<span id="cb12-195"><a href="extended-function-example.html#cb12-195" tabindex="-1"></a></span>
<span id="cb12-196"><a href="extended-function-example.html#cb12-196" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb12-197"><a href="extended-function-example.html#cb12-197" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-198"><a href="extended-function-example.html#cb12-198" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb12-199"><a href="extended-function-example.html#cb12-199" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb12-200"><a href="extended-function-example.html#cb12-200" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb12-201"><a href="extended-function-example.html#cb12-201" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb12-202"><a href="extended-function-example.html#cb12-202" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb12-203"><a href="extended-function-example.html#cb12-203" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb12-204"><a href="extended-function-example.html#cb12-204" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb12-205"><a href="extended-function-example.html#cb12-205" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb12-206"><a href="extended-function-example.html#cb12-206" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb12-207"><a href="extended-function-example.html#cb12-207" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb12-208"><a href="extended-function-example.html#cb12-208" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb12-209"><a href="extended-function-example.html#cb12-209" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb12-210"><a href="extended-function-example.html#cb12-210" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb12-211"><a href="extended-function-example.html#cb12-211" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb12-212"><a href="extended-function-example.html#cb12-212" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb12-213"><a href="extended-function-example.html#cb12-213" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb12-214"><a href="extended-function-example.html#cb12-214" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb12-215"><a href="extended-function-example.html#cb12-215" tabindex="-1"></a>    <span class="st">&quot;`values` must be a non-empty, numeric vector.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-216"><a href="extended-function-example.html#cb12-216" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(values) <span class="sc">&amp;&amp;</span></span>
<span id="cb12-217"><a href="extended-function-example.html#cb12-217" tabindex="-1"></a>        <span class="fu">length</span>(values) <span class="sc">!=</span> 0L,</span>
<span id="cb12-218"><a href="extended-function-example.html#cb12-218" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector of length &gt; 1.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-219"><a href="extended-function-example.html#cb12-219" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-220"><a href="extended-function-example.html#cb12-220" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(bin.boundaries),</span>
<span id="cb12-221"><a href="extended-function-example.html#cb12-221" tabindex="-1"></a>    <span class="st">&quot;All values in `bin.boundaries` must be unique.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-222"><a href="extended-function-example.html#cb12-222" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(bin.boundaries)),</span>
<span id="cb12-223"><a href="extended-function-example.html#cb12-223" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` cannot contain NA or NaN values.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-224"><a href="extended-function-example.html#cb12-224" tabindex="-1"></a>      <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.nan</span>(bin.boundaries)),</span>
<span id="cb12-225"><a href="extended-function-example.html#cb12-225" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be in increasing order.&quot;</span> <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.unsorted</span>(bin.boundaries),</span>
<span id="cb12-226"><a href="extended-function-example.html#cb12-226" tabindex="-1"></a>    <span class="st">&quot;`values` must be finite and in range of `bin.boundaries`.&quot;</span> <span class="ot">=</span> </span>
<span id="cb12-227"><a href="extended-function-example.html#cb12-227" tabindex="-1"></a>      <span class="fu">all</span>(<span class="fu">is.finite</span>(values)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(values <span class="sc">&gt;=</span> <span class="fu">min</span>(bin.boundaries)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb12-228"><a href="extended-function-example.html#cb12-228" tabindex="-1"></a>      <span class="fu">all</span>(values <span class="sc">&lt;=</span> <span class="fu">max</span>(bin.boundaries))</span>
<span id="cb12-229"><a href="extended-function-example.html#cb12-229" tabindex="-1"></a>  )</span>
<span id="cb12-230"><a href="extended-function-example.html#cb12-230" tabindex="-1"></a>  </span>
<span id="cb12-231"><a href="extended-function-example.html#cb12-231" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb12-232"><a href="extended-function-example.html#cb12-232" tabindex="-1"></a>  </span>
<span id="cb12-233"><a href="extended-function-example.html#cb12-233" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb12-234"><a href="extended-function-example.html#cb12-234" tabindex="-1"></a>  <span class="co"># Identify bin membership based on the provided probabilities</span></span>
<span id="cb12-235"><a href="extended-function-example.html#cb12-235" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each probability bin</span></span>
<span id="cb12-236"><a href="extended-function-example.html#cb12-236" tabindex="-1"></a>  </span>
<span id="cb12-237"><a href="extended-function-example.html#cb12-237" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb12-238"><a href="extended-function-example.html#cb12-238" tabindex="-1"></a>  <span class="co"># Return a list with elements `bin.boundaries`, `bin.id`, and `totals`</span></span>
<span id="cb12-239"><a href="extended-function-example.html#cb12-239" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="task-implementation-1" class="section level3 hasAnchor" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> Task Implementation<a href="extended-function-example.html#task-implementation-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we implement the primary task of each function.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="extended-function-example.html#cb13-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb13-2"><a href="extended-function-example.html#cb13-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-3"><a href="extended-function-example.html#cb13-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb13-4"><a href="extended-function-example.html#cb13-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb13-5"><a href="extended-function-example.html#cb13-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb13-6"><a href="extended-function-example.html#cb13-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb13-7"><a href="extended-function-example.html#cb13-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb13-8"><a href="extended-function-example.html#cb13-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb13-9"><a href="extended-function-example.html#cb13-9" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb13-10"><a href="extended-function-example.html#cb13-10" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb13-11"><a href="extended-function-example.html#cb13-11" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-12"><a href="extended-function-example.html#cb13-12" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb13-13"><a href="extended-function-example.html#cb13-13" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb13-14"><a href="extended-function-example.html#cb13-14" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb13-15"><a href="extended-function-example.html#cb13-15" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb13-16"><a href="extended-function-example.html#cb13-16" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb13-17"><a href="extended-function-example.html#cb13-17" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb13-18"><a href="extended-function-example.html#cb13-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-19"><a href="extended-function-example.html#cb13-19" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb13-20"><a href="extended-function-example.html#cb13-20" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb13-21"><a href="extended-function-example.html#cb13-21" tabindex="-1"></a></span>
<span id="cb13-22"><a href="extended-function-example.html#cb13-22" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb13-23"><a href="extended-function-example.html#cb13-23" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-24"><a href="extended-function-example.html#cb13-24" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb13-25"><a href="extended-function-example.html#cb13-25" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb13-26"><a href="extended-function-example.html#cb13-26" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb13-27"><a href="extended-function-example.html#cb13-27" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-28"><a href="extended-function-example.html#cb13-28" tabindex="-1"></a>}</span>
<span id="cb13-29"><a href="extended-function-example.html#cb13-29" tabindex="-1"></a></span>
<span id="cb13-30"><a href="extended-function-example.html#cb13-30" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb13-31"><a href="extended-function-example.html#cb13-31" tabindex="-1"></a></span>
<span id="cb13-32"><a href="extended-function-example.html#cb13-32" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb13-33"><a href="extended-function-example.html#cb13-33" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-34"><a href="extended-function-example.html#cb13-34" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb13-35"><a href="extended-function-example.html#cb13-35" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb13-36"><a href="extended-function-example.html#cb13-36" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb13-37"><a href="extended-function-example.html#cb13-37" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb13-38"><a href="extended-function-example.html#cb13-38" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb13-39"><a href="extended-function-example.html#cb13-39" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb13-40"><a href="extended-function-example.html#cb13-40" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-41"><a href="extended-function-example.html#cb13-41" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb13-42"><a href="extended-function-example.html#cb13-42" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-43"><a href="extended-function-example.html#cb13-43" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-44"><a href="extended-function-example.html#cb13-44" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb13-45"><a href="extended-function-example.html#cb13-45" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-46"><a href="extended-function-example.html#cb13-46" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb13-47"><a href="extended-function-example.html#cb13-47" tabindex="-1"></a>        <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-48"><a href="extended-function-example.html#cb13-48" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb13-49"><a href="extended-function-example.html#cb13-49" tabindex="-1"></a>  )</span>
<span id="cb13-50"><a href="extended-function-example.html#cb13-50" tabindex="-1"></a>  </span>
<span id="cb13-51"><a href="extended-function-example.html#cb13-51" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb13-52"><a href="extended-function-example.html#cb13-52" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb13-53"><a href="extended-function-example.html#cb13-53" tabindex="-1"></a>  </span>
<span id="cb13-54"><a href="extended-function-example.html#cb13-54" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb13-55"><a href="extended-function-example.html#cb13-55" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb13-56"><a href="extended-function-example.html#cb13-56" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb13-57"><a href="extended-function-example.html#cb13-57" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb13-58"><a href="extended-function-example.html#cb13-58" tabindex="-1"></a>  </span>
<span id="cb13-59"><a href="extended-function-example.html#cb13-59" tabindex="-1"></a>  base_hazard_at_t <span class="ot">&lt;-</span> base_hazard[t_idx, 1L]</span>
<span id="cb13-60"><a href="extended-function-example.html#cb13-60" tabindex="-1"></a>  </span>
<span id="cb13-61"><a href="extended-function-example.html#cb13-61" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb13-62"><a href="extended-function-example.html#cb13-62" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard_at_t) ) {</span>
<span id="cb13-63"><a href="extended-function-example.html#cb13-63" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard_at_t), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-64"><a href="extended-function-example.html#cb13-64" tabindex="-1"></a>  }</span>
<span id="cb13-65"><a href="extended-function-example.html#cb13-65" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb13-66"><a href="extended-function-example.html#cb13-66" tabindex="-1"></a></span>
<span id="cb13-67"><a href="extended-function-example.html#cb13-67" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb13-68"><a href="extended-function-example.html#cb13-68" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb13-69"><a href="extended-function-example.html#cb13-69" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb13-70"><a href="extended-function-example.html#cb13-70" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb13-71"><a href="extended-function-example.html#cb13-71" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-72"><a href="extended-function-example.html#cb13-72" tabindex="-1"></a>                               })</span>
<span id="cb13-73"><a href="extended-function-example.html#cb13-73" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb13-74"><a href="extended-function-example.html#cb13-74" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb13-75"><a href="extended-function-example.html#cb13-75" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb13-76"><a href="extended-function-example.html#cb13-76" tabindex="-1"></a>  </span>
<span id="cb13-77"><a href="extended-function-example.html#cb13-77" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb13-78"><a href="extended-function-example.html#cb13-78" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb13-79"><a href="extended-function-example.html#cb13-79" tabindex="-1"></a>  </span>
<span id="cb13-80"><a href="extended-function-example.html#cb13-80" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb13-81"><a href="extended-function-example.html#cb13-81" tabindex="-1"></a>  </span>
<span id="cb13-82"><a href="extended-function-example.html#cb13-82" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb13-83"><a href="extended-function-example.html#cb13-83" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb13-84"><a href="extended-function-example.html#cb13-84" tabindex="-1"></a>  </span>
<span id="cb13-85"><a href="extended-function-example.html#cb13-85" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb13-86"><a href="extended-function-example.html#cb13-86" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb13-87"><a href="extended-function-example.html#cb13-87" tabindex="-1"></a>}</span>
<span id="cb13-88"><a href="extended-function-example.html#cb13-88" tabindex="-1"></a></span>
<span id="cb13-89"><a href="extended-function-example.html#cb13-89" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb13-90"><a href="extended-function-example.html#cb13-90" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-91"><a href="extended-function-example.html#cb13-91" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb13-92"><a href="extended-function-example.html#cb13-92" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb13-93"><a href="extended-function-example.html#cb13-93" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb13-94"><a href="extended-function-example.html#cb13-94" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb13-95"><a href="extended-function-example.html#cb13-95" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb13-96"><a href="extended-function-example.html#cb13-96" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb13-97"><a href="extended-function-example.html#cb13-97" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-98"><a href="extended-function-example.html#cb13-98" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb13-99"><a href="extended-function-example.html#cb13-99" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-100"><a href="extended-function-example.html#cb13-100" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-101"><a href="extended-function-example.html#cb13-101" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb13-102"><a href="extended-function-example.html#cb13-102" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-103"><a href="extended-function-example.html#cb13-103" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb13-104"><a href="extended-function-example.html#cb13-104" tabindex="-1"></a>        <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-105"><a href="extended-function-example.html#cb13-105" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb13-106"><a href="extended-function-example.html#cb13-106" tabindex="-1"></a>  )</span>
<span id="cb13-107"><a href="extended-function-example.html#cb13-107" tabindex="-1"></a>  </span>
<span id="cb13-108"><a href="extended-function-example.html#cb13-108" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb13-109"><a href="extended-function-example.html#cb13-109" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb13-110"><a href="extended-function-example.html#cb13-110" tabindex="-1"></a>  </span>
<span id="cb13-111"><a href="extended-function-example.html#cb13-111" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb13-112"><a href="extended-function-example.html#cb13-112" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb13-113"><a href="extended-function-example.html#cb13-113" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb13-114"><a href="extended-function-example.html#cb13-114" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-115"><a href="extended-function-example.html#cb13-115" tabindex="-1"></a>                               })</span>
<span id="cb13-116"><a href="extended-function-example.html#cb13-116" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb13-117"><a href="extended-function-example.html#cb13-117" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb13-118"><a href="extended-function-example.html#cb13-118" tabindex="-1"></a>                                   </span>
<span id="cb13-119"><a href="extended-function-example.html#cb13-119" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb13-120"><a href="extended-function-example.html#cb13-120" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb13-121"><a href="extended-function-example.html#cb13-121" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb13-122"><a href="extended-function-example.html#cb13-122" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb13-123"><a href="extended-function-example.html#cb13-123" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb13-124"><a href="extended-function-example.html#cb13-124" tabindex="-1"></a>  </span>
<span id="cb13-125"><a href="extended-function-example.html#cb13-125" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb13-126"><a href="extended-function-example.html#cb13-126" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb13-127"><a href="extended-function-example.html#cb13-127" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb13-128"><a href="extended-function-example.html#cb13-128" tabindex="-1"></a>  </span>
<span id="cb13-129"><a href="extended-function-example.html#cb13-129" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb13-130"><a href="extended-function-example.html#cb13-130" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb13-131"><a href="extended-function-example.html#cb13-131" tabindex="-1"></a>}</span>
<span id="cb13-132"><a href="extended-function-example.html#cb13-132" tabindex="-1"></a></span>
<span id="cb13-133"><a href="extended-function-example.html#cb13-133" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb13-134"><a href="extended-function-example.html#cb13-134" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-135"><a href="extended-function-example.html#cb13-135" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb13-136"><a href="extended-function-example.html#cb13-136" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb13-137"><a href="extended-function-example.html#cb13-137" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb13-138"><a href="extended-function-example.html#cb13-138" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb13-139"><a href="extended-function-example.html#cb13-139" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb13-140"><a href="extended-function-example.html#cb13-140" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb13-141"><a href="extended-function-example.html#cb13-141" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb13-142"><a href="extended-function-example.html#cb13-142" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-143"><a href="extended-function-example.html#cb13-143" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb13-144"><a href="extended-function-example.html#cb13-144" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-145"><a href="extended-function-example.html#cb13-145" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-146"><a href="extended-function-example.html#cb13-146" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb13-147"><a href="extended-function-example.html#cb13-147" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-148"><a href="extended-function-example.html#cb13-148" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb13-149"><a href="extended-function-example.html#cb13-149" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-150"><a href="extended-function-example.html#cb13-150" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb13-151"><a href="extended-function-example.html#cb13-151" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-152"><a href="extended-function-example.html#cb13-152" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-153"><a href="extended-function-example.html#cb13-153" tabindex="-1"></a>      <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb13-154"><a href="extended-function-example.html#cb13-154" tabindex="-1"></a>  )</span>
<span id="cb13-155"><a href="extended-function-example.html#cb13-155" tabindex="-1"></a>  </span>
<span id="cb13-156"><a href="extended-function-example.html#cb13-156" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb13-157"><a href="extended-function-example.html#cb13-157" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb13-158"><a href="extended-function-example.html#cb13-158" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb13-159"><a href="extended-function-example.html#cb13-159" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb13-160"><a href="extended-function-example.html#cb13-160" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb13-161"><a href="extended-function-example.html#cb13-161" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-162"><a href="extended-function-example.html#cb13-162" tabindex="-1"></a>                             })</span>
<span id="cb13-163"><a href="extended-function-example.html#cb13-163" tabindex="-1"></a>  </span>
<span id="cb13-164"><a href="extended-function-example.html#cb13-164" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb13-165"><a href="extended-function-example.html#cb13-165" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">survProbBins</span>(survreg_object, newdata, eval.time, bin.boundaries, ...)</span>
<span id="cb13-166"><a href="extended-function-example.html#cb13-166" tabindex="-1"></a></span>
<span id="cb13-167"><a href="extended-function-example.html#cb13-167" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb13-168"><a href="extended-function-example.html#cb13-168" tabindex="-1"></a>  <span class="co"># Return `survProbBins.survreg()` value object</span></span>
<span id="cb13-169"><a href="extended-function-example.html#cb13-169" tabindex="-1"></a>}</span>
<span id="cb13-170"><a href="extended-function-example.html#cb13-170" tabindex="-1"></a></span>
<span id="cb13-171"><a href="extended-function-example.html#cb13-171" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb13-172"><a href="extended-function-example.html#cb13-172" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-173"><a href="extended-function-example.html#cb13-173" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-174"><a href="extended-function-example.html#cb13-174" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb13-175"><a href="extended-function-example.html#cb13-175" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb13-176"><a href="extended-function-example.html#cb13-176" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb13-177"><a href="extended-function-example.html#cb13-177" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb13-178"><a href="extended-function-example.html#cb13-178" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb13-179"><a href="extended-function-example.html#cb13-179" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb13-180"><a href="extended-function-example.html#cb13-180" tabindex="-1"></a>    <span class="st">&quot;`predictions` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-181"><a href="extended-function-example.html#cb13-181" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(predictions) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-182"><a href="extended-function-example.html#cb13-182" tabindex="-1"></a>      <span class="fu">is.vector</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(predictions) <span class="sc">!=</span> 0L</span>
<span id="cb13-183"><a href="extended-function-example.html#cb13-183" tabindex="-1"></a>  )</span>
<span id="cb13-184"><a href="extended-function-example.html#cb13-184" tabindex="-1"></a>  </span>
<span id="cb13-185"><a href="extended-function-example.html#cb13-185" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb13-186"><a href="extended-function-example.html#cb13-186" tabindex="-1"></a>  </span>
<span id="cb13-187"><a href="extended-function-example.html#cb13-187" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb13-188"><a href="extended-function-example.html#cb13-188" tabindex="-1"></a>  <span class="co"># convert non-finite (NA, NaN, Inf) values to NA_real_</span></span>
<span id="cb13-189"><a href="extended-function-example.html#cb13-189" tabindex="-1"></a>  <span class="co"># convert values outside of [0, 1] to NA_real_</span></span>
<span id="cb13-190"><a href="extended-function-example.html#cb13-190" tabindex="-1"></a>  bad_values <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.finite</span>(predictions) <span class="sc">|</span> predictions <span class="sc">&lt;</span> <span class="fl">0.0</span> <span class="sc">|</span> predictions <span class="sc">&gt;</span> <span class="fl">1.0</span></span>
<span id="cb13-191"><a href="extended-function-example.html#cb13-191" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="fu">any</span>(bad_values) ) {</span>
<span id="cb13-192"><a href="extended-function-example.html#cb13-192" tabindex="-1"></a>    predictions[bad_values] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb13-193"><a href="extended-function-example.html#cb13-193" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">value</span>(<span class="fu">sum</span>(bad_value)), <span class="st">&quot; invalid probabilities have been set to NA.&quot;</span>)</span>
<span id="cb13-194"><a href="extended-function-example.html#cb13-194" tabindex="-1"></a>  }</span>
<span id="cb13-195"><a href="extended-function-example.html#cb13-195" tabindex="-1"></a>  </span>
<span id="cb13-196"><a href="extended-function-example.html#cb13-196" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb13-197"><a href="extended-function-example.html#cb13-197" tabindex="-1"></a>  <span class="co"># Return modified probabilities as an unnamed numeric vector</span></span>
<span id="cb13-198"><a href="extended-function-example.html#cb13-198" tabindex="-1"></a>}</span>
<span id="cb13-199"><a href="extended-function-example.html#cb13-199" tabindex="-1"></a></span>
<span id="cb13-200"><a href="extended-function-example.html#cb13-200" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb13-201"><a href="extended-function-example.html#cb13-201" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-202"><a href="extended-function-example.html#cb13-202" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb13-203"><a href="extended-function-example.html#cb13-203" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb13-204"><a href="extended-function-example.html#cb13-204" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb13-205"><a href="extended-function-example.html#cb13-205" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb13-206"><a href="extended-function-example.html#cb13-206" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb13-207"><a href="extended-function-example.html#cb13-207" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb13-208"><a href="extended-function-example.html#cb13-208" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb13-209"><a href="extended-function-example.html#cb13-209" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb13-210"><a href="extended-function-example.html#cb13-210" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb13-211"><a href="extended-function-example.html#cb13-211" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb13-212"><a href="extended-function-example.html#cb13-212" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb13-213"><a href="extended-function-example.html#cb13-213" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb13-214"><a href="extended-function-example.html#cb13-214" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb13-215"><a href="extended-function-example.html#cb13-215" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb13-216"><a href="extended-function-example.html#cb13-216" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb13-217"><a href="extended-function-example.html#cb13-217" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb13-218"><a href="extended-function-example.html#cb13-218" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb13-219"><a href="extended-function-example.html#cb13-219" tabindex="-1"></a>    <span class="st">&quot;`values` must be a non-empty, numeric vector.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-220"><a href="extended-function-example.html#cb13-220" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(values) <span class="sc">&amp;&amp;</span></span>
<span id="cb13-221"><a href="extended-function-example.html#cb13-221" tabindex="-1"></a>        <span class="fu">length</span>(values) <span class="sc">!=</span> 0L,</span>
<span id="cb13-222"><a href="extended-function-example.html#cb13-222" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector of length &gt; 1.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-223"><a href="extended-function-example.html#cb13-223" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-224"><a href="extended-function-example.html#cb13-224" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(bin.boundaries),</span>
<span id="cb13-225"><a href="extended-function-example.html#cb13-225" tabindex="-1"></a>    <span class="st">&quot;All values in `bin.boundaries` must be unique.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-226"><a href="extended-function-example.html#cb13-226" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(bin.boundaries)),</span>
<span id="cb13-227"><a href="extended-function-example.html#cb13-227" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` cannot contain NA or NaN values.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-228"><a href="extended-function-example.html#cb13-228" tabindex="-1"></a>      <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.nan</span>(bin.boundaries)),</span>
<span id="cb13-229"><a href="extended-function-example.html#cb13-229" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be in increasing order.&quot;</span> <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.unsorted</span>(bin.boundaries),</span>
<span id="cb13-230"><a href="extended-function-example.html#cb13-230" tabindex="-1"></a>    <span class="st">&quot;`values` must be finite and in range of `bin.boundaries`.&quot;</span> <span class="ot">=</span> </span>
<span id="cb13-231"><a href="extended-function-example.html#cb13-231" tabindex="-1"></a>      <span class="fu">all</span>(<span class="fu">is.finite</span>(values)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(values <span class="sc">&gt;=</span> <span class="fu">min</span>(bin.boundaries)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb13-232"><a href="extended-function-example.html#cb13-232" tabindex="-1"></a>      <span class="fu">all</span>(values <span class="sc">&lt;=</span> <span class="fu">max</span>(bin.boundaries))</span>
<span id="cb13-233"><a href="extended-function-example.html#cb13-233" tabindex="-1"></a>  )</span>
<span id="cb13-234"><a href="extended-function-example.html#cb13-234" tabindex="-1"></a>  </span>
<span id="cb13-235"><a href="extended-function-example.html#cb13-235" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb13-236"><a href="extended-function-example.html#cb13-236" tabindex="-1"></a>  </span>
<span id="cb13-237"><a href="extended-function-example.html#cb13-237" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb13-238"><a href="extended-function-example.html#cb13-238" tabindex="-1"></a>  <span class="co"># Identify bin membership based on the provided probabilities</span></span>
<span id="cb13-239"><a href="extended-function-example.html#cb13-239" tabindex="-1"></a>  <span class="co"># returns k satisfying bin_k &lt;= x &lt; bin_{k+1}</span></span>
<span id="cb13-240"><a href="extended-function-example.html#cb13-240" tabindex="-1"></a>  <span class="co"># all.inside = TRUE sets anything that does not fall with the</span></span>
<span id="cb13-241"><a href="extended-function-example.html#cb13-241" tabindex="-1"></a>  <span class="co"># range of bin.boundaries to the nearest bin </span></span>
<span id="cb13-242"><a href="extended-function-example.html#cb13-242" tabindex="-1"></a>  <span class="co"># (i.e., 1 if x &lt; bin_1 or K if x &gt;= bin_K)</span></span>
<span id="cb13-243"><a href="extended-function-example.html#cb13-243" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(values, bin.boundaries, <span class="at">all.inside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-244"><a href="extended-function-example.html#cb13-244" tabindex="-1"></a>  </span>
<span id="cb13-245"><a href="extended-function-example.html#cb13-245" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each probability bin</span></span>
<span id="cb13-246"><a href="extended-function-example.html#cb13-246" tabindex="-1"></a>  totals        <span class="ot">&lt;-</span> <span class="fu">tabulate</span>(bins)</span>
<span id="cb13-247"><a href="extended-function-example.html#cb13-247" tabindex="-1"></a>  <span class="fu">names</span>(totals) <span class="ot">&lt;-</span> 1L<span class="sc">:</span>(<span class="fu">length</span>(bins)<span class="sc">-</span>1L)</span>
<span id="cb13-248"><a href="extended-function-example.html#cb13-248" tabindex="-1"></a>  </span>
<span id="cb13-249"><a href="extended-function-example.html#cb13-249" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb13-250"><a href="extended-function-example.html#cb13-250" tabindex="-1"></a>  <span class="co"># Return a list with elements `bin.boundaries`, `bin.id`, and `totals`</span></span>
<span id="cb13-251"><a href="extended-function-example.html#cb13-251" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="results-construction-and-testing" class="section level3 hasAnchor" number="2.3.5">
<h3><span class="header-section-number">2.3.5</span> Results Construction and Testing<a href="extended-function-example.html#results-construction-and-testing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="extended-function-example.html#cb14-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb14-2"><a href="extended-function-example.html#cb14-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-3"><a href="extended-function-example.html#cb14-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb14-4"><a href="extended-function-example.html#cb14-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb14-5"><a href="extended-function-example.html#cb14-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb14-6"><a href="extended-function-example.html#cb14-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb14-7"><a href="extended-function-example.html#cb14-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb14-8"><a href="extended-function-example.html#cb14-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb14-9"><a href="extended-function-example.html#cb14-9" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb14-10"><a href="extended-function-example.html#cb14-10" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb14-11"><a href="extended-function-example.html#cb14-11" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-12"><a href="extended-function-example.html#cb14-12" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb14-13"><a href="extended-function-example.html#cb14-13" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb14-14"><a href="extended-function-example.html#cb14-14" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb14-15"><a href="extended-function-example.html#cb14-15" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb14-16"><a href="extended-function-example.html#cb14-16" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb14-17"><a href="extended-function-example.html#cb14-17" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb14-18"><a href="extended-function-example.html#cb14-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-19"><a href="extended-function-example.html#cb14-19" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-20"><a href="extended-function-example.html#cb14-20" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb14-21"><a href="extended-function-example.html#cb14-21" tabindex="-1"></a></span>
<span id="cb14-22"><a href="extended-function-example.html#cb14-22" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb14-23"><a href="extended-function-example.html#cb14-23" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-24"><a href="extended-function-example.html#cb14-24" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-25"><a href="extended-function-example.html#cb14-25" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb14-26"><a href="extended-function-example.html#cb14-26" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb14-27"><a href="extended-function-example.html#cb14-27" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-28"><a href="extended-function-example.html#cb14-28" tabindex="-1"></a>}</span>
<span id="cb14-29"><a href="extended-function-example.html#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="extended-function-example.html#cb14-30" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb14-31"><a href="extended-function-example.html#cb14-31" tabindex="-1"></a></span>
<span id="cb14-32"><a href="extended-function-example.html#cb14-32" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb14-33"><a href="extended-function-example.html#cb14-33" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-34"><a href="extended-function-example.html#cb14-34" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-35"><a href="extended-function-example.html#cb14-35" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb14-36"><a href="extended-function-example.html#cb14-36" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb14-37"><a href="extended-function-example.html#cb14-37" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb14-38"><a href="extended-function-example.html#cb14-38" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb14-39"><a href="extended-function-example.html#cb14-39" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb14-40"><a href="extended-function-example.html#cb14-40" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-41"><a href="extended-function-example.html#cb14-41" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb14-42"><a href="extended-function-example.html#cb14-42" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-43"><a href="extended-function-example.html#cb14-43" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-44"><a href="extended-function-example.html#cb14-44" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb14-45"><a href="extended-function-example.html#cb14-45" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-46"><a href="extended-function-example.html#cb14-46" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb14-47"><a href="extended-function-example.html#cb14-47" tabindex="-1"></a>        <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-48"><a href="extended-function-example.html#cb14-48" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb14-49"><a href="extended-function-example.html#cb14-49" tabindex="-1"></a>  )</span>
<span id="cb14-50"><a href="extended-function-example.html#cb14-50" tabindex="-1"></a>  </span>
<span id="cb14-51"><a href="extended-function-example.html#cb14-51" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb14-52"><a href="extended-function-example.html#cb14-52" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb14-53"><a href="extended-function-example.html#cb14-53" tabindex="-1"></a>  </span>
<span id="cb14-54"><a href="extended-function-example.html#cb14-54" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb14-55"><a href="extended-function-example.html#cb14-55" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb14-56"><a href="extended-function-example.html#cb14-56" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb14-57"><a href="extended-function-example.html#cb14-57" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb14-58"><a href="extended-function-example.html#cb14-58" tabindex="-1"></a>  </span>
<span id="cb14-59"><a href="extended-function-example.html#cb14-59" tabindex="-1"></a>  base_hazard_at_t <span class="ot">&lt;-</span> base_hazard[t_idx, 1L]</span>
<span id="cb14-60"><a href="extended-function-example.html#cb14-60" tabindex="-1"></a>  </span>
<span id="cb14-61"><a href="extended-function-example.html#cb14-61" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb14-62"><a href="extended-function-example.html#cb14-62" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard_at_t) ) {</span>
<span id="cb14-63"><a href="extended-function-example.html#cb14-63" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard_at_t), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-64"><a href="extended-function-example.html#cb14-64" tabindex="-1"></a>  }</span>
<span id="cb14-65"><a href="extended-function-example.html#cb14-65" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb14-66"><a href="extended-function-example.html#cb14-66" tabindex="-1"></a></span>
<span id="cb14-67"><a href="extended-function-example.html#cb14-67" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb14-68"><a href="extended-function-example.html#cb14-68" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb14-69"><a href="extended-function-example.html#cb14-69" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-70"><a href="extended-function-example.html#cb14-70" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb14-71"><a href="extended-function-example.html#cb14-71" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-72"><a href="extended-function-example.html#cb14-72" tabindex="-1"></a>                               })</span>
<span id="cb14-73"><a href="extended-function-example.html#cb14-73" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb14-74"><a href="extended-function-example.html#cb14-74" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb14-75"><a href="extended-function-example.html#cb14-75" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb14-76"><a href="extended-function-example.html#cb14-76" tabindex="-1"></a>  </span>
<span id="cb14-77"><a href="extended-function-example.html#cb14-77" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb14-78"><a href="extended-function-example.html#cb14-78" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb14-79"><a href="extended-function-example.html#cb14-79" tabindex="-1"></a>  </span>
<span id="cb14-80"><a href="extended-function-example.html#cb14-80" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb14-81"><a href="extended-function-example.html#cb14-81" tabindex="-1"></a>  </span>
<span id="cb14-82"><a href="extended-function-example.html#cb14-82" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb14-83"><a href="extended-function-example.html#cb14-83" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb14-84"><a href="extended-function-example.html#cb14-84" tabindex="-1"></a>  </span>
<span id="cb14-85"><a href="extended-function-example.html#cb14-85" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb14-86"><a href="extended-function-example.html#cb14-86" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb14-87"><a href="extended-function-example.html#cb14-87" tabindex="-1"></a>  result</span>
<span id="cb14-88"><a href="extended-function-example.html#cb14-88" tabindex="-1"></a>}</span>
<span id="cb14-89"><a href="extended-function-example.html#cb14-89" tabindex="-1"></a></span>
<span id="cb14-90"><a href="extended-function-example.html#cb14-90" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb14-91"><a href="extended-function-example.html#cb14-91" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-92"><a href="extended-function-example.html#cb14-92" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-93"><a href="extended-function-example.html#cb14-93" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb14-94"><a href="extended-function-example.html#cb14-94" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb14-95"><a href="extended-function-example.html#cb14-95" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb14-96"><a href="extended-function-example.html#cb14-96" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb14-97"><a href="extended-function-example.html#cb14-97" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb14-98"><a href="extended-function-example.html#cb14-98" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-99"><a href="extended-function-example.html#cb14-99" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb14-100"><a href="extended-function-example.html#cb14-100" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-101"><a href="extended-function-example.html#cb14-101" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-102"><a href="extended-function-example.html#cb14-102" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb14-103"><a href="extended-function-example.html#cb14-103" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-104"><a href="extended-function-example.html#cb14-104" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb14-105"><a href="extended-function-example.html#cb14-105" tabindex="-1"></a>        <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-106"><a href="extended-function-example.html#cb14-106" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb14-107"><a href="extended-function-example.html#cb14-107" tabindex="-1"></a>  )</span>
<span id="cb14-108"><a href="extended-function-example.html#cb14-108" tabindex="-1"></a>  </span>
<span id="cb14-109"><a href="extended-function-example.html#cb14-109" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb14-110"><a href="extended-function-example.html#cb14-110" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb14-111"><a href="extended-function-example.html#cb14-111" tabindex="-1"></a>  </span>
<span id="cb14-112"><a href="extended-function-example.html#cb14-112" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb14-113"><a href="extended-function-example.html#cb14-113" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-114"><a href="extended-function-example.html#cb14-114" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb14-115"><a href="extended-function-example.html#cb14-115" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-116"><a href="extended-function-example.html#cb14-116" tabindex="-1"></a>                               })</span>
<span id="cb14-117"><a href="extended-function-example.html#cb14-117" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb14-118"><a href="extended-function-example.html#cb14-118" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb14-119"><a href="extended-function-example.html#cb14-119" tabindex="-1"></a>                                   </span>
<span id="cb14-120"><a href="extended-function-example.html#cb14-120" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb14-121"><a href="extended-function-example.html#cb14-121" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb14-122"><a href="extended-function-example.html#cb14-122" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb14-123"><a href="extended-function-example.html#cb14-123" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb14-124"><a href="extended-function-example.html#cb14-124" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb14-125"><a href="extended-function-example.html#cb14-125" tabindex="-1"></a>  </span>
<span id="cb14-126"><a href="extended-function-example.html#cb14-126" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb14-127"><a href="extended-function-example.html#cb14-127" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb14-128"><a href="extended-function-example.html#cb14-128" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb14-129"><a href="extended-function-example.html#cb14-129" tabindex="-1"></a>  </span>
<span id="cb14-130"><a href="extended-function-example.html#cb14-130" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb14-131"><a href="extended-function-example.html#cb14-131" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb14-132"><a href="extended-function-example.html#cb14-132" tabindex="-1"></a>  result</span>
<span id="cb14-133"><a href="extended-function-example.html#cb14-133" tabindex="-1"></a>}</span>
<span id="cb14-134"><a href="extended-function-example.html#cb14-134" tabindex="-1"></a></span>
<span id="cb14-135"><a href="extended-function-example.html#cb14-135" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb14-136"><a href="extended-function-example.html#cb14-136" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-137"><a href="extended-function-example.html#cb14-137" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-138"><a href="extended-function-example.html#cb14-138" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb14-139"><a href="extended-function-example.html#cb14-139" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb14-140"><a href="extended-function-example.html#cb14-140" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb14-141"><a href="extended-function-example.html#cb14-141" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb14-142"><a href="extended-function-example.html#cb14-142" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb14-143"><a href="extended-function-example.html#cb14-143" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb14-144"><a href="extended-function-example.html#cb14-144" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-145"><a href="extended-function-example.html#cb14-145" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata),</span>
<span id="cb14-146"><a href="extended-function-example.html#cb14-146" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-147"><a href="extended-function-example.html#cb14-147" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-148"><a href="extended-function-example.html#cb14-148" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb14-149"><a href="extended-function-example.html#cb14-149" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-150"><a href="extended-function-example.html#cb14-150" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span></span>
<span id="cb14-151"><a href="extended-function-example.html#cb14-151" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-152"><a href="extended-function-example.html#cb14-152" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb14-153"><a href="extended-function-example.html#cb14-153" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-154"><a href="extended-function-example.html#cb14-154" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-155"><a href="extended-function-example.html#cb14-155" tabindex="-1"></a>      <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb14-156"><a href="extended-function-example.html#cb14-156" tabindex="-1"></a>  )</span>
<span id="cb14-157"><a href="extended-function-example.html#cb14-157" tabindex="-1"></a>  </span>
<span id="cb14-158"><a href="extended-function-example.html#cb14-158" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb14-159"><a href="extended-function-example.html#cb14-159" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb14-160"><a href="extended-function-example.html#cb14-160" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb14-161"><a href="extended-function-example.html#cb14-161" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-162"><a href="extended-function-example.html#cb14-162" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb14-163"><a href="extended-function-example.html#cb14-163" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-164"><a href="extended-function-example.html#cb14-164" tabindex="-1"></a>                             })</span>
<span id="cb14-165"><a href="extended-function-example.html#cb14-165" tabindex="-1"></a>  </span>
<span id="cb14-166"><a href="extended-function-example.html#cb14-166" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb14-167"><a href="extended-function-example.html#cb14-167" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">survProbBins</span>(survreg_object, newdata, eval.time, bin.boundaries, ...)</span>
<span id="cb14-168"><a href="extended-function-example.html#cb14-168" tabindex="-1"></a></span>
<span id="cb14-169"><a href="extended-function-example.html#cb14-169" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb14-170"><a href="extended-function-example.html#cb14-170" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb14-171"><a href="extended-function-example.html#cb14-171" tabindex="-1"></a>  result</span>
<span id="cb14-172"><a href="extended-function-example.html#cb14-172" tabindex="-1"></a>}</span>
<span id="cb14-173"><a href="extended-function-example.html#cb14-173" tabindex="-1"></a></span>
<span id="cb14-174"><a href="extended-function-example.html#cb14-174" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb14-175"><a href="extended-function-example.html#cb14-175" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-176"><a href="extended-function-example.html#cb14-176" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-177"><a href="extended-function-example.html#cb14-177" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb14-178"><a href="extended-function-example.html#cb14-178" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb14-179"><a href="extended-function-example.html#cb14-179" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb14-180"><a href="extended-function-example.html#cb14-180" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb14-181"><a href="extended-function-example.html#cb14-181" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb14-182"><a href="extended-function-example.html#cb14-182" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb14-183"><a href="extended-function-example.html#cb14-183" tabindex="-1"></a>    <span class="st">&quot;`predictions` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-184"><a href="extended-function-example.html#cb14-184" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(predictions) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-185"><a href="extended-function-example.html#cb14-185" tabindex="-1"></a>      <span class="fu">is.vector</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(predictions) <span class="sc">!=</span> 0L</span>
<span id="cb14-186"><a href="extended-function-example.html#cb14-186" tabindex="-1"></a>  )</span>
<span id="cb14-187"><a href="extended-function-example.html#cb14-187" tabindex="-1"></a>  </span>
<span id="cb14-188"><a href="extended-function-example.html#cb14-188" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb14-189"><a href="extended-function-example.html#cb14-189" tabindex="-1"></a>  </span>
<span id="cb14-190"><a href="extended-function-example.html#cb14-190" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb14-191"><a href="extended-function-example.html#cb14-191" tabindex="-1"></a>  <span class="co"># convert non-finite (NA, NaN, Inf) values to NA_real_</span></span>
<span id="cb14-192"><a href="extended-function-example.html#cb14-192" tabindex="-1"></a>  <span class="co"># convert values outside of [0, 1] to NA_real_</span></span>
<span id="cb14-193"><a href="extended-function-example.html#cb14-193" tabindex="-1"></a>  bad_values <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.finite</span>(predictions) <span class="sc">|</span> predictions <span class="sc">&lt;</span> <span class="fl">0.0</span> <span class="sc">|</span> predictions <span class="sc">&gt;</span> <span class="fl">1.0</span></span>
<span id="cb14-194"><a href="extended-function-example.html#cb14-194" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="fu">any</span>(bad_values) ) {</span>
<span id="cb14-195"><a href="extended-function-example.html#cb14-195" tabindex="-1"></a>    predictions[bad_values] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb14-196"><a href="extended-function-example.html#cb14-196" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">value</span>(<span class="fu">sum</span>(bad_value)), <span class="st">&quot; invalid probabilities have been set to NA.&quot;</span>)</span>
<span id="cb14-197"><a href="extended-function-example.html#cb14-197" tabindex="-1"></a>  }</span>
<span id="cb14-198"><a href="extended-function-example.html#cb14-198" tabindex="-1"></a>  </span>
<span id="cb14-199"><a href="extended-function-example.html#cb14-199" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb14-200"><a href="extended-function-example.html#cb14-200" tabindex="-1"></a>  predictions</span>
<span id="cb14-201"><a href="extended-function-example.html#cb14-201" tabindex="-1"></a>}</span>
<span id="cb14-202"><a href="extended-function-example.html#cb14-202" tabindex="-1"></a></span>
<span id="cb14-203"><a href="extended-function-example.html#cb14-203" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb14-204"><a href="extended-function-example.html#cb14-204" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-205"><a href="extended-function-example.html#cb14-205" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb14-206"><a href="extended-function-example.html#cb14-206" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb14-207"><a href="extended-function-example.html#cb14-207" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb14-208"><a href="extended-function-example.html#cb14-208" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb14-209"><a href="extended-function-example.html#cb14-209" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb14-210"><a href="extended-function-example.html#cb14-210" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb14-211"><a href="extended-function-example.html#cb14-211" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb14-212"><a href="extended-function-example.html#cb14-212" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb14-213"><a href="extended-function-example.html#cb14-213" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb14-214"><a href="extended-function-example.html#cb14-214" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb14-215"><a href="extended-function-example.html#cb14-215" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb14-216"><a href="extended-function-example.html#cb14-216" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb14-217"><a href="extended-function-example.html#cb14-217" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-218"><a href="extended-function-example.html#cb14-218" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb14-219"><a href="extended-function-example.html#cb14-219" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb14-220"><a href="extended-function-example.html#cb14-220" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb14-221"><a href="extended-function-example.html#cb14-221" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb14-222"><a href="extended-function-example.html#cb14-222" tabindex="-1"></a>    <span class="st">&quot;`values` must be a non-empty, numeric vector.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-223"><a href="extended-function-example.html#cb14-223" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(values) <span class="sc">&amp;&amp;</span></span>
<span id="cb14-224"><a href="extended-function-example.html#cb14-224" tabindex="-1"></a>        <span class="fu">length</span>(values) <span class="sc">!=</span> 0L,</span>
<span id="cb14-225"><a href="extended-function-example.html#cb14-225" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector of length &gt; 1.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-226"><a href="extended-function-example.html#cb14-226" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-227"><a href="extended-function-example.html#cb14-227" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(bin.boundaries),</span>
<span id="cb14-228"><a href="extended-function-example.html#cb14-228" tabindex="-1"></a>    <span class="st">&quot;All values in `bin.boundaries` must be unique.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-229"><a href="extended-function-example.html#cb14-229" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(bin.boundaries)),</span>
<span id="cb14-230"><a href="extended-function-example.html#cb14-230" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` cannot contain NA or NaN values.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-231"><a href="extended-function-example.html#cb14-231" tabindex="-1"></a>      <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.nan</span>(bin.boundaries)),</span>
<span id="cb14-232"><a href="extended-function-example.html#cb14-232" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be in increasing order.&quot;</span> <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.unsorted</span>(bin.boundaries),</span>
<span id="cb14-233"><a href="extended-function-example.html#cb14-233" tabindex="-1"></a>    <span class="st">&quot;`values` must be finite and in range of `bin.boundaries`.&quot;</span> <span class="ot">=</span> </span>
<span id="cb14-234"><a href="extended-function-example.html#cb14-234" tabindex="-1"></a>      <span class="fu">all</span>(<span class="fu">is.finite</span>(values)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(values <span class="sc">&gt;=</span> <span class="fu">min</span>(bin.boundaries)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb14-235"><a href="extended-function-example.html#cb14-235" tabindex="-1"></a>      <span class="fu">all</span>(values <span class="sc">&lt;=</span> <span class="fu">max</span>(bin.boundaries))</span>
<span id="cb14-236"><a href="extended-function-example.html#cb14-236" tabindex="-1"></a>  )</span>
<span id="cb14-237"><a href="extended-function-example.html#cb14-237" tabindex="-1"></a>  </span>
<span id="cb14-238"><a href="extended-function-example.html#cb14-238" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb14-239"><a href="extended-function-example.html#cb14-239" tabindex="-1"></a>  </span>
<span id="cb14-240"><a href="extended-function-example.html#cb14-240" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb14-241"><a href="extended-function-example.html#cb14-241" tabindex="-1"></a>  <span class="co"># Identify bin membership based on the provided probabilities</span></span>
<span id="cb14-242"><a href="extended-function-example.html#cb14-242" tabindex="-1"></a>  <span class="co"># returns k satisfying bin_k &lt;= x &lt; bin_{k+1}</span></span>
<span id="cb14-243"><a href="extended-function-example.html#cb14-243" tabindex="-1"></a>  <span class="co"># all.inside = TRUE sets anything that does not fall with the</span></span>
<span id="cb14-244"><a href="extended-function-example.html#cb14-244" tabindex="-1"></a>  <span class="co"># range of bin.boundaries to the nearest bin </span></span>
<span id="cb14-245"><a href="extended-function-example.html#cb14-245" tabindex="-1"></a>  <span class="co"># (i.e., 1 if x &lt; bin_1 or K if x &gt; bin_K)</span></span>
<span id="cb14-246"><a href="extended-function-example.html#cb14-246" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(values, bin.boundaries, <span class="at">all.inside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-247"><a href="extended-function-example.html#cb14-247" tabindex="-1"></a>  </span>
<span id="cb14-248"><a href="extended-function-example.html#cb14-248" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each probability bin</span></span>
<span id="cb14-249"><a href="extended-function-example.html#cb14-249" tabindex="-1"></a>  totals        <span class="ot">&lt;-</span> <span class="fu">tabulate</span>(bins)</span>
<span id="cb14-250"><a href="extended-function-example.html#cb14-250" tabindex="-1"></a>  <span class="fu">names</span>(totals) <span class="ot">&lt;-</span> 1L<span class="sc">:</span>(<span class="fu">length</span>(bins)<span class="sc">-</span>1L)</span>
<span id="cb14-251"><a href="extended-function-example.html#cb14-251" tabindex="-1"></a>  </span>
<span id="cb14-252"><a href="extended-function-example.html#cb14-252" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb14-253"><a href="extended-function-example.html#cb14-253" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">&quot;bin.boundaries&quot;</span> <span class="ot">=</span> bin.boundaries, </span>
<span id="cb14-254"><a href="extended-function-example.html#cb14-254" tabindex="-1"></a>       <span class="st">&quot;bin.id&quot;</span>         <span class="ot">=</span> bins, </span>
<span id="cb14-255"><a href="extended-function-example.html#cb14-255" tabindex="-1"></a>       <span class="st">&quot;totals&quot;</span>         <span class="ot">=</span> totals)</span>
<span id="cb14-256"><a href="extended-function-example.html#cb14-256" tabindex="-1"></a>}</span></code></pre></div>
<p>That’s it! We have a fully implemented extendable tool for the requested task!</p>
</div>
<div id="extensions" class="section level3 hasAnchor" number="2.3.6">
<h3><span class="header-section-number">2.3.6</span> Extensions<a href="extended-function-example.html#extensions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If it is decided that this tool would be handy if a user could instead provide a numeric vector of predicted survival probabilities rather than a fitted model with new data, such an extension can be made by adding the following:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="extended-function-example.html#cb15-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb15-2"><a href="extended-function-example.html#cb15-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb15-3"><a href="extended-function-example.html#cb15-3" tabindex="-1"></a><span class="co">#&#39; Function takes a user provided vector of survival probabilities or obtains</span></span>
<span id="cb15-4"><a href="extended-function-example.html#cb15-4" tabindex="-1"></a><span class="co">#&#39;   predicted survival probabilities from a provided fitted model and new data</span></span>
<span id="cb15-5"><a href="extended-function-example.html#cb15-5" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb15-6"><a href="extended-function-example.html#cb15-6" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb15-7"><a href="extended-function-example.html#cb15-7" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb15-8"><a href="extended-function-example.html#cb15-8" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model or numeric vector. Fitted survival models</span></span>
<span id="cb15-9"><a href="extended-function-example.html#cb15-9" tabindex="-1"></a><span class="co">#&#39;   are currently limited to classes `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb15-10"><a href="extended-function-example.html#cb15-10" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb15-11"><a href="extended-function-example.html#cb15-11" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored. If `object` is numeric, this input is ignored.</span></span>
<span id="cb15-12"><a href="extended-function-example.html#cb15-12" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb15-13"><a href="extended-function-example.html#cb15-13" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb15-14"><a href="extended-function-example.html#cb15-14" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb15-15"><a href="extended-function-example.html#cb15-15" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb15-16"><a href="extended-function-example.html#cb15-16" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb15-17"><a href="extended-function-example.html#cb15-17" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb15-18"><a href="extended-function-example.html#cb15-18" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb15-19"><a href="extended-function-example.html#cb15-19" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb15-20"><a href="extended-function-example.html#cb15-20" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb15-21"><a href="extended-function-example.html#cb15-21" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb15-22"><a href="extended-function-example.html#cb15-22" tabindex="-1"></a></span>
<span id="cb15-23"><a href="extended-function-example.html#cb15-23" tabindex="-1"></a><span class="co">#&#39; S3 method for numeric vector objects</span></span>
<span id="cb15-24"><a href="extended-function-example.html#cb15-24" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb15-25"><a href="extended-function-example.html#cb15-25" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb15-26"><a href="extended-function-example.html#cb15-26" tabindex="-1"></a>survProbBins.numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(object, bin.boundaries, ...) {</span>
<span id="cb15-27"><a href="extended-function-example.html#cb15-27" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb15-28"><a href="extended-function-example.html#cb15-28" tabindex="-1"></a>  <span class="co"># We reserve testing of `object` for the testing utility function</span></span>
<span id="cb15-29"><a href="extended-function-example.html#cb15-29" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb15-30"><a href="extended-function-example.html#cb15-30" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb15-31"><a href="extended-function-example.html#cb15-31" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb15-32"><a href="extended-function-example.html#cb15-32" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb15-33"><a href="extended-function-example.html#cb15-33" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb15-34"><a href="extended-function-example.html#cb15-34" tabindex="-1"></a>  )</span>
<span id="cb15-35"><a href="extended-function-example.html#cb15-35" tabindex="-1"></a>  </span>
<span id="cb15-36"><a href="extended-function-example.html#cb15-36" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb15-37"><a href="extended-function-example.html#cb15-37" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb15-38"><a href="extended-function-example.html#cb15-38" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(object)</span>
<span id="cb15-39"><a href="extended-function-example.html#cb15-39" tabindex="-1"></a>  </span>
<span id="cb15-40"><a href="extended-function-example.html#cb15-40" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb15-41"><a href="extended-function-example.html#cb15-41" tabindex="-1"></a>  </span>
<span id="cb15-42"><a href="extended-function-example.html#cb15-42" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb15-43"><a href="extended-function-example.html#cb15-43" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb15-44"><a href="extended-function-example.html#cb15-44" tabindex="-1"></a>  </span>
<span id="cb15-45"><a href="extended-function-example.html#cb15-45" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb15-46"><a href="extended-function-example.html#cb15-46" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb15-47"><a href="extended-function-example.html#cb15-47" tabindex="-1"></a>  result</span>
<span id="cb15-48"><a href="extended-function-example.html#cb15-48" tabindex="-1"></a>}</span></code></pre></div>
<p>Easy Peasy!!</p>
</div>
</div>
<div id="framework-and-utility-function-design-structure" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> Framework and Utility Function Design Structure<a href="extended-function-example.html#framework-and-utility-function-design-structure" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="usage-specification-1" class="section level3 hasAnchor" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> Usage Specification<a href="extended-function-example.html#usage-specification-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The key components of this design are a main function detailing the procedure in terms of steps and utility functions to implement each step. An example outline of this design might be:</p>
<ul>
<li>A main function
<ul>
<li><code>survProbBins(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Call <code>.binData()</code> to bin and tally predicted survival probabilities</li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>A utility function to predict survival probabilities
<ul>
<li><code>.predictSurvivalProb(object, newdata, eval.time, ...)</code>
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Call <code>.testProbabilities()</code></li>
<li>Return <code>.testProbabilities()</code> value object</li>
</ul></li>
</ul></li>
<li>A utility function to test validity of survival probabilities
<ul>
<li><code>.testProbabilities(prediction)</code>
<ul>
<li>Ensure predicted probabilities are all finite and in [0,1]</li>
</ul></li>
</ul></li>
<li>A utility function to bin and tally predicted survival probabilities
<ul>
<li><code>.binData(values, bin.boundaries)</code>
<ul>
<li>Test validity of inputs</li>
<li>Identify bin membership based on the provided probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
</ul>
<p>Notice that two of our utility functions are identical to the internal common functions of the S3 based design. For brevity, we will not repeat the development of <code>.testProbabilities()</code> and <code>.binData()</code> in this section.</p>
<p>Next, we need to identify the steps in the procedure that are model type dependent. In this example, the step to predict survival probabilities is the only step that may vary across model types. Such dependence lends itself to an S3 structure. For example:</p>
<ul>
<li>A main function
<ul>
<li><code>survProbBins(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>
<ul>
<li>Test validity of inputs</li>
<li>Call <code>.predictSurvivalProb()</code> to estimate survival probabilities</li>
<li>Call <code>.binData()</code> to bin and tally predicted survival probabilities</li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>A utility <highlight>method</highlight> to predict survival probabilities
<ul>
<li><highlight>A generic method</highlight>
<ul>
<li><highlight><myCode>.predictSurvivalProb(object, …)</myCode>.</highlight></li>
</ul></li>
<li><highlight>A default method</highlight>
<ul>
<li><highlight><myCode>.predictSurvivalProb(object, …)</myCode>.</highlight>
<ul>
<li><highlight>Generate error indicating that <myCode>object</myCode> is not supported</highlight></li>
</ul></li>
</ul></li>
<li><highlight>An extension method for <myCode>coxph</myCode> objects</highlight>
<ul>
<li><highlight><myCode>.predictSurvivalProb(object, newdata, eval.time, …)</myCode>.</highlight>
<ul>
<li><highlight>Test validity of inputs</highlight></li>
<li><highlight>Predict survival probabilities</highlight></li>
<li><highlight>Call <myCode>.testProbabilities()</myCode></highlight></li>
</ul></li>
</ul></li>
<li><highlight>An extension method for <myCode>survreg</myCode> objects</highlight>
<ul>
<li><highlight><myCode>.predictSurvivalProb(object, newdata, eval.time, …)</myCode>.</highlight>
<ul>
<li><highlight>Test validity of inputs</highlight></li>
<li><highlight>Predict survival probabilities</highlight></li>
<li><highlight>Call <myCode>.testProbabilities()</myCode></highlight></li>
</ul></li>
</ul></li>
<li><highlight>An extension method for <myCode>survregnet</myCode> objects</highlight>
<ul>
<li><highlight><myCode>.predictSurvivalProb(object, newdata, eval.time, lambda, …)</myCode>.</highlight>
<ul>
<li><highlight>Test validity of inputs</highlight></li>
<li><highlight>Call <myCode>convert2Survreg()</myCode> to convert <myCode>object</myCode> to a <myCode>survreg</myCode> object</highlight></li>
<li><highlight>Call <myCode>.predictSurvivalProb.survreg()</myCode> using converted object.</highlight></li>
</ul></li>
</ul></li>
</ul></li>
<li>A utility function to test validity of survival probabilities
<ul>
<li><code>.testProbabilities(prediction)</code>
<ul>
<li>Ensure predicted probabilities are all finite and in [0,1]</li>
</ul></li>
</ul></li>
<li>A utility function to bin and tally predicted survival probabilities
<ul>
<li><code>.binData(values, bin.boundaries)</code>
<ul>
<li>Test validity of inputs</li>
<li>Identify bin membership based on the provided probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
</ul>
<p>This design is very similar to the S3 based design. The key difference lies in where we place the model type dependency. For the S3 based design, that dependency rests with the task itself. The framework design shifts that dependency to the utility functions; specifically, the utility function that predicts the survival probability. An advantage of the framework design is that this functionality – predict survival probabilities – is now available to any other function in the package. In the S3 based design, this functionality is not accessible.</p>
<p>Because the functionality of predicting the survival probability is available throughout the package, it is most robust if it is developed to ensure that the returned predictions obey the expected behaviors of a survival probability. Specifically, survival probabilities must be in [0,1]; if they are not, an expected “invalid” value is returned (e.g., <code>NA_real</code>). To make this utility function more robust should it be used elsewhere, it is a better design choice to do the testing within the prediction method. Thus, we chose to organize our design outline such that the “test survival probabilities” is performed in the prediction utility function itself rather than as a step in the main procedure.</p>
<div id="main-function" class="section level4 hasAnchor" number="2.4.1.1">
<h4><span class="header-section-number">2.4.1.1</span> Main Function<a href="extended-function-example.html#main-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In the framework design, the main function, <code>survProbBins()</code>, sets up the general procedure for completing the task. That is, the steps required to perform the task are identified, but the details of each step are deferred to utility functions.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="extended-function-example.html#cb16-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb16-2"><a href="extended-function-example.html#cb16-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb16-3"><a href="extended-function-example.html#cb16-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb16-4"><a href="extended-function-example.html#cb16-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb16-5"><a href="extended-function-example.html#cb16-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb16-6"><a href="extended-function-example.html#cb16-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb16-7"><a href="extended-function-example.html#cb16-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb16-8"><a href="extended-function-example.html#cb16-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb16-9"><a href="extended-function-example.html#cb16-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb16-10"><a href="extended-function-example.html#cb16-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb16-11"><a href="extended-function-example.html#cb16-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb16-12"><a href="extended-function-example.html#cb16-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb16-13"><a href="extended-function-example.html#cb16-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb16-14"><a href="extended-function-example.html#cb16-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb16-15"><a href="extended-function-example.html#cb16-15" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric. The Elastic Net parameter of the model. </span></span>
<span id="cb16-16"><a href="extended-function-example.html#cb16-16" tabindex="-1"></a><span class="co">#&#39;   Required only if `object` is of class `survregnet`; ignored for all others.</span></span>
<span id="cb16-17"><a href="extended-function-example.html#cb16-17" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb16-18"><a href="extended-function-example.html#cb16-18" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb16-19"><a href="extended-function-example.html#cb16-19" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb16-20"><a href="extended-function-example.html#cb16-20" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb16-21"><a href="extended-function-example.html#cb16-21" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb16-22"><a href="extended-function-example.html#cb16-22" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb16-23"><a href="extended-function-example.html#cb16-23" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb16-24"><a href="extended-function-example.html#cb16-24" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb16-25"><a href="extended-function-example.html#cb16-25" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb16-26"><a href="extended-function-example.html#cb16-26" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb16-27"><a href="extended-function-example.html#cb16-27" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb16-28"><a href="extended-function-example.html#cb16-28" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, </span>
<span id="cb16-29"><a href="extended-function-example.html#cb16-29" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb16-30"><a href="extended-function-example.html#cb16-30" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb16-31"><a href="extended-function-example.html#cb16-31" tabindex="-1"></a>  <span class="co"># Verify that `object`, `newdata`, `eval.time`, and `bin.boundaries` are provided</span></span>
<span id="cb16-32"><a href="extended-function-example.html#cb16-32" tabindex="-1"></a>  <span class="co"># Verify that object is a supported model type</span></span>
<span id="cb16-33"><a href="extended-function-example.html#cb16-33" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb16-34"><a href="extended-function-example.html#cb16-34" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb16-35"><a href="extended-function-example.html#cb16-35" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb16-36"><a href="extended-function-example.html#cb16-36" tabindex="-1"></a>  <span class="co"># Verify that `bin.boundaries` is a numeric vector in [0, 1]</span></span>
<span id="cb16-37"><a href="extended-function-example.html#cb16-37" tabindex="-1"></a>  <span class="co"># Verify that `lambda` is NULL or a non-negative scalar</span></span>
<span id="cb16-38"><a href="extended-function-example.html#cb16-38" tabindex="-1"></a>  </span>
<span id="cb16-39"><a href="extended-function-example.html#cb16-39" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb16-40"><a href="extended-function-example.html#cb16-40" tabindex="-1"></a>  <span class="co"># Call `.predictSurvivalProb()` to estimate survival probabilities</span></span>
<span id="cb16-41"><a href="extended-function-example.html#cb16-41" tabindex="-1"></a>  </span>
<span id="cb16-42"><a href="extended-function-example.html#cb16-42" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb16-43"><a href="extended-function-example.html#cb16-43" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb16-44"><a href="extended-function-example.html#cb16-44" tabindex="-1"></a>  </span>
<span id="cb16-45"><a href="extended-function-example.html#cb16-45" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb16-46"><a href="extended-function-example.html#cb16-46" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb16-47"><a href="extended-function-example.html#cb16-47" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that in contrast to the S3 based framework, <strong>ALL</strong> of the inputs required by each model type must be provided as input. Here, <code>lambda</code> is an input regardless of the model type (though <code>NULL</code> is a perfectly acceptable value if <code>object</code> is not an Elastic Net model). We can circumvent this by dictating in the documentation that “if <code>object</code> is Elastic Net, <code>...</code> must include the Elastic Net parameter, <code>lambda</code>.” However, heavy reliance on the ellipsis for such one-off parameters could become confusing for the user.</p>
</div>
<div id="utility-functions" class="section level4 hasAnchor" number="2.4.1.2">
<h4><span class="header-section-number">2.4.1.2</span> Utility Functions<a href="extended-function-example.html#utility-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The implementation of the “bin and tally the predicted probabilities” and “test the predicted survival probabilities” will be identical to those developed under the S3 based design.</p>
<p>The details of the prediction step will depend on the model type, and thus it is a natural S3 method. Should more model types become supported, ideally we will only have to extend this method to include the new model type and make minor modifications to documentation and input testing in the main function.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="extended-function-example.html#cb17-1" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb17-2"><a href="extended-function-example.html#cb17-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb17-3"><a href="extended-function-example.html#cb17-3" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb17-4"><a href="extended-function-example.html#cb17-4" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb17-5"><a href="extended-function-example.html#cb17-5" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb17-6"><a href="extended-function-example.html#cb17-6" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb17-7"><a href="extended-function-example.html#cb17-7" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb17-8"><a href="extended-function-example.html#cb17-8" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb17-9"><a href="extended-function-example.html#cb17-9" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb17-10"><a href="extended-function-example.html#cb17-10" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb17-11"><a href="extended-function-example.html#cb17-11" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb17-12"><a href="extended-function-example.html#cb17-12" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb17-13"><a href="extended-function-example.html#cb17-13" tabindex="-1"></a>}</span>
<span id="cb17-14"><a href="extended-function-example.html#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="extended-function-example.html#cb17-15" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb17-16"><a href="extended-function-example.html#cb17-16" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb17-17"><a href="extended-function-example.html#cb17-17" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb17-18"><a href="extended-function-example.html#cb17-18" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb17-19"><a href="extended-function-example.html#cb17-19" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-20"><a href="extended-function-example.html#cb17-20" tabindex="-1"></a>}</span>
<span id="cb17-21"><a href="extended-function-example.html#cb17-21" tabindex="-1"></a></span>
<span id="cb17-22"><a href="extended-function-example.html#cb17-22" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb17-23"><a href="extended-function-example.html#cb17-23" tabindex="-1"></a></span>
<span id="cb17-24"><a href="extended-function-example.html#cb17-24" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb17-25"><a href="extended-function-example.html#cb17-25" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb17-26"><a href="extended-function-example.html#cb17-26" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb17-27"><a href="extended-function-example.html#cb17-27" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb17-28"><a href="extended-function-example.html#cb17-28" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb17-29"><a href="extended-function-example.html#cb17-29" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb17-30"><a href="extended-function-example.html#cb17-30" tabindex="-1"></a><span class="co">#&#39; @note inclusion of lambda as an input parameter in non-Elastic Net methods </span></span>
<span id="cb17-31"><a href="extended-function-example.html#cb17-31" tabindex="-1"></a><span class="co">#&#39;   ensures that it is not passed to the prediction method through the ellipsis</span></span>
<span id="cb17-32"><a href="extended-function-example.html#cb17-32" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb17-33"><a href="extended-function-example.html#cb17-33" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb17-34"><a href="extended-function-example.html#cb17-34" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb17-35"><a href="extended-function-example.html#cb17-35" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb17-36"><a href="extended-function-example.html#cb17-36" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb17-37"><a href="extended-function-example.html#cb17-37" tabindex="-1"></a>  </span>
<span id="cb17-38"><a href="extended-function-example.html#cb17-38" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb17-39"><a href="extended-function-example.html#cb17-39" tabindex="-1"></a>  </span>
<span id="cb17-40"><a href="extended-function-example.html#cb17-40" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb17-41"><a href="extended-function-example.html#cb17-41" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb17-42"><a href="extended-function-example.html#cb17-42" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb17-43"><a href="extended-function-example.html#cb17-43" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb17-44"><a href="extended-function-example.html#cb17-44" tabindex="-1"></a>  </span>
<span id="cb17-45"><a href="extended-function-example.html#cb17-45" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb17-46"><a href="extended-function-example.html#cb17-46" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb17-47"><a href="extended-function-example.html#cb17-47" tabindex="-1"></a>}</span>
<span id="cb17-48"><a href="extended-function-example.html#cb17-48" tabindex="-1"></a></span>
<span id="cb17-49"><a href="extended-function-example.html#cb17-49" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb17-50"><a href="extended-function-example.html#cb17-50" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb17-51"><a href="extended-function-example.html#cb17-51" tabindex="-1"></a><span class="co">#&#39; @note inclusion of lambda as an input parameter in non-Elastic Net methods </span></span>
<span id="cb17-52"><a href="extended-function-example.html#cb17-52" tabindex="-1"></a><span class="co">#&#39;   ensures that it is not passed to the prediction method through the ellipsis</span></span>
<span id="cb17-53"><a href="extended-function-example.html#cb17-53" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb17-54"><a href="extended-function-example.html#cb17-54" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb17-55"><a href="extended-function-example.html#cb17-55" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb17-56"><a href="extended-function-example.html#cb17-56" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb17-57"><a href="extended-function-example.html#cb17-57" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb17-58"><a href="extended-function-example.html#cb17-58" tabindex="-1"></a>  </span>
<span id="cb17-59"><a href="extended-function-example.html#cb17-59" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb17-60"><a href="extended-function-example.html#cb17-60" tabindex="-1"></a>  </span>
<span id="cb17-61"><a href="extended-function-example.html#cb17-61" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb17-62"><a href="extended-function-example.html#cb17-62" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb17-63"><a href="extended-function-example.html#cb17-63" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb17-64"><a href="extended-function-example.html#cb17-64" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb17-65"><a href="extended-function-example.html#cb17-65" tabindex="-1"></a>  </span>
<span id="cb17-66"><a href="extended-function-example.html#cb17-66" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb17-67"><a href="extended-function-example.html#cb17-67" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb17-68"><a href="extended-function-example.html#cb17-68" tabindex="-1"></a>}</span>
<span id="cb17-69"><a href="extended-function-example.html#cb17-69" tabindex="-1"></a></span>
<span id="cb17-70"><a href="extended-function-example.html#cb17-70" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb17-71"><a href="extended-function-example.html#cb17-71" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric. The Elastic Net parameter, lambda, of the model. </span></span>
<span id="cb17-72"><a href="extended-function-example.html#cb17-72" tabindex="-1"></a><span class="co">#&#39; @keyword internal</span></span>
<span id="cb17-73"><a href="extended-function-example.html#cb17-73" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb17-74"><a href="extended-function-example.html#cb17-74" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb17-75"><a href="extended-function-example.html#cb17-75" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb17-76"><a href="extended-function-example.html#cb17-76" tabindex="-1"></a>  <span class="co"># Verify that `newdata` is a data.frame or soma_adat</span></span>
<span id="cb17-77"><a href="extended-function-example.html#cb17-77" tabindex="-1"></a>  <span class="co"># Verify that `newdata` contains the appropriate data</span></span>
<span id="cb17-78"><a href="extended-function-example.html#cb17-78" tabindex="-1"></a>  <span class="co"># Verify that `eval.time` is a positive scalar</span></span>
<span id="cb17-79"><a href="extended-function-example.html#cb17-79" tabindex="-1"></a>  <span class="co"># Verify that `lambda` is a non-negative scalar</span></span>
<span id="cb17-80"><a href="extended-function-example.html#cb17-80" tabindex="-1"></a>  </span>
<span id="cb17-81"><a href="extended-function-example.html#cb17-81" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb17-82"><a href="extended-function-example.html#cb17-82" tabindex="-1"></a>  <span class="co"># Convert to a survreg object</span></span>
<span id="cb17-83"><a href="extended-function-example.html#cb17-83" tabindex="-1"></a>  </span>
<span id="cb17-84"><a href="extended-function-example.html#cb17-84" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb17-85"><a href="extended-function-example.html#cb17-85" tabindex="-1"></a>  <span class="co"># call .predictSurvivalProb.survreg() using the converted object</span></span>
<span id="cb17-86"><a href="extended-function-example.html#cb17-86" tabindex="-1"></a>  </span>
<span id="cb17-87"><a href="extended-function-example.html#cb17-87" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb17-88"><a href="extended-function-example.html#cb17-88" tabindex="-1"></a>  <span class="co"># Return `.predictSurvivalProb()` value object</span></span>
<span id="cb17-89"><a href="extended-function-example.html#cb17-89" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="input-testing-2" class="section level3 hasAnchor" number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> Input Testing<a href="extended-function-example.html#input-testing-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Unlike the S3 based design, input <code>object</code> must be explicitly tested in the framework and utility function design to ensure that it supported.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="extended-function-example.html#cb18-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb18-2"><a href="extended-function-example.html#cb18-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb18-3"><a href="extended-function-example.html#cb18-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb18-4"><a href="extended-function-example.html#cb18-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb18-5"><a href="extended-function-example.html#cb18-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb18-6"><a href="extended-function-example.html#cb18-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb18-7"><a href="extended-function-example.html#cb18-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb18-8"><a href="extended-function-example.html#cb18-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb18-9"><a href="extended-function-example.html#cb18-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb18-10"><a href="extended-function-example.html#cb18-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb18-11"><a href="extended-function-example.html#cb18-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb18-12"><a href="extended-function-example.html#cb18-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb18-13"><a href="extended-function-example.html#cb18-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb18-14"><a href="extended-function-example.html#cb18-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb18-15"><a href="extended-function-example.html#cb18-15" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric or NULL. The Elastic Net parameter, lambda, of the model. </span></span>
<span id="cb18-16"><a href="extended-function-example.html#cb18-16" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb18-17"><a href="extended-function-example.html#cb18-17" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb18-18"><a href="extended-function-example.html#cb18-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb18-19"><a href="extended-function-example.html#cb18-19" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb18-20"><a href="extended-function-example.html#cb18-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb18-21"><a href="extended-function-example.html#cb18-21" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb18-22"><a href="extended-function-example.html#cb18-22" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb18-23"><a href="extended-function-example.html#cb18-23" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb18-24"><a href="extended-function-example.html#cb18-24" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb18-25"><a href="extended-function-example.html#cb18-25" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb18-26"><a href="extended-function-example.html#cb18-26" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb18-27"><a href="extended-function-example.html#cb18-27" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, </span>
<span id="cb18-28"><a href="extended-function-example.html#cb18-28" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb18-29"><a href="extended-function-example.html#cb18-29" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb18-30"><a href="extended-function-example.html#cb18-30" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb18-31"><a href="extended-function-example.html#cb18-31" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb18-32"><a href="extended-function-example.html#cb18-32" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb18-33"><a href="extended-function-example.html#cb18-33" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb18-34"><a href="extended-function-example.html#cb18-34" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb18-35"><a href="extended-function-example.html#cb18-35" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-36"><a href="extended-function-example.html#cb18-36" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb18-37"><a href="extended-function-example.html#cb18-37" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-38"><a href="extended-function-example.html#cb18-38" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-39"><a href="extended-function-example.html#cb18-39" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb18-40"><a href="extended-function-example.html#cb18-40" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-41"><a href="extended-function-example.html#cb18-41" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-42"><a href="extended-function-example.html#cb18-42" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-43"><a href="extended-function-example.html#cb18-43" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb18-44"><a href="extended-function-example.html#cb18-44" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-45"><a href="extended-function-example.html#cb18-45" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-46"><a href="extended-function-example.html#cb18-46" tabindex="-1"></a>                            <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb18-47"><a href="extended-function-example.html#cb18-47" tabindex="-1"></a>  )</span>
<span id="cb18-48"><a href="extended-function-example.html#cb18-48" tabindex="-1"></a>  </span>
<span id="cb18-49"><a href="extended-function-example.html#cb18-49" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb18-50"><a href="extended-function-example.html#cb18-50" tabindex="-1"></a>  <span class="co"># Call `.predictSurvivalProb()` to estimate survival probabilities</span></span>
<span id="cb18-51"><a href="extended-function-example.html#cb18-51" tabindex="-1"></a>  </span>
<span id="cb18-52"><a href="extended-function-example.html#cb18-52" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb18-53"><a href="extended-function-example.html#cb18-53" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb18-54"><a href="extended-function-example.html#cb18-54" tabindex="-1"></a>  </span>
<span id="cb18-55"><a href="extended-function-example.html#cb18-55" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb18-56"><a href="extended-function-example.html#cb18-56" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb18-57"><a href="extended-function-example.html#cb18-57" tabindex="-1"></a>}</span>
<span id="cb18-58"><a href="extended-function-example.html#cb18-58" tabindex="-1"></a></span>
<span id="cb18-59"><a href="extended-function-example.html#cb18-59" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb18-60"><a href="extended-function-example.html#cb18-60" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb18-61"><a href="extended-function-example.html#cb18-61" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb18-62"><a href="extended-function-example.html#cb18-62" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb18-63"><a href="extended-function-example.html#cb18-63" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet` and their `stripped_*` counterparts.</span></span>
<span id="cb18-64"><a href="extended-function-example.html#cb18-64" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb18-65"><a href="extended-function-example.html#cb18-65" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb18-66"><a href="extended-function-example.html#cb18-66" tabindex="-1"></a><span class="co">#&#39; @returns Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb18-67"><a href="extended-function-example.html#cb18-67" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb18-68"><a href="extended-function-example.html#cb18-68" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb18-69"><a href="extended-function-example.html#cb18-69" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb18-70"><a href="extended-function-example.html#cb18-70" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb18-71"><a href="extended-function-example.html#cb18-71" tabindex="-1"></a>}</span>
<span id="cb18-72"><a href="extended-function-example.html#cb18-72" tabindex="-1"></a></span>
<span id="cb18-73"><a href="extended-function-example.html#cb18-73" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb18-74"><a href="extended-function-example.html#cb18-74" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb18-75"><a href="extended-function-example.html#cb18-75" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb18-76"><a href="extended-function-example.html#cb18-76" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb18-77"><a href="extended-function-example.html#cb18-77" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-78"><a href="extended-function-example.html#cb18-78" tabindex="-1"></a>}</span>
<span id="cb18-79"><a href="extended-function-example.html#cb18-79" tabindex="-1"></a></span>
<span id="cb18-80"><a href="extended-function-example.html#cb18-80" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb18-81"><a href="extended-function-example.html#cb18-81" tabindex="-1"></a></span>
<span id="cb18-82"><a href="extended-function-example.html#cb18-82" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb18-83"><a href="extended-function-example.html#cb18-83" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb18-84"><a href="extended-function-example.html#cb18-84" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb18-85"><a href="extended-function-example.html#cb18-85" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb18-86"><a href="extended-function-example.html#cb18-86" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb18-87"><a href="extended-function-example.html#cb18-87" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb18-88"><a href="extended-function-example.html#cb18-88" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, ...) {</span>
<span id="cb18-89"><a href="extended-function-example.html#cb18-89" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb18-90"><a href="extended-function-example.html#cb18-90" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb18-91"><a href="extended-function-example.html#cb18-91" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-92"><a href="extended-function-example.html#cb18-92" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb18-93"><a href="extended-function-example.html#cb18-93" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-94"><a href="extended-function-example.html#cb18-94" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-95"><a href="extended-function-example.html#cb18-95" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb18-96"><a href="extended-function-example.html#cb18-96" tabindex="-1"></a>  )</span>
<span id="cb18-97"><a href="extended-function-example.html#cb18-97" tabindex="-1"></a>  </span>
<span id="cb18-98"><a href="extended-function-example.html#cb18-98" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb18-99"><a href="extended-function-example.html#cb18-99" tabindex="-1"></a>  </span>
<span id="cb18-100"><a href="extended-function-example.html#cb18-100" tabindex="-1"></a>  <span class="do">### Task Implementataion</span></span>
<span id="cb18-101"><a href="extended-function-example.html#cb18-101" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb18-102"><a href="extended-function-example.html#cb18-102" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb18-103"><a href="extended-function-example.html#cb18-103" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb18-104"><a href="extended-function-example.html#cb18-104" tabindex="-1"></a>  </span>
<span id="cb18-105"><a href="extended-function-example.html#cb18-105" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb18-106"><a href="extended-function-example.html#cb18-106" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb18-107"><a href="extended-function-example.html#cb18-107" tabindex="-1"></a>}</span>
<span id="cb18-108"><a href="extended-function-example.html#cb18-108" tabindex="-1"></a></span>
<span id="cb18-109"><a href="extended-function-example.html#cb18-109" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb18-110"><a href="extended-function-example.html#cb18-110" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb18-111"><a href="extended-function-example.html#cb18-111" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, ...) {</span>
<span id="cb18-112"><a href="extended-function-example.html#cb18-112" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb18-113"><a href="extended-function-example.html#cb18-113" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb18-114"><a href="extended-function-example.html#cb18-114" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-115"><a href="extended-function-example.html#cb18-115" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb18-116"><a href="extended-function-example.html#cb18-116" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-117"><a href="extended-function-example.html#cb18-117" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-118"><a href="extended-function-example.html#cb18-118" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb18-119"><a href="extended-function-example.html#cb18-119" tabindex="-1"></a>  )</span>
<span id="cb18-120"><a href="extended-function-example.html#cb18-120" tabindex="-1"></a>  </span>
<span id="cb18-121"><a href="extended-function-example.html#cb18-121" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb18-122"><a href="extended-function-example.html#cb18-122" tabindex="-1"></a>  </span>
<span id="cb18-123"><a href="extended-function-example.html#cb18-123" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb18-124"><a href="extended-function-example.html#cb18-124" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb18-125"><a href="extended-function-example.html#cb18-125" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb18-126"><a href="extended-function-example.html#cb18-126" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb18-127"><a href="extended-function-example.html#cb18-127" tabindex="-1"></a>  </span>
<span id="cb18-128"><a href="extended-function-example.html#cb18-128" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb18-129"><a href="extended-function-example.html#cb18-129" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb18-130"><a href="extended-function-example.html#cb18-130" tabindex="-1"></a>}</span>
<span id="cb18-131"><a href="extended-function-example.html#cb18-131" tabindex="-1"></a></span>
<span id="cb18-132"><a href="extended-function-example.html#cb18-132" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb18-133"><a href="extended-function-example.html#cb18-133" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric or NULL. The Elastic Net parameter, lambda, of the model. </span></span>
<span id="cb18-134"><a href="extended-function-example.html#cb18-134" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb18-135"><a href="extended-function-example.html#cb18-135" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb18-136"><a href="extended-function-example.html#cb18-136" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb18-137"><a href="extended-function-example.html#cb18-137" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb18-138"><a href="extended-function-example.html#cb18-138" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb18-139"><a href="extended-function-example.html#cb18-139" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-140"><a href="extended-function-example.html#cb18-140" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb18-141"><a href="extended-function-example.html#cb18-141" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-142"><a href="extended-function-example.html#cb18-142" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-143"><a href="extended-function-example.html#cb18-143" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb18-144"><a href="extended-function-example.html#cb18-144" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb18-145"><a href="extended-function-example.html#cb18-145" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb18-146"><a href="extended-function-example.html#cb18-146" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb18-147"><a href="extended-function-example.html#cb18-147" tabindex="-1"></a>  )</span>
<span id="cb18-148"><a href="extended-function-example.html#cb18-148" tabindex="-1"></a>  </span>
<span id="cb18-149"><a href="extended-function-example.html#cb18-149" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb18-150"><a href="extended-function-example.html#cb18-150" tabindex="-1"></a>  <span class="co"># Call convert2survreg() to convert to a `survreg` object</span></span>
<span id="cb18-151"><a href="extended-function-example.html#cb18-151" tabindex="-1"></a>  </span>
<span id="cb18-152"><a href="extended-function-example.html#cb18-152" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb18-153"><a href="extended-function-example.html#cb18-153" tabindex="-1"></a>  <span class="co"># Call .predictSurvivalProb.survreg() passing converted object</span></span>
<span id="cb18-154"><a href="extended-function-example.html#cb18-154" tabindex="-1"></a>  </span>
<span id="cb18-155"><a href="extended-function-example.html#cb18-155" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb18-156"><a href="extended-function-example.html#cb18-156" tabindex="-1"></a>  <span class="co"># Return `.predictSurvivalProb.survreg()` value object</span></span>
<span id="cb18-157"><a href="extended-function-example.html#cb18-157" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="input-processing-2" class="section level3 hasAnchor" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> Input Processing<a href="extended-function-example.html#input-processing-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="extended-function-example.html#cb19-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb19-2"><a href="extended-function-example.html#cb19-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb19-3"><a href="extended-function-example.html#cb19-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb19-4"><a href="extended-function-example.html#cb19-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb19-5"><a href="extended-function-example.html#cb19-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb19-6"><a href="extended-function-example.html#cb19-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb19-7"><a href="extended-function-example.html#cb19-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb19-8"><a href="extended-function-example.html#cb19-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb19-9"><a href="extended-function-example.html#cb19-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb19-10"><a href="extended-function-example.html#cb19-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb19-11"><a href="extended-function-example.html#cb19-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb19-12"><a href="extended-function-example.html#cb19-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb19-13"><a href="extended-function-example.html#cb19-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb19-14"><a href="extended-function-example.html#cb19-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb19-15"><a href="extended-function-example.html#cb19-15" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb19-16"><a href="extended-function-example.html#cb19-16" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb19-17"><a href="extended-function-example.html#cb19-17" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb19-18"><a href="extended-function-example.html#cb19-18" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb19-19"><a href="extended-function-example.html#cb19-19" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb19-20"><a href="extended-function-example.html#cb19-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb19-21"><a href="extended-function-example.html#cb19-21" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb19-22"><a href="extended-function-example.html#cb19-22" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb19-23"><a href="extended-function-example.html#cb19-23" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb19-24"><a href="extended-function-example.html#cb19-24" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb19-25"><a href="extended-function-example.html#cb19-25" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb19-26"><a href="extended-function-example.html#cb19-26" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, </span>
<span id="cb19-27"><a href="extended-function-example.html#cb19-27" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb19-28"><a href="extended-function-example.html#cb19-28" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb19-29"><a href="extended-function-example.html#cb19-29" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb19-30"><a href="extended-function-example.html#cb19-30" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb19-31"><a href="extended-function-example.html#cb19-31" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb19-32"><a href="extended-function-example.html#cb19-32" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb19-33"><a href="extended-function-example.html#cb19-33" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb19-34"><a href="extended-function-example.html#cb19-34" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-35"><a href="extended-function-example.html#cb19-35" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb19-36"><a href="extended-function-example.html#cb19-36" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-37"><a href="extended-function-example.html#cb19-37" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-38"><a href="extended-function-example.html#cb19-38" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb19-39"><a href="extended-function-example.html#cb19-39" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-40"><a href="extended-function-example.html#cb19-40" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-41"><a href="extended-function-example.html#cb19-41" tabindex="-1"></a>      <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-42"><a href="extended-function-example.html#cb19-42" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb19-43"><a href="extended-function-example.html#cb19-43" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-44"><a href="extended-function-example.html#cb19-44" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span></span>
<span id="cb19-45"><a href="extended-function-example.html#cb19-45" tabindex="-1"></a>                          <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb19-46"><a href="extended-function-example.html#cb19-46" tabindex="-1"></a>  )</span>
<span id="cb19-47"><a href="extended-function-example.html#cb19-47" tabindex="-1"></a>  </span>
<span id="cb19-48"><a href="extended-function-example.html#cb19-48" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb19-49"><a href="extended-function-example.html#cb19-49" tabindex="-1"></a>  <span class="co"># Estimate survival probabilities</span></span>
<span id="cb19-50"><a href="extended-function-example.html#cb19-50" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb19-51"><a href="extended-function-example.html#cb19-51" tabindex="-1"></a>  </span>
<span id="cb19-52"><a href="extended-function-example.html#cb19-52" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb19-53"><a href="extended-function-example.html#cb19-53" tabindex="-1"></a>  <span class="co"># Call `.binData()` to bin and tally predicted probabilities</span></span>
<span id="cb19-54"><a href="extended-function-example.html#cb19-54" tabindex="-1"></a>  </span>
<span id="cb19-55"><a href="extended-function-example.html#cb19-55" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb19-56"><a href="extended-function-example.html#cb19-56" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb19-57"><a href="extended-function-example.html#cb19-57" tabindex="-1"></a>}</span>
<span id="cb19-58"><a href="extended-function-example.html#cb19-58" tabindex="-1"></a></span>
<span id="cb19-59"><a href="extended-function-example.html#cb19-59" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb19-60"><a href="extended-function-example.html#cb19-60" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb19-61"><a href="extended-function-example.html#cb19-61" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb19-62"><a href="extended-function-example.html#cb19-62" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb19-63"><a href="extended-function-example.html#cb19-63" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet` and their `stripped_*` counterparts.</span></span>
<span id="cb19-64"><a href="extended-function-example.html#cb19-64" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb19-65"><a href="extended-function-example.html#cb19-65" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb19-66"><a href="extended-function-example.html#cb19-66" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb19-67"><a href="extended-function-example.html#cb19-67" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb19-68"><a href="extended-function-example.html#cb19-68" tabindex="-1"></a><span class="co">#&#39; @returns Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb19-69"><a href="extended-function-example.html#cb19-69" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb19-70"><a href="extended-function-example.html#cb19-70" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb19-71"><a href="extended-function-example.html#cb19-71" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb19-72"><a href="extended-function-example.html#cb19-72" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb19-73"><a href="extended-function-example.html#cb19-73" tabindex="-1"></a>}</span>
<span id="cb19-74"><a href="extended-function-example.html#cb19-74" tabindex="-1"></a></span>
<span id="cb19-75"><a href="extended-function-example.html#cb19-75" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb19-76"><a href="extended-function-example.html#cb19-76" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb19-77"><a href="extended-function-example.html#cb19-77" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-78"><a href="extended-function-example.html#cb19-78" tabindex="-1"></a>}</span>
<span id="cb19-79"><a href="extended-function-example.html#cb19-79" tabindex="-1"></a></span>
<span id="cb19-80"><a href="extended-function-example.html#cb19-80" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb19-81"><a href="extended-function-example.html#cb19-81" tabindex="-1"></a></span>
<span id="cb19-82"><a href="extended-function-example.html#cb19-82" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb19-83"><a href="extended-function-example.html#cb19-83" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb19-84"><a href="extended-function-example.html#cb19-84" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb19-85"><a href="extended-function-example.html#cb19-85" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb19-86"><a href="extended-function-example.html#cb19-86" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb19-87"><a href="extended-function-example.html#cb19-87" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb19-88"><a href="extended-function-example.html#cb19-88" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb19-89"><a href="extended-function-example.html#cb19-89" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-90"><a href="extended-function-example.html#cb19-90" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb19-91"><a href="extended-function-example.html#cb19-91" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-92"><a href="extended-function-example.html#cb19-92" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-93"><a href="extended-function-example.html#cb19-93" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb19-94"><a href="extended-function-example.html#cb19-94" tabindex="-1"></a>  )</span>
<span id="cb19-95"><a href="extended-function-example.html#cb19-95" tabindex="-1"></a>  </span>
<span id="cb19-96"><a href="extended-function-example.html#cb19-96" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb19-97"><a href="extended-function-example.html#cb19-97" tabindex="-1"></a>  </span>
<span id="cb19-98"><a href="extended-function-example.html#cb19-98" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb19-99"><a href="extended-function-example.html#cb19-99" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb19-100"><a href="extended-function-example.html#cb19-100" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb19-101"><a href="extended-function-example.html#cb19-101" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb19-102"><a href="extended-function-example.html#cb19-102" tabindex="-1"></a>  </span>
<span id="cb19-103"><a href="extended-function-example.html#cb19-103" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb19-104"><a href="extended-function-example.html#cb19-104" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb19-105"><a href="extended-function-example.html#cb19-105" tabindex="-1"></a>}</span>
<span id="cb19-106"><a href="extended-function-example.html#cb19-106" tabindex="-1"></a></span>
<span id="cb19-107"><a href="extended-function-example.html#cb19-107" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb19-108"><a href="extended-function-example.html#cb19-108" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb19-109"><a href="extended-function-example.html#cb19-109" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb19-110"><a href="extended-function-example.html#cb19-110" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb19-111"><a href="extended-function-example.html#cb19-111" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, </span>
<span id="cb19-112"><a href="extended-function-example.html#cb19-112" tabindex="-1"></a>                                         lambda, ...) {</span>
<span id="cb19-113"><a href="extended-function-example.html#cb19-113" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb19-114"><a href="extended-function-example.html#cb19-114" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-115"><a href="extended-function-example.html#cb19-115" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb19-116"><a href="extended-function-example.html#cb19-116" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-117"><a href="extended-function-example.html#cb19-117" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-118"><a href="extended-function-example.html#cb19-118" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb19-119"><a href="extended-function-example.html#cb19-119" tabindex="-1"></a>  )</span>
<span id="cb19-120"><a href="extended-function-example.html#cb19-120" tabindex="-1"></a>  </span>
<span id="cb19-121"><a href="extended-function-example.html#cb19-121" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb19-122"><a href="extended-function-example.html#cb19-122" tabindex="-1"></a>  </span>
<span id="cb19-123"><a href="extended-function-example.html#cb19-123" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb19-124"><a href="extended-function-example.html#cb19-124" tabindex="-1"></a>  <span class="co"># Predict survival probability</span></span>
<span id="cb19-125"><a href="extended-function-example.html#cb19-125" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb19-126"><a href="extended-function-example.html#cb19-126" tabindex="-1"></a>  <span class="co"># Call .testProbabilities() to ensure valid predictions</span></span>
<span id="cb19-127"><a href="extended-function-example.html#cb19-127" tabindex="-1"></a>  </span>
<span id="cb19-128"><a href="extended-function-example.html#cb19-128" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb19-129"><a href="extended-function-example.html#cb19-129" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb19-130"><a href="extended-function-example.html#cb19-130" tabindex="-1"></a>}</span>
<span id="cb19-131"><a href="extended-function-example.html#cb19-131" tabindex="-1"></a></span>
<span id="cb19-132"><a href="extended-function-example.html#cb19-132" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb19-133"><a href="extended-function-example.html#cb19-133" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb19-134"><a href="extended-function-example.html#cb19-134" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb19-135"><a href="extended-function-example.html#cb19-135" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb19-136"><a href="extended-function-example.html#cb19-136" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb19-137"><a href="extended-function-example.html#cb19-137" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-138"><a href="extended-function-example.html#cb19-138" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb19-139"><a href="extended-function-example.html#cb19-139" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-140"><a href="extended-function-example.html#cb19-140" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-141"><a href="extended-function-example.html#cb19-141" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb19-142"><a href="extended-function-example.html#cb19-142" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb19-143"><a href="extended-function-example.html#cb19-143" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb19-144"><a href="extended-function-example.html#cb19-144" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb19-145"><a href="extended-function-example.html#cb19-145" tabindex="-1"></a>  )</span>
<span id="cb19-146"><a href="extended-function-example.html#cb19-146" tabindex="-1"></a>  </span>
<span id="cb19-147"><a href="extended-function-example.html#cb19-147" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb19-148"><a href="extended-function-example.html#cb19-148" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb19-149"><a href="extended-function-example.html#cb19-149" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb19-150"><a href="extended-function-example.html#cb19-150" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-151"><a href="extended-function-example.html#cb19-151" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb19-152"><a href="extended-function-example.html#cb19-152" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-153"><a href="extended-function-example.html#cb19-153" tabindex="-1"></a>                             })</span>
<span id="cb19-154"><a href="extended-function-example.html#cb19-154" tabindex="-1"></a>  </span>
<span id="cb19-155"><a href="extended-function-example.html#cb19-155" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb19-156"><a href="extended-function-example.html#cb19-156" tabindex="-1"></a>  <span class="co"># Call `.predictSurvivalProb.survreg()` passing converted object</span></span>
<span id="cb19-157"><a href="extended-function-example.html#cb19-157" tabindex="-1"></a>  </span>
<span id="cb19-158"><a href="extended-function-example.html#cb19-158" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb19-159"><a href="extended-function-example.html#cb19-159" tabindex="-1"></a>  <span class="co"># Return `.predictSurvivalProb.survreg()` value object</span></span>
<span id="cb19-160"><a href="extended-function-example.html#cb19-160" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="task-implementation-2" class="section level3 hasAnchor" number="2.4.4">
<h3><span class="header-section-number">2.4.4</span> Task Implementation<a href="extended-function-example.html#task-implementation-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="extended-function-example.html#cb20-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb20-2"><a href="extended-function-example.html#cb20-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-3"><a href="extended-function-example.html#cb20-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb20-4"><a href="extended-function-example.html#cb20-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb20-5"><a href="extended-function-example.html#cb20-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb20-6"><a href="extended-function-example.html#cb20-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb20-7"><a href="extended-function-example.html#cb20-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb20-8"><a href="extended-function-example.html#cb20-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb20-9"><a href="extended-function-example.html#cb20-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb20-10"><a href="extended-function-example.html#cb20-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb20-11"><a href="extended-function-example.html#cb20-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb20-12"><a href="extended-function-example.html#cb20-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb20-13"><a href="extended-function-example.html#cb20-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb20-14"><a href="extended-function-example.html#cb20-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb20-15"><a href="extended-function-example.html#cb20-15" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb20-16"><a href="extended-function-example.html#cb20-16" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb20-17"><a href="extended-function-example.html#cb20-17" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-18"><a href="extended-function-example.html#cb20-18" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb20-19"><a href="extended-function-example.html#cb20-19" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb20-20"><a href="extended-function-example.html#cb20-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb20-21"><a href="extended-function-example.html#cb20-21" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb20-22"><a href="extended-function-example.html#cb20-22" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb20-23"><a href="extended-function-example.html#cb20-23" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb20-24"><a href="extended-function-example.html#cb20-24" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-25"><a href="extended-function-example.html#cb20-25" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb20-26"><a href="extended-function-example.html#cb20-26" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, </span>
<span id="cb20-27"><a href="extended-function-example.html#cb20-27" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb20-28"><a href="extended-function-example.html#cb20-28" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb20-29"><a href="extended-function-example.html#cb20-29" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb20-30"><a href="extended-function-example.html#cb20-30" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb20-31"><a href="extended-function-example.html#cb20-31" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb20-32"><a href="extended-function-example.html#cb20-32" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb20-33"><a href="extended-function-example.html#cb20-33" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb20-34"><a href="extended-function-example.html#cb20-34" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-35"><a href="extended-function-example.html#cb20-35" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb20-36"><a href="extended-function-example.html#cb20-36" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-37"><a href="extended-function-example.html#cb20-37" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-38"><a href="extended-function-example.html#cb20-38" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb20-39"><a href="extended-function-example.html#cb20-39" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-40"><a href="extended-function-example.html#cb20-40" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-41"><a href="extended-function-example.html#cb20-41" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-42"><a href="extended-function-example.html#cb20-42" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb20-43"><a href="extended-function-example.html#cb20-43" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-44"><a href="extended-function-example.html#cb20-44" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span></span>
<span id="cb20-45"><a href="extended-function-example.html#cb20-45" tabindex="-1"></a>                            <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb20-46"><a href="extended-function-example.html#cb20-46" tabindex="-1"></a>  )</span>
<span id="cb20-47"><a href="extended-function-example.html#cb20-47" tabindex="-1"></a>  </span>
<span id="cb20-48"><a href="extended-function-example.html#cb20-48" tabindex="-1"></a>  <span class="do">### Input Process</span></span>
<span id="cb20-49"><a href="extended-function-example.html#cb20-49" tabindex="-1"></a>  </span>
<span id="cb20-50"><a href="extended-function-example.html#cb20-50" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb20-51"><a href="extended-function-example.html#cb20-51" tabindex="-1"></a>  <span class="co"># Estimate survival probabilities</span></span>
<span id="cb20-52"><a href="extended-function-example.html#cb20-52" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb20-53"><a href="extended-function-example.html#cb20-53" tabindex="-1"></a>  </span>
<span id="cb20-54"><a href="extended-function-example.html#cb20-54" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb20-55"><a href="extended-function-example.html#cb20-55" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(predictions, bin.boundaries)</span>
<span id="cb20-56"><a href="extended-function-example.html#cb20-56" tabindex="-1"></a>  </span>
<span id="cb20-57"><a href="extended-function-example.html#cb20-57" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb20-58"><a href="extended-function-example.html#cb20-58" tabindex="-1"></a>  <span class="co"># Return `.binData()` value object</span></span>
<span id="cb20-59"><a href="extended-function-example.html#cb20-59" tabindex="-1"></a>}</span>
<span id="cb20-60"><a href="extended-function-example.html#cb20-60" tabindex="-1"></a></span>
<span id="cb20-61"><a href="extended-function-example.html#cb20-61" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb20-62"><a href="extended-function-example.html#cb20-62" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-63"><a href="extended-function-example.html#cb20-63" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb20-64"><a href="extended-function-example.html#cb20-64" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb20-65"><a href="extended-function-example.html#cb20-65" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet` and their `stripped_*` counterparts.</span></span>
<span id="cb20-66"><a href="extended-function-example.html#cb20-66" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb20-67"><a href="extended-function-example.html#cb20-67" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb20-68"><a href="extended-function-example.html#cb20-68" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb20-69"><a href="extended-function-example.html#cb20-69" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb20-70"><a href="extended-function-example.html#cb20-70" tabindex="-1"></a><span class="co">#&#39; @returns Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb20-71"><a href="extended-function-example.html#cb20-71" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb20-72"><a href="extended-function-example.html#cb20-72" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb20-73"><a href="extended-function-example.html#cb20-73" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb20-74"><a href="extended-function-example.html#cb20-74" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb20-75"><a href="extended-function-example.html#cb20-75" tabindex="-1"></a>}</span>
<span id="cb20-76"><a href="extended-function-example.html#cb20-76" tabindex="-1"></a></span>
<span id="cb20-77"><a href="extended-function-example.html#cb20-77" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb20-78"><a href="extended-function-example.html#cb20-78" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb20-79"><a href="extended-function-example.html#cb20-79" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-80"><a href="extended-function-example.html#cb20-80" tabindex="-1"></a>}</span>
<span id="cb20-81"><a href="extended-function-example.html#cb20-81" tabindex="-1"></a></span>
<span id="cb20-82"><a href="extended-function-example.html#cb20-82" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb20-83"><a href="extended-function-example.html#cb20-83" tabindex="-1"></a></span>
<span id="cb20-84"><a href="extended-function-example.html#cb20-84" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb20-85"><a href="extended-function-example.html#cb20-85" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb20-86"><a href="extended-function-example.html#cb20-86" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb20-87"><a href="extended-function-example.html#cb20-87" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb20-88"><a href="extended-function-example.html#cb20-88" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb20-89"><a href="extended-function-example.html#cb20-89" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb20-90"><a href="extended-function-example.html#cb20-90" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb20-91"><a href="extended-function-example.html#cb20-91" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-92"><a href="extended-function-example.html#cb20-92" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb20-93"><a href="extended-function-example.html#cb20-93" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-94"><a href="extended-function-example.html#cb20-94" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-95"><a href="extended-function-example.html#cb20-95" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb20-96"><a href="extended-function-example.html#cb20-96" tabindex="-1"></a>  )</span>
<span id="cb20-97"><a href="extended-function-example.html#cb20-97" tabindex="-1"></a>  </span>
<span id="cb20-98"><a href="extended-function-example.html#cb20-98" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb20-99"><a href="extended-function-example.html#cb20-99" tabindex="-1"></a>  </span>
<span id="cb20-100"><a href="extended-function-example.html#cb20-100" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb20-101"><a href="extended-function-example.html#cb20-101" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb20-102"><a href="extended-function-example.html#cb20-102" tabindex="-1"></a>  </span>
<span id="cb20-103"><a href="extended-function-example.html#cb20-103" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb20-104"><a href="extended-function-example.html#cb20-104" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb20-105"><a href="extended-function-example.html#cb20-105" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb20-106"><a href="extended-function-example.html#cb20-106" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb20-107"><a href="extended-function-example.html#cb20-107" tabindex="-1"></a>  </span>
<span id="cb20-108"><a href="extended-function-example.html#cb20-108" tabindex="-1"></a>  base_hazard_at_t <span class="ot">&lt;-</span> base_hazard[t_idx, 1L]</span>
<span id="cb20-109"><a href="extended-function-example.html#cb20-109" tabindex="-1"></a>  </span>
<span id="cb20-110"><a href="extended-function-example.html#cb20-110" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb20-111"><a href="extended-function-example.html#cb20-111" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard_at_t) ) {</span>
<span id="cb20-112"><a href="extended-function-example.html#cb20-112" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard_at_t), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-113"><a href="extended-function-example.html#cb20-113" tabindex="-1"></a>  }</span>
<span id="cb20-114"><a href="extended-function-example.html#cb20-114" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb20-115"><a href="extended-function-example.html#cb20-115" tabindex="-1"></a></span>
<span id="cb20-116"><a href="extended-function-example.html#cb20-116" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb20-117"><a href="extended-function-example.html#cb20-117" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb20-118"><a href="extended-function-example.html#cb20-118" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-119"><a href="extended-function-example.html#cb20-119" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb20-120"><a href="extended-function-example.html#cb20-120" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-121"><a href="extended-function-example.html#cb20-121" tabindex="-1"></a>                               })</span>
<span id="cb20-122"><a href="extended-function-example.html#cb20-122" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb20-123"><a href="extended-function-example.html#cb20-123" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb20-124"><a href="extended-function-example.html#cb20-124" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb20-125"><a href="extended-function-example.html#cb20-125" tabindex="-1"></a>  </span>
<span id="cb20-126"><a href="extended-function-example.html#cb20-126" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb20-127"><a href="extended-function-example.html#cb20-127" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb20-128"><a href="extended-function-example.html#cb20-128" tabindex="-1"></a>  </span>
<span id="cb20-129"><a href="extended-function-example.html#cb20-129" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb20-130"><a href="extended-function-example.html#cb20-130" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb20-131"><a href="extended-function-example.html#cb20-131" tabindex="-1"></a>}</span>
<span id="cb20-132"><a href="extended-function-example.html#cb20-132" tabindex="-1"></a></span>
<span id="cb20-133"><a href="extended-function-example.html#cb20-133" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb20-134"><a href="extended-function-example.html#cb20-134" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb20-135"><a href="extended-function-example.html#cb20-135" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb20-136"><a href="extended-function-example.html#cb20-136" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb20-137"><a href="extended-function-example.html#cb20-137" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, </span>
<span id="cb20-138"><a href="extended-function-example.html#cb20-138" tabindex="-1"></a>                                         lambda, ...) {</span>
<span id="cb20-139"><a href="extended-function-example.html#cb20-139" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb20-140"><a href="extended-function-example.html#cb20-140" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb20-141"><a href="extended-function-example.html#cb20-141" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-142"><a href="extended-function-example.html#cb20-142" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb20-143"><a href="extended-function-example.html#cb20-143" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-144"><a href="extended-function-example.html#cb20-144" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-145"><a href="extended-function-example.html#cb20-145" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb20-146"><a href="extended-function-example.html#cb20-146" tabindex="-1"></a>  )</span>
<span id="cb20-147"><a href="extended-function-example.html#cb20-147" tabindex="-1"></a>  </span>
<span id="cb20-148"><a href="extended-function-example.html#cb20-148" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb20-149"><a href="extended-function-example.html#cb20-149" tabindex="-1"></a>  </span>
<span id="cb20-150"><a href="extended-function-example.html#cb20-150" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb20-151"><a href="extended-function-example.html#cb20-151" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb20-152"><a href="extended-function-example.html#cb20-152" tabindex="-1"></a>  </span>
<span id="cb20-153"><a href="extended-function-example.html#cb20-153" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb20-154"><a href="extended-function-example.html#cb20-154" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-155"><a href="extended-function-example.html#cb20-155" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb20-156"><a href="extended-function-example.html#cb20-156" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-157"><a href="extended-function-example.html#cb20-157" tabindex="-1"></a>                               })</span>
<span id="cb20-158"><a href="extended-function-example.html#cb20-158" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb20-159"><a href="extended-function-example.html#cb20-159" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb20-160"><a href="extended-function-example.html#cb20-160" tabindex="-1"></a>                                   </span>
<span id="cb20-161"><a href="extended-function-example.html#cb20-161" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb20-162"><a href="extended-function-example.html#cb20-162" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb20-163"><a href="extended-function-example.html#cb20-163" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb20-164"><a href="extended-function-example.html#cb20-164" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb20-165"><a href="extended-function-example.html#cb20-165" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb20-166"><a href="extended-function-example.html#cb20-166" tabindex="-1"></a>  </span>
<span id="cb20-167"><a href="extended-function-example.html#cb20-167" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb20-168"><a href="extended-function-example.html#cb20-168" tabindex="-1"></a>  <span class="co"># Return predicted survival probability as an unnamed numeric vector</span></span>
<span id="cb20-169"><a href="extended-function-example.html#cb20-169" tabindex="-1"></a>}</span>
<span id="cb20-170"><a href="extended-function-example.html#cb20-170" tabindex="-1"></a></span>
<span id="cb20-171"><a href="extended-function-example.html#cb20-171" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb20-172"><a href="extended-function-example.html#cb20-172" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb20-173"><a href="extended-function-example.html#cb20-173" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb20-174"><a href="extended-function-example.html#cb20-174" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb20-175"><a href="extended-function-example.html#cb20-175" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb20-176"><a href="extended-function-example.html#cb20-176" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb20-177"><a href="extended-function-example.html#cb20-177" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-178"><a href="extended-function-example.html#cb20-178" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb20-179"><a href="extended-function-example.html#cb20-179" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-180"><a href="extended-function-example.html#cb20-180" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-181"><a href="extended-function-example.html#cb20-181" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb20-182"><a href="extended-function-example.html#cb20-182" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb20-183"><a href="extended-function-example.html#cb20-183" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb20-184"><a href="extended-function-example.html#cb20-184" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb20-185"><a href="extended-function-example.html#cb20-185" tabindex="-1"></a>  )</span>
<span id="cb20-186"><a href="extended-function-example.html#cb20-186" tabindex="-1"></a>  </span>
<span id="cb20-187"><a href="extended-function-example.html#cb20-187" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb20-188"><a href="extended-function-example.html#cb20-188" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb20-189"><a href="extended-function-example.html#cb20-189" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb20-190"><a href="extended-function-example.html#cb20-190" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-191"><a href="extended-function-example.html#cb20-191" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb20-192"><a href="extended-function-example.html#cb20-192" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-193"><a href="extended-function-example.html#cb20-193" tabindex="-1"></a>                             })</span>
<span id="cb20-194"><a href="extended-function-example.html#cb20-194" tabindex="-1"></a>  </span>
<span id="cb20-195"><a href="extended-function-example.html#cb20-195" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(survreg_object, newdata, eval.time, ...)</span>
<span id="cb20-196"><a href="extended-function-example.html#cb20-196" tabindex="-1"></a>  </span>
<span id="cb20-197"><a href="extended-function-example.html#cb20-197" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb20-198"><a href="extended-function-example.html#cb20-198" tabindex="-1"></a>  <span class="co"># Return `.predictSurvivalProb.survreg()` value object</span></span>
<span id="cb20-199"><a href="extended-function-example.html#cb20-199" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="results-construction-and-testing-1" class="section level3 hasAnchor" number="2.4.5">
<h3><span class="header-section-number">2.4.5</span> Results Construction and Testing<a href="extended-function-example.html#results-construction-and-testing-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our example, there are no additional processing steps required for the result; <code>.binData()</code> created the expected list.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="extended-function-example.html#cb21-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb21-2"><a href="extended-function-example.html#cb21-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb21-3"><a href="extended-function-example.html#cb21-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb21-4"><a href="extended-function-example.html#cb21-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb21-5"><a href="extended-function-example.html#cb21-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb21-6"><a href="extended-function-example.html#cb21-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb21-7"><a href="extended-function-example.html#cb21-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb21-8"><a href="extended-function-example.html#cb21-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb21-9"><a href="extended-function-example.html#cb21-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb21-10"><a href="extended-function-example.html#cb21-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb21-11"><a href="extended-function-example.html#cb21-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb21-12"><a href="extended-function-example.html#cb21-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb21-13"><a href="extended-function-example.html#cb21-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb21-14"><a href="extended-function-example.html#cb21-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb21-15"><a href="extended-function-example.html#cb21-15" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb21-16"><a href="extended-function-example.html#cb21-16" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb21-17"><a href="extended-function-example.html#cb21-17" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb21-18"><a href="extended-function-example.html#cb21-18" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb21-19"><a href="extended-function-example.html#cb21-19" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb21-20"><a href="extended-function-example.html#cb21-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb21-21"><a href="extended-function-example.html#cb21-21" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb21-22"><a href="extended-function-example.html#cb21-22" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb21-23"><a href="extended-function-example.html#cb21-23" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb21-24"><a href="extended-function-example.html#cb21-24" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb21-25"><a href="extended-function-example.html#cb21-25" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb21-26"><a href="extended-function-example.html#cb21-26" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, </span>
<span id="cb21-27"><a href="extended-function-example.html#cb21-27" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb21-28"><a href="extended-function-example.html#cb21-28" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb21-29"><a href="extended-function-example.html#cb21-29" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb21-30"><a href="extended-function-example.html#cb21-30" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb21-31"><a href="extended-function-example.html#cb21-31" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb21-32"><a href="extended-function-example.html#cb21-32" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb21-33"><a href="extended-function-example.html#cb21-33" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb21-34"><a href="extended-function-example.html#cb21-34" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-35"><a href="extended-function-example.html#cb21-35" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb21-36"><a href="extended-function-example.html#cb21-36" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-37"><a href="extended-function-example.html#cb21-37" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-38"><a href="extended-function-example.html#cb21-38" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb21-39"><a href="extended-function-example.html#cb21-39" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-40"><a href="extended-function-example.html#cb21-40" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-41"><a href="extended-function-example.html#cb21-41" tabindex="-1"></a>      <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-42"><a href="extended-function-example.html#cb21-42" tabindex="-1"></a>      <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb21-43"><a href="extended-function-example.html#cb21-43" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-44"><a href="extended-function-example.html#cb21-44" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span></span>
<span id="cb21-45"><a href="extended-function-example.html#cb21-45" tabindex="-1"></a>                            <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb21-46"><a href="extended-function-example.html#cb21-46" tabindex="-1"></a>  )</span>
<span id="cb21-47"><a href="extended-function-example.html#cb21-47" tabindex="-1"></a>  </span>
<span id="cb21-48"><a href="extended-function-example.html#cb21-48" tabindex="-1"></a>  <span class="do">### Input Process</span></span>
<span id="cb21-49"><a href="extended-function-example.html#cb21-49" tabindex="-1"></a>  </span>
<span id="cb21-50"><a href="extended-function-example.html#cb21-50" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb21-51"><a href="extended-function-example.html#cb21-51" tabindex="-1"></a>  <span class="co"># Estimate survival probabilities</span></span>
<span id="cb21-52"><a href="extended-function-example.html#cb21-52" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb21-53"><a href="extended-function-example.html#cb21-53" tabindex="-1"></a>  </span>
<span id="cb21-54"><a href="extended-function-example.html#cb21-54" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb21-55"><a href="extended-function-example.html#cb21-55" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(predictions, bin.boundaries)</span>
<span id="cb21-56"><a href="extended-function-example.html#cb21-56" tabindex="-1"></a>  </span>
<span id="cb21-57"><a href="extended-function-example.html#cb21-57" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb21-58"><a href="extended-function-example.html#cb21-58" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb21-59"><a href="extended-function-example.html#cb21-59" tabindex="-1"></a>  result</span>
<span id="cb21-60"><a href="extended-function-example.html#cb21-60" tabindex="-1"></a>}</span>
<span id="cb21-61"><a href="extended-function-example.html#cb21-61" tabindex="-1"></a></span>
<span id="cb21-62"><a href="extended-function-example.html#cb21-62" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb21-63"><a href="extended-function-example.html#cb21-63" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb21-64"><a href="extended-function-example.html#cb21-64" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb21-65"><a href="extended-function-example.html#cb21-65" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb21-66"><a href="extended-function-example.html#cb21-66" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet` and their `stripped_*` counterparts.</span></span>
<span id="cb21-67"><a href="extended-function-example.html#cb21-67" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb21-68"><a href="extended-function-example.html#cb21-68" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb21-69"><a href="extended-function-example.html#cb21-69" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb21-70"><a href="extended-function-example.html#cb21-70" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb21-71"><a href="extended-function-example.html#cb21-71" tabindex="-1"></a><span class="co">#&#39; @returns Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb21-72"><a href="extended-function-example.html#cb21-72" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb21-73"><a href="extended-function-example.html#cb21-73" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb21-74"><a href="extended-function-example.html#cb21-74" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb21-75"><a href="extended-function-example.html#cb21-75" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb21-76"><a href="extended-function-example.html#cb21-76" tabindex="-1"></a>}</span>
<span id="cb21-77"><a href="extended-function-example.html#cb21-77" tabindex="-1"></a></span>
<span id="cb21-78"><a href="extended-function-example.html#cb21-78" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb21-79"><a href="extended-function-example.html#cb21-79" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb21-80"><a href="extended-function-example.html#cb21-80" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-81"><a href="extended-function-example.html#cb21-81" tabindex="-1"></a>}</span>
<span id="cb21-82"><a href="extended-function-example.html#cb21-82" tabindex="-1"></a></span>
<span id="cb21-83"><a href="extended-function-example.html#cb21-83" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb21-84"><a href="extended-function-example.html#cb21-84" tabindex="-1"></a></span>
<span id="cb21-85"><a href="extended-function-example.html#cb21-85" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb21-86"><a href="extended-function-example.html#cb21-86" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb21-87"><a href="extended-function-example.html#cb21-87" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb21-88"><a href="extended-function-example.html#cb21-88" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb21-89"><a href="extended-function-example.html#cb21-89" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb21-90"><a href="extended-function-example.html#cb21-90" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb21-91"><a href="extended-function-example.html#cb21-91" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb21-92"><a href="extended-function-example.html#cb21-92" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-93"><a href="extended-function-example.html#cb21-93" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb21-94"><a href="extended-function-example.html#cb21-94" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-95"><a href="extended-function-example.html#cb21-95" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-96"><a href="extended-function-example.html#cb21-96" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb21-97"><a href="extended-function-example.html#cb21-97" tabindex="-1"></a>  )</span>
<span id="cb21-98"><a href="extended-function-example.html#cb21-98" tabindex="-1"></a>  </span>
<span id="cb21-99"><a href="extended-function-example.html#cb21-99" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb21-100"><a href="extended-function-example.html#cb21-100" tabindex="-1"></a>  </span>
<span id="cb21-101"><a href="extended-function-example.html#cb21-101" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb21-102"><a href="extended-function-example.html#cb21-102" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb21-103"><a href="extended-function-example.html#cb21-103" tabindex="-1"></a>  </span>
<span id="cb21-104"><a href="extended-function-example.html#cb21-104" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb21-105"><a href="extended-function-example.html#cb21-105" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb21-106"><a href="extended-function-example.html#cb21-106" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb21-107"><a href="extended-function-example.html#cb21-107" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb21-108"><a href="extended-function-example.html#cb21-108" tabindex="-1"></a>  </span>
<span id="cb21-109"><a href="extended-function-example.html#cb21-109" tabindex="-1"></a>  base_hazard_at_t <span class="ot">&lt;-</span> base_hazard[t_idx, 1L]</span>
<span id="cb21-110"><a href="extended-function-example.html#cb21-110" tabindex="-1"></a>  </span>
<span id="cb21-111"><a href="extended-function-example.html#cb21-111" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb21-112"><a href="extended-function-example.html#cb21-112" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard_at_t) ) {</span>
<span id="cb21-113"><a href="extended-function-example.html#cb21-113" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard_at_t), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-114"><a href="extended-function-example.html#cb21-114" tabindex="-1"></a>  }</span>
<span id="cb21-115"><a href="extended-function-example.html#cb21-115" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb21-116"><a href="extended-function-example.html#cb21-116" tabindex="-1"></a></span>
<span id="cb21-117"><a href="extended-function-example.html#cb21-117" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb21-118"><a href="extended-function-example.html#cb21-118" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb21-119"><a href="extended-function-example.html#cb21-119" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-120"><a href="extended-function-example.html#cb21-120" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb21-121"><a href="extended-function-example.html#cb21-121" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-122"><a href="extended-function-example.html#cb21-122" tabindex="-1"></a>                               })</span>
<span id="cb21-123"><a href="extended-function-example.html#cb21-123" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb21-124"><a href="extended-function-example.html#cb21-124" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb21-125"><a href="extended-function-example.html#cb21-125" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb21-126"><a href="extended-function-example.html#cb21-126" tabindex="-1"></a>  </span>
<span id="cb21-127"><a href="extended-function-example.html#cb21-127" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb21-128"><a href="extended-function-example.html#cb21-128" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb21-129"><a href="extended-function-example.html#cb21-129" tabindex="-1"></a>  </span>
<span id="cb21-130"><a href="extended-function-example.html#cb21-130" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb21-131"><a href="extended-function-example.html#cb21-131" tabindex="-1"></a>  <span class="fu">unname</span>(result)</span>
<span id="cb21-132"><a href="extended-function-example.html#cb21-132" tabindex="-1"></a>}</span>
<span id="cb21-133"><a href="extended-function-example.html#cb21-133" tabindex="-1"></a></span>
<span id="cb21-134"><a href="extended-function-example.html#cb21-134" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb21-135"><a href="extended-function-example.html#cb21-135" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb21-136"><a href="extended-function-example.html#cb21-136" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb21-137"><a href="extended-function-example.html#cb21-137" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb21-138"><a href="extended-function-example.html#cb21-138" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, </span>
<span id="cb21-139"><a href="extended-function-example.html#cb21-139" tabindex="-1"></a>                                         lambda, ...) {</span>
<span id="cb21-140"><a href="extended-function-example.html#cb21-140" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb21-141"><a href="extended-function-example.html#cb21-141" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb21-142"><a href="extended-function-example.html#cb21-142" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-143"><a href="extended-function-example.html#cb21-143" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb21-144"><a href="extended-function-example.html#cb21-144" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-145"><a href="extended-function-example.html#cb21-145" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-146"><a href="extended-function-example.html#cb21-146" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb21-147"><a href="extended-function-example.html#cb21-147" tabindex="-1"></a>  )</span>
<span id="cb21-148"><a href="extended-function-example.html#cb21-148" tabindex="-1"></a>  </span>
<span id="cb21-149"><a href="extended-function-example.html#cb21-149" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb21-150"><a href="extended-function-example.html#cb21-150" tabindex="-1"></a>  </span>
<span id="cb21-151"><a href="extended-function-example.html#cb21-151" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb21-152"><a href="extended-function-example.html#cb21-152" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb21-153"><a href="extended-function-example.html#cb21-153" tabindex="-1"></a>  </span>
<span id="cb21-154"><a href="extended-function-example.html#cb21-154" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb21-155"><a href="extended-function-example.html#cb21-155" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-156"><a href="extended-function-example.html#cb21-156" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb21-157"><a href="extended-function-example.html#cb21-157" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-158"><a href="extended-function-example.html#cb21-158" tabindex="-1"></a>                               })</span>
<span id="cb21-159"><a href="extended-function-example.html#cb21-159" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb21-160"><a href="extended-function-example.html#cb21-160" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb21-161"><a href="extended-function-example.html#cb21-161" tabindex="-1"></a>                                   </span>
<span id="cb21-162"><a href="extended-function-example.html#cb21-162" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb21-163"><a href="extended-function-example.html#cb21-163" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb21-164"><a href="extended-function-example.html#cb21-164" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb21-165"><a href="extended-function-example.html#cb21-165" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb21-166"><a href="extended-function-example.html#cb21-166" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb21-167"><a href="extended-function-example.html#cb21-167" tabindex="-1"></a>  </span>
<span id="cb21-168"><a href="extended-function-example.html#cb21-168" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb21-169"><a href="extended-function-example.html#cb21-169" tabindex="-1"></a>  <span class="fu">unname</span>(result)</span>
<span id="cb21-170"><a href="extended-function-example.html#cb21-170" tabindex="-1"></a>}</span>
<span id="cb21-171"><a href="extended-function-example.html#cb21-171" tabindex="-1"></a></span>
<span id="cb21-172"><a href="extended-function-example.html#cb21-172" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb21-173"><a href="extended-function-example.html#cb21-173" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb21-174"><a href="extended-function-example.html#cb21-174" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb21-175"><a href="extended-function-example.html#cb21-175" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb21-176"><a href="extended-function-example.html#cb21-176" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb21-177"><a href="extended-function-example.html#cb21-177" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb21-178"><a href="extended-function-example.html#cb21-178" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-179"><a href="extended-function-example.html#cb21-179" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb21-180"><a href="extended-function-example.html#cb21-180" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-181"><a href="extended-function-example.html#cb21-181" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-182"><a href="extended-function-example.html#cb21-182" tabindex="-1"></a>      <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb21-183"><a href="extended-function-example.html#cb21-183" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb21-184"><a href="extended-function-example.html#cb21-184" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb21-185"><a href="extended-function-example.html#cb21-185" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb21-186"><a href="extended-function-example.html#cb21-186" tabindex="-1"></a>  )</span>
<span id="cb21-187"><a href="extended-function-example.html#cb21-187" tabindex="-1"></a>  </span>
<span id="cb21-188"><a href="extended-function-example.html#cb21-188" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb21-189"><a href="extended-function-example.html#cb21-189" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb21-190"><a href="extended-function-example.html#cb21-190" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb21-191"><a href="extended-function-example.html#cb21-191" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-192"><a href="extended-function-example.html#cb21-192" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb21-193"><a href="extended-function-example.html#cb21-193" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-194"><a href="extended-function-example.html#cb21-194" tabindex="-1"></a>                             })</span>
<span id="cb21-195"><a href="extended-function-example.html#cb21-195" tabindex="-1"></a>  </span>
<span id="cb21-196"><a href="extended-function-example.html#cb21-196" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(survreg_object, newdata, eval.time, ...)</span>
<span id="cb21-197"><a href="extended-function-example.html#cb21-197" tabindex="-1"></a>  </span>
<span id="cb21-198"><a href="extended-function-example.html#cb21-198" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb21-199"><a href="extended-function-example.html#cb21-199" tabindex="-1"></a>  result</span>
<span id="cb21-200"><a href="extended-function-example.html#cb21-200" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="extensions-1" class="section level3 hasAnchor" number="2.4.6">
<h3><span class="header-section-number">2.4.6</span> Extensions<a href="extended-function-example.html#extensions-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If it is decided that this tool would be handy if a user could instead provide a numeric vector of predicted survival probabilities rather than a fitted model, there are a few options available for this extension. First, the step of the main function responsible for predicting the survival probability could be wrapped in an <code>if/else</code> statement.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="extended-function-example.html#cb22-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb22-2"><a href="extended-function-example.html#cb22-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb22-3"><a href="extended-function-example.html#cb22-3" tabindex="-1"></a><span class="co">#&#39; Function takes a user provided vector of survival probabilities or obtains</span></span>
<span id="cb22-4"><a href="extended-function-example.html#cb22-4" tabindex="-1"></a><span class="co">#&#39;   predicted survival probabilities from a provided fitted model and new data</span></span>
<span id="cb22-5"><a href="extended-function-example.html#cb22-5" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb22-6"><a href="extended-function-example.html#cb22-6" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb22-7"><a href="extended-function-example.html#cb22-7" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb22-8"><a href="extended-function-example.html#cb22-8" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model or numeric vector. Survival models are </span></span>
<span id="cb22-9"><a href="extended-function-example.html#cb22-9" tabindex="-1"></a><span class="co">#&#39;   currently limited to classes `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb22-10"><a href="extended-function-example.html#cb22-10" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat, data.frame, or NULL. The model covariates, times, and</span></span>
<span id="cb22-11"><a href="extended-function-example.html#cb22-11" tabindex="-1"></a><span class="co">#&#39;   status data. If NULL, `object` must be a numeric vector.</span></span>
<span id="cb22-12"><a href="extended-function-example.html#cb22-12" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb22-13"><a href="extended-function-example.html#cb22-13" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb22-14"><a href="extended-function-example.html#cb22-14" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb22-15"><a href="extended-function-example.html#cb22-15" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb22-16"><a href="extended-function-example.html#cb22-16" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb22-17"><a href="extended-function-example.html#cb22-17" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored. If `object` is numeric, input is ignored.</span></span>
<span id="cb22-18"><a href="extended-function-example.html#cb22-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb22-19"><a href="extended-function-example.html#cb22-19" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb22-20"><a href="extended-function-example.html#cb22-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb22-21"><a href="extended-function-example.html#cb22-21" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb22-22"><a href="extended-function-example.html#cb22-22" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb22-23"><a href="extended-function-example.html#cb22-23" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb22-24"><a href="extended-function-example.html#cb22-24" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb22-25"><a href="extended-function-example.html#cb22-25" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb22-26"><a href="extended-function-example.html#cb22-26" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb22-27"><a href="extended-function-example.html#cb22-27" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, <span class="at">newdata =</span> <span class="cn">NULL</span>, eval.time, bin.boundaries, </span>
<span id="cb22-28"><a href="extended-function-example.html#cb22-28" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb22-29"><a href="extended-function-example.html#cb22-29" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb22-30"><a href="extended-function-example.html#cb22-30" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb22-31"><a href="extended-function-example.html#cb22-31" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb22-32"><a href="extended-function-example.html#cb22-32" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb22-33"><a href="extended-function-example.html#cb22-33" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `numeric`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb22-34"><a href="extended-function-example.html#cb22-34" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb22-35"><a href="extended-function-example.html#cb22-35" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb22-36"><a href="extended-function-example.html#cb22-36" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb22-37"><a href="extended-function-example.html#cb22-37" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb22-38"><a href="extended-function-example.html#cb22-38" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb22-39"><a href="extended-function-example.html#cb22-39" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb22-40"><a href="extended-function-example.html#cb22-40" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb22-41"><a href="extended-function-example.html#cb22-41" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb22-42"><a href="extended-function-example.html#cb22-42" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb22-43"><a href="extended-function-example.html#cb22-43" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb22-44"><a href="extended-function-example.html#cb22-44" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb22-45"><a href="extended-function-example.html#cb22-45" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span></span>
<span id="cb22-46"><a href="extended-function-example.html#cb22-46" tabindex="-1"></a>                            <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb22-47"><a href="extended-function-example.html#cb22-47" tabindex="-1"></a>  )</span>
<span id="cb22-48"><a href="extended-function-example.html#cb22-48" tabindex="-1"></a>  </span>
<span id="cb22-49"><a href="extended-function-example.html#cb22-49" tabindex="-1"></a>  <span class="do">### Input Process</span></span>
<span id="cb22-50"><a href="extended-function-example.html#cb22-50" tabindex="-1"></a>  </span>
<span id="cb22-51"><a href="extended-function-example.html#cb22-51" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb22-52"><a href="extended-function-example.html#cb22-52" tabindex="-1"></a>  <span class="co"># Estimate survival probabilities</span></span>
<span id="cb22-53"><a href="extended-function-example.html#cb22-53" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="fu">is.numeric</span>(object) ) {</span>
<span id="cb22-54"><a href="extended-function-example.html#cb22-54" tabindex="-1"></a>    <span class="cf">if</span> ( <span class="fu">is.vector</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(object) <span class="sc">!=</span> 0L ) {</span>
<span id="cb22-55"><a href="extended-function-example.html#cb22-55" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(object)</span>
<span id="cb22-56"><a href="extended-function-example.html#cb22-56" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-57"><a href="extended-function-example.html#cb22-57" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;`object` must be a non-empty numeric vector if predictions are provided&quot;</span>,</span>
<span id="cb22-58"><a href="extended-function-example.html#cb22-58" tabindex="-1"></a>           <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-59"><a href="extended-function-example.html#cb22-59" tabindex="-1"></a>    }</span>
<span id="cb22-60"><a href="extended-function-example.html#cb22-60" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb22-61"><a href="extended-function-example.html#cb22-61" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb22-62"><a href="extended-function-example.html#cb22-62" tabindex="-1"></a>  }</span>
<span id="cb22-63"><a href="extended-function-example.html#cb22-63" tabindex="-1"></a>  </span>
<span id="cb22-64"><a href="extended-function-example.html#cb22-64" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb22-65"><a href="extended-function-example.html#cb22-65" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(predictions, bin.boundaries)</span>
<span id="cb22-66"><a href="extended-function-example.html#cb22-66" tabindex="-1"></a>  </span>
<span id="cb22-67"><a href="extended-function-example.html#cb22-67" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb22-68"><a href="extended-function-example.html#cb22-68" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb22-69"><a href="extended-function-example.html#cb22-69" tabindex="-1"></a>  result</span>
<span id="cb22-70"><a href="extended-function-example.html#cb22-70" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that this extension required some modification to our usage statement (<code>newdata</code> can now be <code>NULL</code>) as well as additional options for the input testing of <code>object</code> and <code>newdata</code>. This choice may not be ideal as should the supported types for <code>object</code> be extended to other non-model type objects, additional layering of the <code>if/else</code> would be necessary, which can become cumbersome!</p>
<p>Another solution is to extend the prediction method. We still need to make some adjustments to the usage of the main function.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="extended-function-example.html#cb23-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb23-2"><a href="extended-function-example.html#cb23-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb23-3"><a href="extended-function-example.html#cb23-3" tabindex="-1"></a><span class="co">#&#39; Function takes a user provided vector of survival probabilities or obtains</span></span>
<span id="cb23-4"><a href="extended-function-example.html#cb23-4" tabindex="-1"></a><span class="co">#&#39;   predicted survival probabilities from a provided fitted model and new data</span></span>
<span id="cb23-5"><a href="extended-function-example.html#cb23-5" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb23-6"><a href="extended-function-example.html#cb23-6" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb23-7"><a href="extended-function-example.html#cb23-7" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb23-8"><a href="extended-function-example.html#cb23-8" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model or numeric vector. Survival models are </span></span>
<span id="cb23-9"><a href="extended-function-example.html#cb23-9" tabindex="-1"></a><span class="co">#&#39;   currently limited to classes `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb23-10"><a href="extended-function-example.html#cb23-10" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat, data.frame, or NULL. The model covariates, times, and</span></span>
<span id="cb23-11"><a href="extended-function-example.html#cb23-11" tabindex="-1"></a><span class="co">#&#39;   status data. If NULL, `object` must be a numeric vector.</span></span>
<span id="cb23-12"><a href="extended-function-example.html#cb23-12" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb23-13"><a href="extended-function-example.html#cb23-13" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb23-14"><a href="extended-function-example.html#cb23-14" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb23-15"><a href="extended-function-example.html#cb23-15" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb23-16"><a href="extended-function-example.html#cb23-16" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb23-17"><a href="extended-function-example.html#cb23-17" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored. If `object` is numeric, input is ignored.</span></span>
<span id="cb23-18"><a href="extended-function-example.html#cb23-18" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb23-19"><a href="extended-function-example.html#cb23-19" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb23-20"><a href="extended-function-example.html#cb23-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb23-21"><a href="extended-function-example.html#cb23-21" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb23-22"><a href="extended-function-example.html#cb23-22" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb23-23"><a href="extended-function-example.html#cb23-23" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb23-24"><a href="extended-function-example.html#cb23-24" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb23-25"><a href="extended-function-example.html#cb23-25" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb23-26"><a href="extended-function-example.html#cb23-26" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb23-27"><a href="extended-function-example.html#cb23-27" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, <span class="at">newdata =</span> <span class="cn">NULL</span>, eval.time, bin.boundaries, </span>
<span id="cb23-28"><a href="extended-function-example.html#cb23-28" tabindex="-1"></a>                         <span class="at">lambda =</span> <span class="cn">NULL</span>, ...) { </span>
<span id="cb23-29"><a href="extended-function-example.html#cb23-29" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb23-30"><a href="extended-function-example.html#cb23-30" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb23-31"><a href="extended-function-example.html#cb23-31" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb23-32"><a href="extended-function-example.html#cb23-32" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb23-33"><a href="extended-function-example.html#cb23-33" tabindex="-1"></a>    <span class="st">&quot;`object` must be inherit from `coxph`, `numeric`, `survreg`, or `survregnet`.&quot;</span> <span class="ot">=</span></span>
<span id="cb23-34"><a href="extended-function-example.html#cb23-34" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(object, <span class="fu">c</span>(<span class="st">&quot;coxph&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;survreg&quot;</span>, <span class="st">&quot;survregnet&quot;</span>)),</span>
<span id="cb23-35"><a href="extended-function-example.html#cb23-35" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb23-36"><a href="extended-function-example.html#cb23-36" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb23-37"><a href="extended-function-example.html#cb23-37" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb23-38"><a href="extended-function-example.html#cb23-38" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb23-39"><a href="extended-function-example.html#cb23-39" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb23-40"><a href="extended-function-example.html#cb23-40" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb23-41"><a href="extended-function-example.html#cb23-41" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb23-42"><a href="extended-function-example.html#cb23-42" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb23-43"><a href="extended-function-example.html#cb23-43" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>),</span>
<span id="cb23-44"><a href="extended-function-example.html#cb23-44" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb23-45"><a href="extended-function-example.html#cb23-45" tabindex="-1"></a>      <span class="fu">is.null</span>(lambda) <span class="sc">||</span> (<span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span></span>
<span id="cb23-46"><a href="extended-function-example.html#cb23-46" tabindex="-1"></a>                            <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span>)</span>
<span id="cb23-47"><a href="extended-function-example.html#cb23-47" tabindex="-1"></a>  )</span>
<span id="cb23-48"><a href="extended-function-example.html#cb23-48" tabindex="-1"></a>  </span>
<span id="cb23-49"><a href="extended-function-example.html#cb23-49" tabindex="-1"></a>  <span class="do">### Input Process</span></span>
<span id="cb23-50"><a href="extended-function-example.html#cb23-50" tabindex="-1"></a>  </span>
<span id="cb23-51"><a href="extended-function-example.html#cb23-51" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb23-52"><a href="extended-function-example.html#cb23-52" tabindex="-1"></a>  <span class="co"># Estimate survival probabilities</span></span>
<span id="cb23-53"><a href="extended-function-example.html#cb23-53" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb23-54"><a href="extended-function-example.html#cb23-54" tabindex="-1"></a></span>
<span id="cb23-55"><a href="extended-function-example.html#cb23-55" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb23-56"><a href="extended-function-example.html#cb23-56" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.binData</span>(predictions, bin.boundaries)</span>
<span id="cb23-57"><a href="extended-function-example.html#cb23-57" tabindex="-1"></a>  </span>
<span id="cb23-58"><a href="extended-function-example.html#cb23-58" tabindex="-1"></a>  <span class="do">### Result Construction and Testing</span></span>
<span id="cb23-59"><a href="extended-function-example.html#cb23-59" tabindex="-1"></a>  <span class="co"># No further manipulation of the result of .binData() is required</span></span>
<span id="cb23-60"><a href="extended-function-example.html#cb23-60" tabindex="-1"></a>  result</span>
<span id="cb23-61"><a href="extended-function-example.html#cb23-61" tabindex="-1"></a>}</span>
<span id="cb23-62"><a href="extended-function-example.html#cb23-62" tabindex="-1"></a></span>
<span id="cb23-63"><a href="extended-function-example.html#cb23-63" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb23-64"><a href="extended-function-example.html#cb23-64" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb23-65"><a href="extended-function-example.html#cb23-65" tabindex="-1"></a>.predictSurvivalProb.numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb23-66"><a href="extended-function-example.html#cb23-66" tabindex="-1"></a>  </span>
<span id="cb23-67"><a href="extended-function-example.html#cb23-67" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb23-68"><a href="extended-function-example.html#cb23-68" tabindex="-1"></a>    <span class="st">&quot;`object` must be a non-empty numeric vector if predictions are provided&quot;</span> <span class="ot">=</span></span>
<span id="cb23-69"><a href="extended-function-example.html#cb23-69" tabindex="-1"></a>      <span class="fu">is.vector</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(object) <span class="sc">!=</span> 0L</span>
<span id="cb23-70"><a href="extended-function-example.html#cb23-70" tabindex="-1"></a>  )</span>
<span id="cb23-71"><a href="extended-function-example.html#cb23-71" tabindex="-1"></a>  </span>
<span id="cb23-72"><a href="extended-function-example.html#cb23-72" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb23-73"><a href="extended-function-example.html#cb23-73" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(object)</span>
<span id="cb23-74"><a href="extended-function-example.html#cb23-74" tabindex="-1"></a>  </span>
<span id="cb23-75"><a href="extended-function-example.html#cb23-75" tabindex="-1"></a>  <span class="do">### Result construction and testing</span></span>
<span id="cb23-76"><a href="extended-function-example.html#cb23-76" tabindex="-1"></a>  result</span>
<span id="cb23-77"><a href="extended-function-example.html#cb23-77" tabindex="-1"></a>}</span></code></pre></div>
<p>This choice may seem odd given that one is not actually “predicting a survival function” but rather processing a provided prediction. Further, one must be careful that this extension of the prediction function does not have unintended consequences for other functions that might call <code>.predictSurvivalProb()</code>. However, if proper input testing is implemented in the downstream function, this is not a significant concern.</p>
</div>
</div>
<div id="key-design-differences" class="section level2 hasAnchor" number="2.5">
<h2><span class="header-section-number">2.5</span> Key Design Differences<a href="extended-function-example.html#key-design-differences" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>S3 Based Design
<ul>
<li>Pros
<ul>
<li><strong>Extension to new model types does not risk changes to existing functionality.</strong> <br>
To extend the tool to new model types, a developer need only create a new function <code>survProbBins.newType()</code>, which would need to execute the verification of input, obtain the predicted survival probabilities, and call the bin/tally method. There is little possibility that the added function will impact the execution of or results from the existing methods.</li>
<li><strong>Freedom in type-specific input arguments.</strong> <br>
Because each method <em>must</em> contain only the dispatching argument (in our example, <code>object</code>), each method can declare its own required inputs. In our example, the Elastic Net parameter <code>lambda</code>, is an input only for the Elastic Net model type.</li>
<li><strong>More familiar to our users.</strong> <br>
This is the primary design choice of the <code>somaverse</code> – our users are accustomed to its structure, which could make debugging for them easier.</li>
</ul></li>
<li>Cons
<ul>
<li><strong>Steps implemented within the individuals methods are not available to other functions.</strong> <br>
In our example, the prediction step is hidden within the <code>survProbBins.*()</code> functions, i.e., it is not returned as output so this predicted value cannot be accessed by a another function in the package. It is not unreasonable to imagine that a method to predict survival probabilities for a supported model would be useful elsewhere, but under the current design, it would need to be re-implemented. (More on this later.)</li>
<li><strong>Full coverage of unit tests can be difficult.</strong> <br>
If multiple steps of the procedure are implemented in each individual method, it can be challenging to get strong coverage in unit tests.</li>
<li><strong>Procedure evolution.</strong> <br>
In the absence of a single function specifying the steps required to complete the task, it is possible for subtle differences to arise in the procedure across model types.</li>
</ul></li>
</ul></li>
<li>Framework and Utility Functions Design
<ul>
<li>Pros
<ul>
<li><strong>Main function highlights the <em>structure</em> of the solution rather than the details required for each model type.</strong> <br>
This structure provides “sign posts” that can make developing unit tests easier and provides future developers the explicit steps expected to accomplish the task.</li>
<li><strong>Each step of the procedure can be individually unit tested.</strong> <br>
Each function can be robustly unit tested to ensure that it matches the developers expectations. A key aspect of this design is that utility functions should be developed such that very little is “hidden” from unit tests.</li>
<li><strong>All utility functions are available to all other functions in the package.</strong> <br>
In our example, <code>.predictProbSurv()</code> can be used elsewhere if needed without further development or testing.</li>
<li><strong>Extensions to utility functions become immediately available to other functions.</strong> <br>
This can expedite extending multiple methods to new model types.</li>
</ul></li>
<li>Cons
<ul>
<li><strong>Extension to new model types may require changes to existing functions.</strong> <br>
For utility steps that are implemented as functions, developers must ensure that new functionality does not impact previously written code.</li>
<li><strong>Extension to new model types may not be intuitive or might require cumbersome if/else structures.</strong> <br>
In our example we illustrated how to extend to a numeric vector of predictions. The utility function <code>.predictSurvalProb()</code> does not necessarily “make sense” when provided a vector of predictions.</li>
<li><strong>Bloated input structure.</strong> <br>
Because inputs are shared across all model types, we lose the freedom to add or remove inputs for each model type. For example, because we support Elastic Net models, <code>lambda</code> must be provided as an input no matter the model type (though <code>NULL</code> is a perfectly acceptable value for non-Elastic Net models). This restriction can introduce confusion for users that must be clearly addressed in the documentation. Further, adding extensions might requiring adding additional input arguments or modifying default values - all of which can have unexpected consequences downstream if not done carefully.</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="blended-design" class="section level2 hasAnchor" number="2.6">
<h2><span class="header-section-number">2.6</span> Blended Design<a href="extended-function-example.html#blended-design" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The implementations that we chose above were meant to highlight the key differences between these two general design choices. We can address some of the disadvantages of the each method by blending the two designs. Specifically, we can move the survival probability prediction and testing steps of the S3 based design to its own individual S3 utility method, as was implemented in the framework design.</p>
<ul>
<li>A generic method
<ul>
<li><code>survProbBins(object, ...)</code>.</li>
</ul></li>
<li>A default method
<ul>
<li><code>survProbBins.default(object, ...)</code>.
<ul>
<li>Generate error indicating that <code>object</code> is not supported</li>
</ul></li>
</ul></li>
<li>An extension method for <code>coxph</code> objects
<ul>
<li><code>survProbBins.coxph(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>.predictSurvivalProb()</code></li>
<li>Call <code>.binData()</code></li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survreg</code> objects
<ul>
<li><code>survProbBins.survreg(object, newdata, eval.time, bin.boundaries, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>.predictSurvivalProb()</code></li>
<li>Call <code>.binData()</code></li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survregnet</code> objects
<ul>
<li><code>survProbBins.survregnet(object, newdata, eval.time, bin.boundaries, lambda, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>.predictSurvivalProb()</code></li>
<li>Call <code>.binData()</code></li>
<li>Return <code>.binData()</code> value object</li>
</ul></li>
</ul></li>
<li>A utility method to predict survival probabilities
<ul>
<li>A generic method
<ul>
<li><code>.predictSurvivalProb(object, ...)</code>.</li>
</ul></li>
<li>A default method
<ul>
<li><code>.predictSurvivalProb(object, ...)</code>.
<ul>
<li>Generate error indicating that <code>object</code> is not supported</li>
</ul></li>
</ul></li>
<li>An extension method for <code>coxph</code> objects
<ul>
<li><code>.predictSurvivalProb(object, newdata, eval.time, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Call <code>.testProbabilities()</code></li>
<li>Return <code>.testProbabilities()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survreg</code> objects
<ul>
<li><code>.predictSurvivalProb(object, newdata, eval.time, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Predict survival probabilities</li>
<li>Call <code>.testProbabilities()</code></li>
<li>Return <code>.testProbabilities()</code> value object</li>
</ul></li>
</ul></li>
<li>An extension method for <code>survregnet</code> objects
<ul>
<li><code>.predictSurvivalProb(object, newdata, eval.time, lambda, ...)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Call <code>convert2Survreg()</code> to convert <code>object</code> to a <code>survreg</code> object</li>
<li>Call <code>.predictSurvivalProb.survreg()</code> using converted object.</li>
<li>Return <code>.predictSurvivalProb.survreg()</code> value object</li>
</ul></li>
</ul></li>
</ul></li>
<li>An internal function for binning and tallying a vector of values
<ul>
<li><code>.binData(values, bin.boundaries)</code>.
<ul>
<li>Test validity of inputs</li>
<li>Identify bin membership based on the provided probabilities</li>
<li>Tally the number of cases in each probability bin</li>
<li>Create a list containing the bin boundaries, bin membership, and totals</li>
<li>Return list</li>
</ul></li>
</ul></li>
<li>An internal function for testing validity of survival probabilities
<ul>
<li><code>.testProbabilities(predictions)</code>.
<ul>
<li>Ensure predicted probabilities are all finite and in [0,1]</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="extended-function-example.html#cb24-1" tabindex="-1"></a><span class="co">#&#39; Bin Predicted Survival Probabilities</span></span>
<span id="cb24-2"><a href="extended-function-example.html#cb24-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-3"><a href="extended-function-example.html#cb24-3" tabindex="-1"></a><span class="co">#&#39; Function uses a fitted model and new data to estimate survival probabilities</span></span>
<span id="cb24-4"><a href="extended-function-example.html#cb24-4" tabindex="-1"></a><span class="co">#&#39;   and returns a vector of bin membership and the total number of cases in</span></span>
<span id="cb24-5"><a href="extended-function-example.html#cb24-5" tabindex="-1"></a><span class="co">#&#39;   each user-specified probability bin.</span></span>
<span id="cb24-6"><a href="extended-function-example.html#cb24-6" tabindex="-1"></a><span class="co">#&#39;   </span></span>
<span id="cb24-7"><a href="extended-function-example.html#cb24-7" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb24-8"><a href="extended-function-example.html#cb24-8" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet`.</span></span>
<span id="cb24-9"><a href="extended-function-example.html#cb24-9" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb24-10"><a href="extended-function-example.html#cb24-10" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb24-11"><a href="extended-function-example.html#cb24-11" tabindex="-1"></a><span class="co">#&#39; @param eval.time Numeric. The time at which survival probabilities are to be</span></span>
<span id="cb24-12"><a href="extended-function-example.html#cb24-12" tabindex="-1"></a><span class="co">#&#39;   estimated.</span></span>
<span id="cb24-13"><a href="extended-function-example.html#cb24-13" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The k+1 boundaries of the k</span></span>
<span id="cb24-14"><a href="extended-function-example.html#cb24-14" tabindex="-1"></a><span class="co">#&#39;   survival probability bins.</span></span>
<span id="cb24-15"><a href="extended-function-example.html#cb24-15" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb24-16"><a href="extended-function-example.html#cb24-16" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb24-17"><a href="extended-function-example.html#cb24-17" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-18"><a href="extended-function-example.html#cb24-18" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb24-19"><a href="extended-function-example.html#cb24-19" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb24-20"><a href="extended-function-example.html#cb24-20" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb24-21"><a href="extended-function-example.html#cb24-21" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb24-22"><a href="extended-function-example.html#cb24-22" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb24-23"><a href="extended-function-example.html#cb24-23" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb24-24"><a href="extended-function-example.html#cb24-24" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-25"><a href="extended-function-example.html#cb24-25" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-26"><a href="extended-function-example.html#cb24-26" tabindex="-1"></a>survProbBins <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { <span class="fu">UseMethod</span>(<span class="st">&quot;survProbBins&quot;</span>) }</span>
<span id="cb24-27"><a href="extended-function-example.html#cb24-27" tabindex="-1"></a></span>
<span id="cb24-28"><a href="extended-function-example.html#cb24-28" tabindex="-1"></a><span class="co">#&#39; S3 default method -- error only</span></span>
<span id="cb24-29"><a href="extended-function-example.html#cb24-29" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-30"><a href="extended-function-example.html#cb24-30" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-31"><a href="extended-function-example.html#cb24-31" tabindex="-1"></a>survProbBins.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb24-32"><a href="extended-function-example.html#cb24-32" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`survProbBins()` does not yet support objects of class &quot;</span>,</span>
<span id="cb24-33"><a href="extended-function-example.html#cb24-33" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-34"><a href="extended-function-example.html#cb24-34" tabindex="-1"></a>}</span>
<span id="cb24-35"><a href="extended-function-example.html#cb24-35" tabindex="-1"></a></span>
<span id="cb24-36"><a href="extended-function-example.html#cb24-36" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb24-37"><a href="extended-function-example.html#cb24-37" tabindex="-1"></a></span>
<span id="cb24-38"><a href="extended-function-example.html#cb24-38" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::coxph()`</span></span>
<span id="cb24-39"><a href="extended-function-example.html#cb24-39" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-40"><a href="extended-function-example.html#cb24-40" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-41"><a href="extended-function-example.html#cb24-41" tabindex="-1"></a>survProbBins.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries, ...) {</span>
<span id="cb24-42"><a href="extended-function-example.html#cb24-42" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-43"><a href="extended-function-example.html#cb24-43" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb24-44"><a href="extended-function-example.html#cb24-44" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb24-45"><a href="extended-function-example.html#cb24-45" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-46"><a href="extended-function-example.html#cb24-46" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-47"><a href="extended-function-example.html#cb24-47" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb24-48"><a href="extended-function-example.html#cb24-48" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-49"><a href="extended-function-example.html#cb24-49" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-50"><a href="extended-function-example.html#cb24-50" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb24-51"><a href="extended-function-example.html#cb24-51" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-52"><a href="extended-function-example.html#cb24-52" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-53"><a href="extended-function-example.html#cb24-53" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-54"><a href="extended-function-example.html#cb24-54" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb24-55"><a href="extended-function-example.html#cb24-55" tabindex="-1"></a>  )</span>
<span id="cb24-56"><a href="extended-function-example.html#cb24-56" tabindex="-1"></a>  </span>
<span id="cb24-57"><a href="extended-function-example.html#cb24-57" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-58"><a href="extended-function-example.html#cb24-58" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb24-59"><a href="extended-function-example.html#cb24-59" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, ...)</span>
<span id="cb24-60"><a href="extended-function-example.html#cb24-60" tabindex="-1"></a>  </span>
<span id="cb24-61"><a href="extended-function-example.html#cb24-61" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-62"><a href="extended-function-example.html#cb24-62" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb24-63"><a href="extended-function-example.html#cb24-63" tabindex="-1"></a>  <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb24-64"><a href="extended-function-example.html#cb24-64" tabindex="-1"></a>}</span>
<span id="cb24-65"><a href="extended-function-example.html#cb24-65" tabindex="-1"></a></span>
<span id="cb24-66"><a href="extended-function-example.html#cb24-66" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `survival::survreg`</span></span>
<span id="cb24-67"><a href="extended-function-example.html#cb24-67" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-68"><a href="extended-function-example.html#cb24-68" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-69"><a href="extended-function-example.html#cb24-69" tabindex="-1"></a>survProbBins.survreg <span class="ot">&lt;-</span> survProbBins.coxph</span>
<span id="cb24-70"><a href="extended-function-example.html#cb24-70" tabindex="-1"></a></span>
<span id="cb24-71"><a href="extended-function-example.html#cb24-71" tabindex="-1"></a><span class="co">#&#39; S3 method for objects returned by `SomaSurvival::fitSurvregnet`</span></span>
<span id="cb24-72"><a href="extended-function-example.html#cb24-72" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-73"><a href="extended-function-example.html#cb24-73" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-74"><a href="extended-function-example.html#cb24-74" tabindex="-1"></a>survProbBins.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, bin.boundaries,</span>
<span id="cb24-75"><a href="extended-function-example.html#cb24-75" tabindex="-1"></a>                                    lambda, ...) {</span>
<span id="cb24-76"><a href="extended-function-example.html#cb24-76" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-77"><a href="extended-function-example.html#cb24-77" tabindex="-1"></a>  <span class="co"># We forego testing for appropriate covariates in `newdata`, which will</span></span>
<span id="cb24-78"><a href="extended-function-example.html#cb24-78" tabindex="-1"></a>  <span class="co">#   be inherent in the procedure used to obtain predictions</span></span>
<span id="cb24-79"><a href="extended-function-example.html#cb24-79" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-80"><a href="extended-function-example.html#cb24-80" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-81"><a href="extended-function-example.html#cb24-81" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb24-82"><a href="extended-function-example.html#cb24-82" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-83"><a href="extended-function-example.html#cb24-83" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-84"><a href="extended-function-example.html#cb24-84" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb24-85"><a href="extended-function-example.html#cb24-85" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-86"><a href="extended-function-example.html#cb24-86" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-87"><a href="extended-function-example.html#cb24-87" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-88"><a href="extended-function-example.html#cb24-88" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb24-89"><a href="extended-function-example.html#cb24-89" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a non-negative scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-90"><a href="extended-function-example.html#cb24-90" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-91"><a href="extended-function-example.html#cb24-91" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb24-92"><a href="extended-function-example.html#cb24-92" tabindex="-1"></a>  )</span>
<span id="cb24-93"><a href="extended-function-example.html#cb24-93" tabindex="-1"></a>  </span>
<span id="cb24-94"><a href="extended-function-example.html#cb24-94" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-95"><a href="extended-function-example.html#cb24-95" tabindex="-1"></a>  <span class="co"># Predict survival probabilities</span></span>
<span id="cb24-96"><a href="extended-function-example.html#cb24-96" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.predictSurvivalProb</span>(object, newdata, <span class="at">lambda =</span> lambda, ...)</span>
<span id="cb24-97"><a href="extended-function-example.html#cb24-97" tabindex="-1"></a>  </span>
<span id="cb24-98"><a href="extended-function-example.html#cb24-98" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-99"><a href="extended-function-example.html#cb24-99" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb24-100"><a href="extended-function-example.html#cb24-100" tabindex="-1"></a>  <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb24-101"><a href="extended-function-example.html#cb24-101" tabindex="-1"></a>}</span>
<span id="cb24-102"><a href="extended-function-example.html#cb24-102" tabindex="-1"></a></span>
<span id="cb24-103"><a href="extended-function-example.html#cb24-103" tabindex="-1"></a><span class="co">#&#39; Internal S3 Method for Estimating the Survival Probabilities</span></span>
<span id="cb24-104"><a href="extended-function-example.html#cb24-104" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-105"><a href="extended-function-example.html#cb24-105" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-106"><a href="extended-function-example.html#cb24-106" tabindex="-1"></a><span class="co">#&#39; @param object Fitted survival model. Currently limited to classes</span></span>
<span id="cb24-107"><a href="extended-function-example.html#cb24-107" tabindex="-1"></a><span class="co">#&#39;   `coxph`, `survreg`, and `survregnet` and their `stripped_*` counterparts.</span></span>
<span id="cb24-108"><a href="extended-function-example.html#cb24-108" tabindex="-1"></a><span class="co">#&#39; @param newdata soma_adat or data.frame. The model covariates, times, and</span></span>
<span id="cb24-109"><a href="extended-function-example.html#cb24-109" tabindex="-1"></a><span class="co">#&#39;   status data.</span></span>
<span id="cb24-110"><a href="extended-function-example.html#cb24-110" tabindex="-1"></a><span class="co">#&#39; @param ... Optional arguments passed to the `predict.*` method. Note that</span></span>
<span id="cb24-111"><a href="extended-function-example.html#cb24-111" tabindex="-1"></a><span class="co">#&#39;   input `type` will be ignored.</span></span>
<span id="cb24-112"><a href="extended-function-example.html#cb24-112" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-113"><a href="extended-function-example.html#cb24-113" tabindex="-1"></a><span class="co">#&#39; @returns Numeric. The estimated survival probabilities with invalid or out of</span></span>
<span id="cb24-114"><a href="extended-function-example.html#cb24-114" tabindex="-1"></a><span class="co">#&#39;   range values reset to NA_real_.</span></span>
<span id="cb24-115"><a href="extended-function-example.html#cb24-115" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb24-116"><a href="extended-function-example.html#cb24-116" tabindex="-1"></a>.predictSurvivalProb <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) { </span>
<span id="cb24-117"><a href="extended-function-example.html#cb24-117" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;.predictSurvivalProb&quot;</span>) </span>
<span id="cb24-118"><a href="extended-function-example.html#cb24-118" tabindex="-1"></a>}</span>
<span id="cb24-119"><a href="extended-function-example.html#cb24-119" tabindex="-1"></a></span>
<span id="cb24-120"><a href="extended-function-example.html#cb24-120" tabindex="-1"></a>.predictSurvivalProb.default <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb24-121"><a href="extended-function-example.html#cb24-121" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;`.predictSurvivalProb()` does not yet support objects of class &quot;</span>,</span>
<span id="cb24-122"><a href="extended-function-example.html#cb24-122" tabindex="-1"></a>       <span class="fu">value</span>(<span class="fu">class</span>(object))[1L], <span class="st">&quot;.&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-123"><a href="extended-function-example.html#cb24-123" tabindex="-1"></a>}</span>
<span id="cb24-124"><a href="extended-function-example.html#cb24-124" tabindex="-1"></a></span>
<span id="cb24-125"><a href="extended-function-example.html#cb24-125" tabindex="-1"></a><span class="do">### Individual methods for each of the classes we must support</span></span>
<span id="cb24-126"><a href="extended-function-example.html#cb24-126" tabindex="-1"></a></span>
<span id="cb24-127"><a href="extended-function-example.html#cb24-127" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-128"><a href="extended-function-example.html#cb24-128" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-129"><a href="extended-function-example.html#cb24-129" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb24-130"><a href="extended-function-example.html#cb24-130" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb24-131"><a href="extended-function-example.html#cb24-131" tabindex="-1"></a>.predictSurvivalProb.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, lambda, ...) {</span>
<span id="cb24-132"><a href="extended-function-example.html#cb24-132" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-133"><a href="extended-function-example.html#cb24-133" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-134"><a href="extended-function-example.html#cb24-134" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-135"><a href="extended-function-example.html#cb24-135" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb24-136"><a href="extended-function-example.html#cb24-136" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-137"><a href="extended-function-example.html#cb24-137" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-138"><a href="extended-function-example.html#cb24-138" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb24-139"><a href="extended-function-example.html#cb24-139" tabindex="-1"></a>  )</span>
<span id="cb24-140"><a href="extended-function-example.html#cb24-140" tabindex="-1"></a>  </span>
<span id="cb24-141"><a href="extended-function-example.html#cb24-141" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-142"><a href="extended-function-example.html#cb24-142" tabindex="-1"></a>  </span>
<span id="cb24-143"><a href="extended-function-example.html#cb24-143" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-144"><a href="extended-function-example.html#cb24-144" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb24-145"><a href="extended-function-example.html#cb24-145" tabindex="-1"></a>  </span>
<span id="cb24-146"><a href="extended-function-example.html#cb24-146" tabindex="-1"></a>  <span class="co"># retrieve baseline hazard</span></span>
<span id="cb24-147"><a href="extended-function-example.html#cb24-147" tabindex="-1"></a>  base_hazard <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">basehaz</span>(object)</span>
<span id="cb24-148"><a href="extended-function-example.html#cb24-148" tabindex="-1"></a>  <span class="co"># identify time-point in baseline hazard nearest the specified evaluation time</span></span>
<span id="cb24-149"><a href="extended-function-example.html#cb24-149" tabindex="-1"></a>  t_idx       <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(eval.time <span class="sc">-</span> base_hazard[, 2L]))</span>
<span id="cb24-150"><a href="extended-function-example.html#cb24-150" tabindex="-1"></a>  </span>
<span id="cb24-151"><a href="extended-function-example.html#cb24-151" tabindex="-1"></a>  <span class="co"># ensure that baseline hazard is a valid value (not NA, NaN, Inf)</span></span>
<span id="cb24-152"><a href="extended-function-example.html#cb24-152" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.finite</span>(base_hazard[t_idx, 1L]) ) {</span>
<span id="cb24-153"><a href="extended-function-example.html#cb24-153" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid baseline hazard &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 1L]), <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-154"><a href="extended-function-example.html#cb24-154" tabindex="-1"></a>  }</span>
<span id="cb24-155"><a href="extended-function-example.html#cb24-155" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Survival probability evaluated at t = &quot;</span>, <span class="fu">value</span>(base_hazard[t_idx, 2L]))</span>
<span id="cb24-156"><a href="extended-function-example.html#cb24-156" tabindex="-1"></a></span>
<span id="cb24-157"><a href="extended-function-example.html#cb24-157" tabindex="-1"></a>  <span class="co"># get linear predictors for newdata</span></span>
<span id="cb24-158"><a href="extended-function-example.html#cb24-158" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb24-159"><a href="extended-function-example.html#cb24-159" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb24-160"><a href="extended-function-example.html#cb24-160" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb24-161"><a href="extended-function-example.html#cb24-161" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-162"><a href="extended-function-example.html#cb24-162" tabindex="-1"></a>                               })</span>
<span id="cb24-163"><a href="extended-function-example.html#cb24-163" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb24-164"><a href="extended-function-example.html#cb24-164" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb24-165"><a href="extended-function-example.html#cb24-165" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>base_hazard_at_t <span class="sc">*</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb24-166"><a href="extended-function-example.html#cb24-166" tabindex="-1"></a>  </span>
<span id="cb24-167"><a href="extended-function-example.html#cb24-167" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb24-168"><a href="extended-function-example.html#cb24-168" tabindex="-1"></a>  <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb24-169"><a href="extended-function-example.html#cb24-169" tabindex="-1"></a>}</span>
<span id="cb24-170"><a href="extended-function-example.html#cb24-170" tabindex="-1"></a></span>
<span id="cb24-171"><a href="extended-function-example.html#cb24-171" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-172"><a href="extended-function-example.html#cb24-172" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-173"><a href="extended-function-example.html#cb24-173" tabindex="-1"></a><span class="co">#&#39; Note including lambda as an input here eliminates it from being passed to</span></span>
<span id="cb24-174"><a href="extended-function-example.html#cb24-174" tabindex="-1"></a><span class="co">#&#39;   the prediction method through the ellipsis</span></span>
<span id="cb24-175"><a href="extended-function-example.html#cb24-175" tabindex="-1"></a>.predictSurvivalProb.survreg <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, eval.time, </span>
<span id="cb24-176"><a href="extended-function-example.html#cb24-176" tabindex="-1"></a>                                         lambda, ...) {</span>
<span id="cb24-177"><a href="extended-function-example.html#cb24-177" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-178"><a href="extended-function-example.html#cb24-178" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-179"><a href="extended-function-example.html#cb24-179" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-180"><a href="extended-function-example.html#cb24-180" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb24-181"><a href="extended-function-example.html#cb24-181" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-182"><a href="extended-function-example.html#cb24-182" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-183"><a href="extended-function-example.html#cb24-183" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span></span>
<span id="cb24-184"><a href="extended-function-example.html#cb24-184" tabindex="-1"></a>  )</span>
<span id="cb24-185"><a href="extended-function-example.html#cb24-185" tabindex="-1"></a>  </span>
<span id="cb24-186"><a href="extended-function-example.html#cb24-186" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-187"><a href="extended-function-example.html#cb24-187" tabindex="-1"></a>  </span>
<span id="cb24-188"><a href="extended-function-example.html#cb24-188" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-189"><a href="extended-function-example.html#cb24-189" tabindex="-1"></a>  <span class="do">## Predict survival probabilities</span></span>
<span id="cb24-190"><a href="extended-function-example.html#cb24-190" tabindex="-1"></a>  </span>
<span id="cb24-191"><a href="extended-function-example.html#cb24-191" tabindex="-1"></a>  lin_predictors <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">predict</span>(object, newdata, <span class="at">type =</span> <span class="st">&quot;lp&quot;</span>, ...),</span>
<span id="cb24-192"><a href="extended-function-example.html#cb24-192" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb24-193"><a href="extended-function-example.html#cb24-193" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to obtain linear predictors.&quot;</span>,</span>
<span id="cb24-194"><a href="extended-function-example.html#cb24-194" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-195"><a href="extended-function-example.html#cb24-195" tabindex="-1"></a>                               })</span>
<span id="cb24-196"><a href="extended-function-example.html#cb24-196" tabindex="-1"></a>  <span class="co"># do not need to verify linear predictors, this will be done in the</span></span>
<span id="cb24-197"><a href="extended-function-example.html#cb24-197" tabindex="-1"></a>  <span class="co"># .testProbabilities() function</span></span>
<span id="cb24-198"><a href="extended-function-example.html#cb24-198" tabindex="-1"></a>                                   </span>
<span id="cb24-199"><a href="extended-function-example.html#cb24-199" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pweibull</span>(eval.time,</span>
<span id="cb24-200"><a href="extended-function-example.html#cb24-200" tabindex="-1"></a>                                              <span class="at">shape =</span> <span class="fl">1.0</span> <span class="sc">/</span> <span class="fu">exp</span>(object<span class="sc">$</span>scale),</span>
<span id="cb24-201"><a href="extended-function-example.html#cb24-201" tabindex="-1"></a>                                              <span class="at">scale =</span> <span class="fu">exp</span>(lin_predictors))</span>
<span id="cb24-202"><a href="extended-function-example.html#cb24-202" tabindex="-1"></a>  <span class="co"># Ensure valid predictions</span></span>
<span id="cb24-203"><a href="extended-function-example.html#cb24-203" tabindex="-1"></a>  <span class="fu">.testProbabilities</span>(surv_probabilities)</span>
<span id="cb24-204"><a href="extended-function-example.html#cb24-204" tabindex="-1"></a>}</span>
<span id="cb24-205"><a href="extended-function-example.html#cb24-205" tabindex="-1"></a></span>
<span id="cb24-206"><a href="extended-function-example.html#cb24-206" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-207"><a href="extended-function-example.html#cb24-207" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb24-208"><a href="extended-function-example.html#cb24-208" tabindex="-1"></a>.predictSurvivalProb.survregnet <span class="ot">&lt;-</span> <span class="cf">function</span>(object, newdata, </span>
<span id="cb24-209"><a href="extended-function-example.html#cb24-209" tabindex="-1"></a>                                            eval.time, lambda, ...) {</span>
<span id="cb24-210"><a href="extended-function-example.html#cb24-210" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-211"><a href="extended-function-example.html#cb24-211" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-212"><a href="extended-function-example.html#cb24-212" tabindex="-1"></a>    <span class="st">&quot;`newdata` must be a data.frame or soma_adat.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-213"><a href="extended-function-example.html#cb24-213" tabindex="-1"></a>      <span class="sc">!</span>missing <span class="sc">&amp;&amp;</span> (<span class="fu">is.data.frame</span>(newdata) <span class="sc">||</span> <span class="fu">is.soma_adat</span>(newdata)),</span>
<span id="cb24-214"><a href="extended-function-example.html#cb24-214" tabindex="-1"></a>    <span class="st">&quot;`eval.time` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-215"><a href="extended-function-example.html#cb24-215" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(eval.time) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-216"><a href="extended-function-example.html#cb24-216" tabindex="-1"></a>        <span class="fu">is.vector</span>(eval.time) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(eval.time) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> eval.time <span class="sc">&gt;</span> <span class="fl">0.0</span>,</span>
<span id="cb24-217"><a href="extended-function-example.html#cb24-217" tabindex="-1"></a>    <span class="st">&quot;`lambda` must be a positive scalar.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-218"><a href="extended-function-example.html#cb24-218" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(lambda) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-219"><a href="extended-function-example.html#cb24-219" tabindex="-1"></a>      <span class="fu">length</span>(lambda) <span class="sc">==</span> 1L <span class="sc">&amp;&amp;</span> lambda <span class="sc">&gt;=</span> <span class="fl">0.0</span></span>
<span id="cb24-220"><a href="extended-function-example.html#cb24-220" tabindex="-1"></a>  )</span>
<span id="cb24-221"><a href="extended-function-example.html#cb24-221" tabindex="-1"></a>  </span>
<span id="cb24-222"><a href="extended-function-example.html#cb24-222" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-223"><a href="extended-function-example.html#cb24-223" tabindex="-1"></a>  <span class="co"># Convert to survreg object and use survreg method</span></span>
<span id="cb24-224"><a href="extended-function-example.html#cb24-224" tabindex="-1"></a>  survreg_object <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(SomaSurvival<span class="sc">::</span><span class="fu">convert2Survreg</span>(object, lambda),</span>
<span id="cb24-225"><a href="extended-function-example.html#cb24-225" tabindex="-1"></a>                             <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb24-226"><a href="extended-function-example.html#cb24-226" tabindex="-1"></a>                               <span class="fu">stop</span>(<span class="st">&quot;Unable to convert `object` to `survreg`.</span><span class="sc">\n\t</span><span class="st">&quot;</span>,</span>
<span id="cb24-227"><a href="extended-function-example.html#cb24-227" tabindex="-1"></a>                                    e<span class="sc">$</span>message, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-228"><a href="extended-function-example.html#cb24-228" tabindex="-1"></a>                             })</span>
<span id="cb24-229"><a href="extended-function-example.html#cb24-229" tabindex="-1"></a>  </span>
<span id="cb24-230"><a href="extended-function-example.html#cb24-230" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-231"><a href="extended-function-example.html#cb24-231" tabindex="-1"></a>  <span class="fu">.predictSurvivalProb</span>(survreg_object, newdata, eval.time, ...)</span>
<span id="cb24-232"><a href="extended-function-example.html#cb24-232" tabindex="-1"></a>}</span>
<span id="cb24-233"><a href="extended-function-example.html#cb24-233" tabindex="-1"></a></span>
<span id="cb24-234"><a href="extended-function-example.html#cb24-234" tabindex="-1"></a><span class="co">#&#39; Internal function to test that probabilities are valid</span></span>
<span id="cb24-235"><a href="extended-function-example.html#cb24-235" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-236"><a href="extended-function-example.html#cb24-236" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-237"><a href="extended-function-example.html#cb24-237" tabindex="-1"></a><span class="co">#&#39; @param predictions Numeric. The probabilities to test.</span></span>
<span id="cb24-238"><a href="extended-function-example.html#cb24-238" tabindex="-1"></a><span class="co">#&#39; @return Numeric. The probabilities with invalid values reset to NA_real_</span></span>
<span id="cb24-239"><a href="extended-function-example.html#cb24-239" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb24-240"><a href="extended-function-example.html#cb24-240" tabindex="-1"></a>.testProbabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions) {</span>
<span id="cb24-241"><a href="extended-function-example.html#cb24-241" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-242"><a href="extended-function-example.html#cb24-242" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-243"><a href="extended-function-example.html#cb24-243" tabindex="-1"></a>    <span class="st">&quot;`predictions` must be numeric.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-244"><a href="extended-function-example.html#cb24-244" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(predictions) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-245"><a href="extended-function-example.html#cb24-245" tabindex="-1"></a>      <span class="fu">is.vector</span>(predictions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(predictions) <span class="sc">!=</span> 0L</span>
<span id="cb24-246"><a href="extended-function-example.html#cb24-246" tabindex="-1"></a>  )</span>
<span id="cb24-247"><a href="extended-function-example.html#cb24-247" tabindex="-1"></a>  </span>
<span id="cb24-248"><a href="extended-function-example.html#cb24-248" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-249"><a href="extended-function-example.html#cb24-249" tabindex="-1"></a>  </span>
<span id="cb24-250"><a href="extended-function-example.html#cb24-250" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-251"><a href="extended-function-example.html#cb24-251" tabindex="-1"></a>  <span class="co"># convert non-finite (NA, NaN, Inf) values to NA_real_</span></span>
<span id="cb24-252"><a href="extended-function-example.html#cb24-252" tabindex="-1"></a>  <span class="co"># convert values outside of [0, 1] to NA_real_</span></span>
<span id="cb24-253"><a href="extended-function-example.html#cb24-253" tabindex="-1"></a>  bad_values <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.finite</span>(predictions) <span class="sc">|</span> predictions <span class="sc">&lt;</span> <span class="fl">0.0</span> <span class="sc">|</span> predictions <span class="sc">&gt;</span> <span class="fl">1.0</span></span>
<span id="cb24-254"><a href="extended-function-example.html#cb24-254" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="fu">any</span>(bad_values) ) {</span>
<span id="cb24-255"><a href="extended-function-example.html#cb24-255" tabindex="-1"></a>    predictions[bad_values] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb24-256"><a href="extended-function-example.html#cb24-256" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">value</span>(<span class="fu">sum</span>(bad_value)), <span class="st">&quot; invalid probabilities have been set as NA.&quot;</span>)</span>
<span id="cb24-257"><a href="extended-function-example.html#cb24-257" tabindex="-1"></a>  }</span>
<span id="cb24-258"><a href="extended-function-example.html#cb24-258" tabindex="-1"></a>  </span>
<span id="cb24-259"><a href="extended-function-example.html#cb24-259" tabindex="-1"></a>  predictions</span>
<span id="cb24-260"><a href="extended-function-example.html#cb24-260" tabindex="-1"></a>}</span>
<span id="cb24-261"><a href="extended-function-example.html#cb24-261" tabindex="-1"></a></span>
<span id="cb24-262"><a href="extended-function-example.html#cb24-262" tabindex="-1"></a><span class="co">#&#39; Internal function to perform binning</span></span>
<span id="cb24-263"><a href="extended-function-example.html#cb24-263" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-264"><a href="extended-function-example.html#cb24-264" tabindex="-1"></a><span class="co">#&#39; Provided a vector of values and a vector of bin boundaries, identify the </span></span>
<span id="cb24-265"><a href="extended-function-example.html#cb24-265" tabindex="-1"></a><span class="co">#&#39;   bin in which each value falls and the total number of values in each bin.</span></span>
<span id="cb24-266"><a href="extended-function-example.html#cb24-266" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-267"><a href="extended-function-example.html#cb24-267" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb24-268"><a href="extended-function-example.html#cb24-268" tabindex="-1"></a><span class="co">#&#39; @param values A numeric or numeric vector. The values to bin and tally.</span></span>
<span id="cb24-269"><a href="extended-function-example.html#cb24-269" tabindex="-1"></a><span class="co">#&#39; @param bin.boundaries Numeric vector. The K+1 boundaries of K bins.</span></span>
<span id="cb24-270"><a href="extended-function-example.html#cb24-270" tabindex="-1"></a><span class="co">#&#39; @return A list containing</span></span>
<span id="cb24-271"><a href="extended-function-example.html#cb24-271" tabindex="-1"></a><span class="co">#&#39; \item{bin.boundaries}{A numeric vector. The provided probability bins.}</span></span>
<span id="cb24-272"><a href="extended-function-example.html#cb24-272" tabindex="-1"></a><span class="co">#&#39; \item{bin.id}{An integer vector of the probability bin to which each case in </span></span>
<span id="cb24-273"><a href="extended-function-example.html#cb24-273" tabindex="-1"></a><span class="co">#&#39;   `newdata` is assigned.}</span></span>
<span id="cb24-274"><a href="extended-function-example.html#cb24-274" tabindex="-1"></a><span class="co">#&#39; \item{totals}{A numeric vector of the total number of cases in each </span></span>
<span id="cb24-275"><a href="extended-function-example.html#cb24-275" tabindex="-1"></a><span class="co">#&#39;   probability bin.}</span></span>
<span id="cb24-276"><a href="extended-function-example.html#cb24-276" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb24-277"><a href="extended-function-example.html#cb24-277" tabindex="-1"></a><span class="co">#&#39; @keywords internal</span></span>
<span id="cb24-278"><a href="extended-function-example.html#cb24-278" tabindex="-1"></a>.binData <span class="ot">&lt;-</span> <span class="cf">function</span>(values, bin.boundaries) {</span>
<span id="cb24-279"><a href="extended-function-example.html#cb24-279" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb24-280"><a href="extended-function-example.html#cb24-280" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb24-281"><a href="extended-function-example.html#cb24-281" tabindex="-1"></a>    <span class="st">&quot;`values` must be a non-empty, numeric vector.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-282"><a href="extended-function-example.html#cb24-282" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(values) <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(values) <span class="sc">&amp;&amp;</span></span>
<span id="cb24-283"><a href="extended-function-example.html#cb24-283" tabindex="-1"></a>        <span class="fu">length</span>(values) <span class="sc">!=</span> 0L,</span>
<span id="cb24-284"><a href="extended-function-example.html#cb24-284" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector of length &gt; 1.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-285"><a href="extended-function-example.html#cb24-285" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-286"><a href="extended-function-example.html#cb24-286" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> <span class="fu">is.vector</span>(bin.boundaries),</span>
<span id="cb24-287"><a href="extended-function-example.html#cb24-287" tabindex="-1"></a>    <span class="st">&quot;All values in `bin.boundaries` must be unique.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-288"><a href="extended-function-example.html#cb24-288" tabindex="-1"></a>      <span class="fu">length</span>(bin.boundaries) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(bin.boundaries)),</span>
<span id="cb24-289"><a href="extended-function-example.html#cb24-289" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` cannot contain NA or NaN values.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-290"><a href="extended-function-example.html#cb24-290" tabindex="-1"></a>      <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.nan</span>(bin.boundaries)),</span>
<span id="cb24-291"><a href="extended-function-example.html#cb24-291" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be in increasing order.&quot;</span> <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.unsorted</span>(bin.boundaries),</span>
<span id="cb24-292"><a href="extended-function-example.html#cb24-292" tabindex="-1"></a>    <span class="st">&quot;`values` must be finite and in range of `bin.boundaries`.&quot;</span> <span class="ot">=</span> </span>
<span id="cb24-293"><a href="extended-function-example.html#cb24-293" tabindex="-1"></a>      <span class="fu">all</span>(<span class="fu">is.finite</span>(values)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(values <span class="sc">&gt;=</span> <span class="fu">min</span>(bin.boundaries)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb24-294"><a href="extended-function-example.html#cb24-294" tabindex="-1"></a>      <span class="fu">all</span>(values <span class="sc">&lt;=</span> <span class="fu">max</span>(bin.boundaries))</span>
<span id="cb24-295"><a href="extended-function-example.html#cb24-295" tabindex="-1"></a>  )</span>
<span id="cb24-296"><a href="extended-function-example.html#cb24-296" tabindex="-1"></a>  </span>
<span id="cb24-297"><a href="extended-function-example.html#cb24-297" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb24-298"><a href="extended-function-example.html#cb24-298" tabindex="-1"></a>  </span>
<span id="cb24-299"><a href="extended-function-example.html#cb24-299" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb24-300"><a href="extended-function-example.html#cb24-300" tabindex="-1"></a>  <span class="co"># Identify bin membership based on the provided probabilities</span></span>
<span id="cb24-301"><a href="extended-function-example.html#cb24-301" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(values, bin.boundaries, <span class="at">all.inside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-302"><a href="extended-function-example.html#cb24-302" tabindex="-1"></a>  </span>
<span id="cb24-303"><a href="extended-function-example.html#cb24-303" tabindex="-1"></a>  <span class="co"># Tally the number of cases in each probability bin</span></span>
<span id="cb24-304"><a href="extended-function-example.html#cb24-304" tabindex="-1"></a>  totals <span class="ot">&lt;-</span> <span class="fu">tabulate</span>(bins)</span>
<span id="cb24-305"><a href="extended-function-example.html#cb24-305" tabindex="-1"></a>  <span class="fu">names</span>(totals) <span class="ot">&lt;-</span> 1L<span class="sc">:</span>(<span class="fu">length</span>(bins)<span class="sc">-</span>1L)</span>
<span id="cb24-306"><a href="extended-function-example.html#cb24-306" tabindex="-1"></a>  </span>
<span id="cb24-307"><a href="extended-function-example.html#cb24-307" tabindex="-1"></a>  <span class="co"># Return a list of the results</span></span>
<span id="cb24-308"><a href="extended-function-example.html#cb24-308" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">&quot;bin.boundaries&quot;</span> <span class="ot">=</span> bin.boundaries, </span>
<span id="cb24-309"><a href="extended-function-example.html#cb24-309" tabindex="-1"></a>       <span class="st">&quot;bin.id&quot;</span>         <span class="ot">=</span> bins, </span>
<span id="cb24-310"><a href="extended-function-example.html#cb24-310" tabindex="-1"></a>       <span class="st">&quot;totals&quot;</span>         <span class="ot">=</span> totals)</span>
<span id="cb24-311"><a href="extended-function-example.html#cb24-311" tabindex="-1"></a>}</span></code></pre></div>
<p>In this blended design, the estimation and testing of the survival probabilities is now available to the broader package; the input structure is not bloated for non-Elastic Net methods; and we can avoid duplication of code when the procedure for models are identical (as for <code>coxph</code> and <code>survreg</code>). Further, the tools can be extended to other non-model types, such as a numeric vector of predictions without modification of the tool’s usage statement.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="extended-function-example.html#cb25-1" tabindex="-1"></a><span class="co">#&#39; S3 method for numeric vector objects</span></span>
<span id="cb25-2"><a href="extended-function-example.html#cb25-2" tabindex="-1"></a><span class="co">#&#39; @noRd</span></span>
<span id="cb25-3"><a href="extended-function-example.html#cb25-3" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb25-4"><a href="extended-function-example.html#cb25-4" tabindex="-1"></a>survProbBins.numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(object, bin.boundaries, ...) {</span>
<span id="cb25-5"><a href="extended-function-example.html#cb25-5" tabindex="-1"></a>  <span class="do">### Input Testing</span></span>
<span id="cb25-6"><a href="extended-function-example.html#cb25-6" tabindex="-1"></a>  <span class="fu">stopifnot</span>(</span>
<span id="cb25-7"><a href="extended-function-example.html#cb25-7" tabindex="-1"></a>    <span class="st">&quot;`object` must be a non-empty numeric vector if predictions are provided.&quot;</span> <span class="ot">=</span></span>
<span id="cb25-8"><a href="extended-function-example.html#cb25-8" tabindex="-1"></a>      <span class="fu">is.vector</span>(object) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(object) <span class="sc">!=</span> 0L,</span>
<span id="cb25-9"><a href="extended-function-example.html#cb25-9" tabindex="-1"></a>    <span class="st">&quot;`bin.boundaries` must be a numeric vector in [0, 1].&quot;</span> <span class="ot">=</span> </span>
<span id="cb25-10"><a href="extended-function-example.html#cb25-10" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">missing</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> </span>
<span id="cb25-11"><a href="extended-function-example.html#cb25-11" tabindex="-1"></a>        <span class="fu">is.vector</span>(bin.boundaries) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bin.boundaries) <span class="sc">&gt;</span> 1L <span class="sc">&amp;&amp;</span> </span>
<span id="cb25-12"><a href="extended-function-example.html#cb25-12" tabindex="-1"></a>        <span class="fu">all</span>(bin.boundaries <span class="sc">&gt;=</span> <span class="fl">0.0</span>) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(bin.boundaries <span class="sc">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="cb25-13"><a href="extended-function-example.html#cb25-13" tabindex="-1"></a>  )</span>
<span id="cb25-14"><a href="extended-function-example.html#cb25-14" tabindex="-1"></a>  </span>
<span id="cb25-15"><a href="extended-function-example.html#cb25-15" tabindex="-1"></a>  <span class="do">### Input Processing</span></span>
<span id="cb25-16"><a href="extended-function-example.html#cb25-16" tabindex="-1"></a>  surv_probabilities <span class="ot">&lt;-</span> <span class="fu">.testProbabilities</span>(object)</span>
<span id="cb25-17"><a href="extended-function-example.html#cb25-17" tabindex="-1"></a>  </span>
<span id="cb25-18"><a href="extended-function-example.html#cb25-18" tabindex="-1"></a>  <span class="do">### Task Implementation</span></span>
<span id="cb25-19"><a href="extended-function-example.html#cb25-19" tabindex="-1"></a>  <span class="co"># Bin and tally predicted probabilities</span></span>
<span id="cb25-20"><a href="extended-function-example.html#cb25-20" tabindex="-1"></a>  <span class="fu">.binData</span>(surv_probabilities, bin.boundaries)</span>
<span id="cb25-21"><a href="extended-function-example.html#cb25-21" tabindex="-1"></a>}</span></code></pre></div>
<p>Some disadvantages of this design are that both the tool and the survival probability functions must be extended when new model types become available and the “procedure” can be obfuscated as it is implemented within each individual S3 extension of the tool. As future developers extend our tool, the procedure may subtly evolve away from our original intention. However, overall this blended approach presents the best of both worlds with fewer drawbacks.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Functions.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="unit-testing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["Code_Development.pdf", "Code_Development.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
